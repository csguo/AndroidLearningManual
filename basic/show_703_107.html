
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML xmlns="http://www.w3.org/1999/xhtml">
<HEAD>
<TITLE>Android的生成日志文件_Android学习手册</TITLE>
<META content="text/html; charset=gb2312" http-equiv=Content-Type><LINK  rel=stylesheet type=text/css href="../css/c5.css">
<META name=GENERATOR content="MSHTML 8.00.6001.18702">
<meta name="Description" content=Android基础 Android组件 Android用户界面 Android设备功能 Android数据存储 Android网络应用 Android游戏开发 Android多媒体 Android源码开发 Android高级进阶 Android面试题/>
<meta name="Keywords" content="android 学习手册">

</HEAD>
<BODY id=homesecond class=serverscripting>
<DIV id=wrapper>
<DIV id=header><h1><a href="../index.html">Android学习手册</a></h1> 
</DIV>

<DIV id=navfirst>
<div id="indexGuide"><UL><li class="navcurrentLink"><A href="index.html">Android基础</A> </li><li ><A href="../component/index.html">Android组件</A> </li><li ><A href="../userinterface/index.html">用户界面</A> </li><li ><A href="../device/index.html">设备功能</A> </li><li ><A href="../datastorage/index.html">数据存储</A> </li><li ><A href="../network/index.html">网络应用</A> </li><li ><A href="../game/index.html">游戏开发</A> </li><li ><A href="../multimedia/index.html">多媒体</A> </li><li ><A href="../source/index.html">源码开发</A> </li><li ><A href="../advance/index.html">高级进阶</A> </li><li ><A href="../interview/index.html">Android面试题</A> </li></UL></div>
</DIV>
<DIV id=navsecond>
<DIV id=course>
<div id="kcTitle">课 程 表</div>


  <h2><A title="开发基础" href="index_100.html">开发基础</A></h2>

  <h2><A title="开发环境搭建" href="index_101.html">开发环境搭建</A></h2>

  <h2><A title="模拟器" href="index_102.html">模拟器</A></h2>

  <h2><A title="Resource" href="index_103.html">Resource</A></h2>

  <h2><A title="Manifest" href="index_104.html">Manifest</A></h2>

  <h2><A title="ADB" href="index_105.html">ADB</A></h2>

  <h2><A title="DDMS" href="index_106.html">DDMS</A></h2>

  <h2><A title="Logcat(日志)" href="index_107.html">Logcat(日志)</A></h2>
<UL><li ><A title=Log图文详解(Log.v,Log.d,Log.i,Log.w,Log.e) href="show_701_107.html">Log图文详解(Log.v,Log.d,Log.i,Log.w,Log.e)</A> </li><li ><A title=Android的LogCat的使用 href="show_702_107.html">Android的LogCat的使用</A> </li><li class="currentLink"><A title=Android的生成日志文件 href="show_703_107.html">Android的生成日志文件</A> </li></UL>
  <h2><A title="打包" href="index_108.html">打包</A></h2>

  <h2><A title="文件处理" href="index_109.html">文件处理</A></h2>

  <h2><A title="底层基础" href="index_111.html">底层基础</A></h2>

</DIV></DIV>
<DIV id=maincontent>
<DIV id=w3school>
<H1></H1>
<P><STRONG></STRONG></P></DIV>

<DIV>
<H2>Android的生成日志文件</H2>
<div style="line-height:20px; font-size:14px;"><p>在调试的时候一般都是在logcat中看日志的信息，以便找出BUG和调试信息，但是如果在真机上的话不可能一直连接电脑查看日志，所以生成日志文件并保存，是一个比较普遍的需求，下面就是最近实现的一个例子。欢迎大家讨论并给出别的思路。</p><p><pre><font class="keyword">import </font>java.io.BufferedReader;</p><p><font class="keyword">import </font>java.io.File;</p><p><font class="keyword">import </font>java.io.FileInputStream;</p><p><font class="keyword">import </font>java.io.FileOutputStream;</p><p><font class="keyword">import </font>java.io.IOException;</p><p><font class="keyword">import </font>java.io.InputStream;</p><p><font class="keyword">import </font>java.io.InputStreamReader;</p><p><font class="keyword">import </font>java.io.OutputStreamWriter;</p><p><font class="keyword">import </font>java.text.ParseException;</p><p><font class="keyword">import </font>java.text.SimpleDateFormat;</p><p><font class="keyword">import </font>java.util.ArrayList;</p><p><font class="keyword">import </font>java.util.Arrays;</p><p><font class="keyword">import </font>java.util.Calendar;</p><p><font class="keyword">import </font>java.util.Comparator;</p><p><font class="keyword">import </font>java.util.Date;</p><p><font class="keyword">import </font>java.util.List;</p><p></p><p><font class="keyword">import </font>android.app.AlarmManager;</p><p><font class="keyword">import </font>android.app.PendingIntent;</p><p><font class="keyword">import </font>android.app.Service;</p><p><font class="keyword">import </font>android.content.BroadcastReceiver;</p><p><font class="keyword">import </font>android.content.Context;</p><p><font class="keyword">import </font>android.content.Intent;</p><p><font class="keyword">import </font>android.content.IntentFilter;</p><p><font class="keyword">import </font>android.os.Environment;</p><p><font class="keyword">import </font>android.os.IBinder;</p><p><font class="keyword">import </font>android.os.PowerManager;</p><p><font class="keyword">import </font>android.os.PowerManager.WakeLock;</p><p><font class="keyword">import </font>android.util.Log;</p><p></p><p><font class="Comments">/**</font></p><p> <font class="Comments">* 日志服务，日志默认会存储在SDcar里如果没有SDcard会存储在内存中的安装目录下面。 1.本服务默认在SDcard中每天生成一个日志文件,</font></p><p> <font class="Comments">* 2.如果有SDCard的话会将之前内存中的文件拷贝到SDCard中 3.如果没有SDCard，在安装目录下只保存当前在写日志</font></p><p> <font class="Comments">* 4.SDcard的装载卸载动作会在步骤2,3中切换 5.SDcard中的日志文件只保存7天</font></p><p> <font class="Comments">* </font></p><p> <font class="Comments">* @author Administrator</font></p><p> <font class="Comments">* </font></p><p> <font class="Comments">*/</font></p><p><font class="keyword">public </font><font class="keyword">class </font>LogService </font><font class="keyword">extends </font>Service {</p><p>	<font class="keyword">private </font><font class="keyword">static </font><font class="keyword">final </font>String TAG = <font class="Fields">"LogService"</font>;</p><p></p><p>	<font class="keyword">private </font><font class="keyword">static </font><font class="keyword">final </font><font class="keyword">int </font>MEMORY_LOG_FILE_MAX_SIZE = 10 * 1024 * 1024; <font class="Comments">// 内存中日志文件最大值，10M</font></p><p>	<font class="keyword">private </font><font class="keyword">static </font><font class="keyword">final </font><font class="keyword">int </font>MEMORY_LOG_FILE_MONITOR_INTERVAL = 10 * 60 * 1000; <font class="Comments">// 内存中的日志文件大小监控时间间隔，10分钟</font></p><p>	<font class="keyword">private </font><font class="keyword">static </font><font class="keyword">final </font><font class="keyword">int </font>SDCARD_LOG_FILE_SAVE_DAYS = 7; <font class="Comments">// sd卡中日志文件的最多保存天数</font></p><p></p><p>	<font class="keyword">private </font>String LOG_PATH_MEMORY_DIR; <font class="Comments">// 日志文件在内存中的路径(日志文件在安装目录中的路径)</font></p><p>	<font class="keyword">private </font>String LOG_PATH_SDCARD_DIR; <font class="Comments">// 日志文件在sdcard中的路径</font></p><p>	</font>@SuppressWarnings(<font class="Fields">"unused"</font>)</p><p>	<font class="keyword">private </font>String LOG_SERVICE_LOG_PATH; <font class="Comments">// 本服务产生的日志，记录日志服务开启失败信息</font></p><p></p><p>	<font class="keyword">private </font><font class="keyword">final </font><font class="keyword">int </font>SDCARD_TYPE = 0; <font class="Comments">// 当前的日志记录类型为存储在SD卡下面</font></p><p>	<font class="keyword">private </font><font class="keyword">final </font><font class="keyword">int </font>MEMORY_TYPE = 1; <font class="Comments">// 当前的日志记录类型为存储在内存中</font></p><p>	<font class="keyword">private </font><font class="keyword">int </font>CURR_LOG_TYPE = SDCARD_TYPE; <font class="Comments">// 当前的日志记录类型</font></p><p></p><p>	<font class="keyword">private </font>String CURR_INSTALL_LOG_NAME; <font class="Comments">// 如果当前的日志写在内存中，记录当前的日志文件名称</font></p><p></p><p>	<font class="keyword">private </font>String logServiceLogName = <font class="Fields">"Log.log"</font>;<font class="Comments">// 本服务输出的日志文件名称</font></p><p>	<font class="keyword">private </font>SimpleDateFormat myLogSdf = </font><font class="keyword">new </font>SimpleDateFormat(</p><p>			<font class="Fields">"yyyy-MM-dd HH:mm:ss"</font>);</p><p>	<font class="keyword">private </font>OutputStreamWriter writer;</p><p></p><p>	<font class="keyword">private </font>SimpleDateFormat sdf = </font><font class="keyword">new </font>SimpleDateFormat(<font class="Fields">"yyyy-MM-dd HHmmss"</font>);<font class="Comments">// 日志名称格式</font></p><p></p><p>	<font class="keyword">private </font>Process process;</p><p></p><p>	<font class="keyword">private </font>WakeLock wakeLock;</p><p></p><p>	<font class="keyword">private </font>SDStateMonitorReceiver sdStateReceiver; <font class="Comments">// SDcard状态监测</font></p><p>	<font class="keyword">private </font>LogTaskReceiver logTaskReceiver;</p><p></p><p>	/*</p><p>	 <font class="Comments">* 是否正在监测日志文件大小； 如果当前日志记录在SDcard中则为false 如果当前日志记录在内存中则为true</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">private </font><font class="keyword">boolean </font>logSizeMoniting = </font><font class="keyword">false</font>;</p><p></p><p>	<font class="keyword">private </font><font class="keyword">static </font>String MONITOR_LOG_SIZE_ACTION = <font class="Fields">"MONITOR_LOG_SIZE"</font>; <font class="Comments">// 日志文件监测action</font></p><p>	<font class="keyword">private </font><font class="keyword">static </font>String SWITCH_LOG_FILE_ACTION = <font class="Fields">"SWITCH_LOG_FILE_ACTION"</font>; <font class="Comments">// 切换日志文件action</font></p><p></p><p>	@Override</p><p>	<font class="keyword">public </font>IBinder onBind(Intent intent) {</p><p>		<font class="keyword">return </font><font class="keyword">null</font>;</p><p>	}</p><p></p><p>	@Override</p><p>	<font class="keyword">public </font><font class="keyword">void </font>onCreate() {</p><p>		<font class="keyword">super</font>.onCreate();</p><p>		init();</p><p>		register();</p><p>		deploySwitchLogFileTask();</p><p>		<font class="keyword">new </font>LogCollectorThread().start();</p><p>	}</p><p></p><p>	<font class="keyword">private </font><font class="keyword">void </font>init() {</p><p>		LOG_PATH_MEMORY_DIR = getFilesDir().getAbsolutePath() + File.separator</p><p>				</font>+ <font class="Fields">"log"</font>;</p><p>		LOG_SERVICE_LOG_PATH = LOG_PATH_MEMORY_DIR + File.separator</p><p>				+ logServiceLogName;</p><p>		LOG_PATH_SDCARD_DIR = Environment.getExternalStorageDirectory()</p><p>				.getAbsolutePath()</p><p>				+ File.separator</p><p>				</font>+ <font class="Fields">"MyApp</p><p>				+ File.separator</p><p>				</font>+ <font class="Fields">"log"</font>;</p><p>		createLogDir();</p><p></p><p>		/* ******************************************************</p><p>		 <font class="Comments">* try { writer = new OutputStreamWriter(new FileOutputStream(</font></p><p>		 <font class="Comments">* LOG_SERVICE_LOG_PATH, true)); } catch (FileNotFoundException e) {</font></p><p>		 <font class="Comments">* Log.e(TAG, e.getMessage(), e); }</font></p><p>		 <font class="Comments">* <font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*</font></p><p>		 <font class="Comments">*/</font></p><p>		PowerManager pm = (PowerManager) getApplicationContext()</p><p>				.getSystemService(Context.POWER_SERVICE);</p><p>		wakeLock = pm.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK, TAG);</p><p></p><p>		CURR_LOG_TYPE = getCurrLogType();</p><p>		</font>Log.i(TAG, <font class="Fields">"LogService onCreate"</font>);</p><p>	}</p><p></p><p>	<font class="keyword">private </font><font class="keyword">void </font>register() {</p><p>		</font>IntentFilter sdCarMonitorFilter = <font class="keyword">new </font>IntentFilter();</p><p>		sdCarMonitorFilter.addAction(Intent.ACTION_MEDIA_MOUNTED);</p><p>		sdCarMonitorFilter.addAction(Intent.ACTION_MEDIA_UNMOUNTED);</p><p>		</font>sdCarMonitorFilter.addDataScheme(<font class="Fields">"file"</font>);</p><p>		</font>sdStateReceiver = <font class="keyword">new </font>SDStateMonitorReceiver();</p><p>		registerReceiver(sdStateReceiver, sdCarMonitorFilter);</p><p></p><p>		</font>IntentFilter logTaskFilter = <font class="keyword">new </font>IntentFilter();</p><p>		logTaskFilter.addAction(MONITOR_LOG_SIZE_ACTION);</p><p>		logTaskFilter.addAction(SWITCH_LOG_FILE_ACTION);</p><p>		</font>logTaskReceiver = <font class="keyword">new </font>LogTaskReceiver();</p><p>		registerReceiver(logTaskReceiver, logTaskFilter);</p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 获取当前应存储在内存中还是存储在SDCard中</font></p><p>	 <font class="Comments">* </font></p><p>	 <font class="Comments">* @return</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">public </font><font class="keyword">int </font>getCurrLogType() {</p><p>		<font class="keyword">if </font>(!Environment.getExternalStorageState().equals(</p><p>				Environment.MEDIA_MOUNTED)) {</p><p>			<font class="keyword">return </font>MEMORY_TYPE;</p><p>		</font>} <font class="keyword">else </font>{</p><p>			<font class="keyword">return </font>SDCARD_TYPE;</p><p>		}</p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 部署日志切换任务，每天凌晨切换日志文件</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">private </font><font class="keyword">void </font>deploySwitchLogFileTask() {</p><p>		</font>Intent intent = <font class="keyword">new </font>Intent(SWITCH_LOG_FILE_ACTION);</p><p>		</font>PendingIntent sender = PendingIntent.getBroadcast(<font class="keyword">this</font>, 0, intent, 0);</p><p>		Calendar calendar = Calendar.getInstance();</p><p>		calendar.add(Calendar.DAY_OF_MONTH, 1);</p><p>		calendar.set(Calendar.HOUR_OF_DAY, 0);</p><p>		calendar.set(Calendar.MINUTE, 0);</p><p>		calendar.set(Calendar.SECOND, 0);</p><p></p><p>		<font class="Comments">// 部署任务</font></p><p>		AlarmManager am = (AlarmManager) getSystemService(ALARM_SERVICE);</p><p>		am.setRepeating(AlarmManager.RTC_WAKEUP, calendar.getTimeInMillis(),</p><p>				AlarmManager.INTERVAL_DAY, sender);</p><p>		</font>recordLogServiceLog(<font class="Fields">"deployNextTask succ,next task time is:</p><p>				+ myLogSdf.format(calendar.getTime()));</p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 日志收集 1.清除日志缓存 2.杀死应用程序已开启的Logcat进程防止多个进程写入一个日志文件 3.开启日志收集进程 4.处理日志文件 移动</font></p><p>	 <font class="Comments">* OR 删除</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">class </font>LogCollectorThread </font><font class="keyword">extends </font>Thread {</p><p></p><p>		<font class="keyword">public </font>LogCollectorThread() {</p><p>			<font class="keyword">super</font>(<font class="Fields">"LogCollectorThread"</font>);</p><p>			</font>Log.d(TAG, <font class="Fields">"LogCollectorThread is create"</font>);</p><p>		}</p><p></p><p>		@Override</p><p>		<font class="keyword">public </font><font class="keyword">void </font>run() {</p><p>			<font class="keyword">try </font>{</p><p>				wakeLock.acquire(); <font class="Comments">// 唤醒手机</font></p><p></p><p>				clearLogCache();</p><p></p><p>				List&lt;String&gt; orgProcessList = getAllProcess();</p><p>				List&lt;ProcessInfo&gt; processInfoList = getProcessInfoList(orgProcessList);</p><p>				killLogcatProc(processInfoList);</p><p></p><p>				createLogCollector();</p><p></p><p>				Thread.sleep(1000);<font class="Comments">// 休眠，创建文件，然后处理文件，不然该文件还没创建，会影响文件删除</font></p><p></p><p>				handleLog();</p><p></p><p>				wakeLock.release(); <font class="Comments">// 释放</font></p><p>			</font>} <font class="keyword">catch </font>(Exception e) {</p><p>				e.printStackTrace();</p><p>				recordLogServiceLog(Log.getStackTraceString(e));</p><p>			}</p><p>		}</p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 每次记录日志之前先清除日志的缓存, 不然会在两个日志文件中记录重复的日志</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">private </font><font class="keyword">void </font>clearLogCache() {</p><p>		</font>Process proc = <font class="keyword">null</font>;</p><p>		</font>List&lt;String&gt; commandList = <font class="keyword">new </font>ArrayList&lt;String&gt;();</p><p>		</font>commandList.add(<font class="Fields">"logcat"</font>);</p><p>		</font>commandList.add(<font class="Fields">"-c"</font>);</p><p>		<font class="keyword">try </font>{</p><p>			proc = Runtime.getRuntime().exec(</p><p>					</font>commandList.toArray(<font class="keyword">new </font>String[commandList.size()]));</p><p>			</font>StreamConsumer errorGobbler = <font class="keyword">new </font>StreamConsumer(</p><p>					proc.getErrorStream());</p><p></p><p>			</font>StreamConsumer outputGobbler = <font class="keyword">new </font>StreamConsumer(</p><p>					proc.getInputStream());</p><p></p><p>			errorGobbler.start();</p><p>			outputGobbler.start();</p><p>			<font class="keyword">if </font>(proc.waitFor() != 0) {</p><p>				</font>Log.e(TAG, <font class="Fields">" clearLogCache proc.waitFor() != 0"</font>);</p><p>				</font>recordLogServiceLog(<font class="Fields">"clearLogCache clearLogCache proc.waitFor() != 0"</font>);</p><p>			}</p><p>		</font>} <font class="keyword">catch </font>(Exception e) {</p><p>			</font>Log.e(TAG, <font class="Fields">"clearLogCache failed"</font>, e);</p><p>			</font>recordLogServiceLog(<font class="Fields">"clearLogCache failed"</font>);</p><p>		} finally {</p><p>			<font class="keyword">try </font>{</p><p>				proc.destroy();</p><p>			</font>} <font class="keyword">catch </font>(Exception e) {</p><p>				</font>Log.e(TAG, <font class="Fields">"clearLogCache failed"</font>, e);</p><p>				</font>recordLogServiceLog(<font class="Fields">"clearLogCache failed"</font>);</p><p>			}</p><p>		}</p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 关闭由本程序开启的logcat进程： 根据用户名称杀死进程(如果是本程序进程开启的Logcat收集进程那么两者的USER一致)</font></p><p>	 <font class="Comments">* 如果不关闭会有多个进程读取logcat日志缓存信息写入日志文件</font></p><p>	 <font class="Comments">* </font></p><p>	 <font class="Comments">* @param allProcList</font></p><p>	 <font class="Comments">* @return</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">private </font><font class="keyword">void </font>killLogcatProc(List&lt;ProcessInfo&gt; allProcList) {</p><p>		<font class="keyword">if </font>(process != </font><font class="keyword">null</font>) {</p><p>			process.destroy();</p><p>		}</p><p>		</font>String packName = <font class="keyword">this</font>.getPackageName();</p><p>		String myUser = getAppUser(packName, allProcList);</p><p>		/*</p><p>		 <font class="Comments">* recordLogServiceLog("app user is:"+myUser);</font></p><p>		 <font class="Comments">* recordLogServiceLog("========================"); for (ProcessInfo</font></p><p>		 <font class="Comments">* processInfo : allProcList) {</font></p><p>		 <font class="Comments">* recordLogServiceLog(processInfo.toString()); }</font></p><p>		 <font class="Comments">* recordLogServiceLog("========================");</font></p><p>		 <font class="Comments">*/</font></p><p>		<font class="keyword">for </font>(ProcessInfo processInfo : allProcList) {</p><p>			<font class="keyword">if </font>(processInfo.name.toLowerCase().equals(<font class="Fields">"logcat"</font>)</p><p>					&& processInfo.user.equals(myUser)) {</p><p>				android.os.Process.killProcess(Integer</p><p>						.parseInt(processInfo.pid));</p><p>				<font class="Comments">// recordLogServiceLog("kill another logcat process success,the process info is:"</font></p><p>				<font class="Comments">// + processInfo);</font></p><p>			}</p><p>		}</p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 获取本程序的用户名称</font></p><p>	 <font class="Comments">* </font></p><p>	 <font class="Comments">* @param packName</font></p><p>	 <font class="Comments">* @param allProcList</font></p><p>	 <font class="Comments">* @return</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">private </font>String getAppUser(String packName, List&lt;ProcessInfo&gt; allProcList) {</p><p>		<font class="keyword">for </font>(ProcessInfo processInfo : allProcList) {</p><p>			<font class="keyword">if </font>(processInfo.name.equals(packName)) {</p><p>				<font class="keyword">return </font>processInfo.user;</p><p>			}</p><p>		}</p><p>		<font class="keyword">return </font><font class="keyword">null</font>;</p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 根据ps命令得到的内容获取PID，User，name等信息</font></p><p>	 <font class="Comments">* </font></p><p>	 <font class="Comments">* @param orgProcessList</font></p><p>	 <font class="Comments">* @return</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">private </font>List&lt;ProcessInfo&gt; getProcessInfoList(List&lt;String&gt; orgProcessList) {</p><p>		</font>List&lt;ProcessInfo&gt; procInfoList = <font class="keyword">new </font>ArrayList&lt;ProcessInfo&gt;();</p><p>		<font class="keyword">for </font>(</font><font class="keyword">int </font>i = 1; i &lt; orgProcessList.size(); i++) {</p><p>			String processInfo = orgProcessList.get(i);</p><p>			</font>String[] proStr = processInfo.split(<font class="Fields">" "</font>);</p><p>			<font class="Comments">// USER PID PPID VSIZE RSS WCHAN PC NAME</font></p><p>			<font class="Comments">// root 1 0 416 300 c00d4b28 0000cd5c S /init</font></p><p>			</font>List&lt;String&gt; orgInfo = <font class="keyword">new </font>ArrayList&lt;String&gt;();</p><p>			<font class="keyword">for </font>(String str : proStr) {</p><p>				<font class="keyword">if </font>(!<font class="Fields">""</font>.equals(str)) {</p><p>					orgInfo.add(str);</p><p>				}</p><p>			}</p><p>			<font class="keyword">if </font>(orgInfo.size() == 9) {</p><p>				</font>ProcessInfo pInfo = <font class="keyword">new </font>ProcessInfo();</p><p>				pInfo.user = orgInfo.get(0);</p><p>				pInfo.pid = orgInfo.get(1);</p><p>				pInfo.ppid = orgInfo.get(2);</p><p>				pInfo.name = orgInfo.get(8);</p><p>				procInfoList.add(pInfo);</p><p>			}</p><p>		}</p><p>		<font class="keyword">return </font>procInfoList;</p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 运行PS命令得到进程信息</font></p><p>	 <font class="Comments">* </font></p><p>	 <font class="Comments">* @return USER PID PPID VSIZE RSS WCHAN PC NAME root 1 0 416 300 c00d4b28</font></p><p>	 <font class="Comments">*         0000cd5c S /init</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">private </font>List&lt;String&gt; getAllProcess() {</p><p>		</font>List&lt;String&gt; orgProcList = <font class="keyword">new </font>ArrayList&lt;String&gt;();</p><p>		</font>Process proc = <font class="keyword">null</font>;</p><p>		<font class="keyword">try </font>{</p><p>			</font>proc = Runtime.getRuntime().exec(<font class="Fields">"ps"</font>);</p><p>			</font>StreamConsumer errorConsumer = <font class="keyword">new </font>StreamConsumer(</p><p>					proc.getErrorStream());</p><p></p><p>			</font>StreamConsumer outputConsumer = <font class="keyword">new </font>StreamConsumer(</p><p>					proc.getInputStream(), orgProcList);</p><p></p><p>			errorConsumer.start();</p><p>			outputConsumer.start();</p><p>			<font class="keyword">if </font>(proc.waitFor() != 0) {</p><p>				</font>Log.e(TAG, <font class="Fields">"getAllProcess proc.waitFor() != 0"</font>);</p><p>				</font>recordLogServiceLog(<font class="Fields">"getAllProcess proc.waitFor() != 0"</font>);</p><p>			}</p><p>		</font>} <font class="keyword">catch </font>(Exception e) {</p><p>			</font>Log.e(TAG, <font class="Fields">"getAllProcess failed"</font>, e);</p><p>			</font>recordLogServiceLog(<font class="Fields">"getAllProcess failed"</font>);</p><p>		} finally {</p><p>			<font class="keyword">try </font>{</p><p>				proc.destroy();</p><p>			</font>} <font class="keyword">catch </font>(Exception e) {</p><p>				</font>Log.e(TAG, <font class="Fields">"getAllProcess failed"</font>, e);</p><p>				</font>recordLogServiceLog(<font class="Fields">"getAllProcess failed"</font>);</p><p>			}</p><p>		}</p><p>		<font class="keyword">return </font>orgProcList;</p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 开始收集日志信息</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">public </font><font class="keyword">void </font>createLogCollector() {</p><p>		</font>String logFileName = sdf.format(<font class="keyword">new </font>Date()) + <font class="Fields">".log"</font>;<font class="Comments">// 日志文件名称</font></p><p>		</font>List&lt;String&gt; commandList = <font class="keyword">new </font>ArrayList&lt;String&gt;();</p><p>		</font>commandList.add(<font class="Fields">"logcat"</font>);</p><p>		</font>commandList.add(<font class="Fields">"-f"</font>);</p><p>		<font class="Comments">// commandList.add(LOG_PATH_INSTALL_DIR + File.separator + logFileName);</font></p><p>		commandList.add(getLogPath());</p><p>		</font>commandList.add(<font class="Fields">"-v"</font>);</p><p>		</font>commandList.add(<font class="Fields">"time"</font>);</p><p>		</font>commandList.add(<font class="Fields">"*:I"</font>);</p><p></p><p>		<font class="Comments">// commandList.add("*:E");<font class="Comments">// 过滤所有的错误信息</font></p><p></p><p>		<font class="Comments">// 过滤指定TAG的信息</font></p><p>		<font class="Comments">// commandList.add("MyAPP:V");</font></p><p>		<font class="Comments">// commandList.add("*:S");</font></p><p>		<font class="keyword">try </font>{</p><p>			process = Runtime.getRuntime().exec(</p><p>					</font>commandList.toArray(<font class="keyword">new </font>String[commandList.size()]));</p><p>			</font>recordLogServiceLog(<font class="Fields">"start collecting the log,and log name is:</p><p>					+ logFileName);</p><p>			<font class="Comments">// process.waitFor();</font></p><p>		</font>} <font class="keyword">catch </font>(Exception e) {</p><p>			</font>Log.e(TAG, <font class="Fields">"CollectorThread == &gt;"</font> + e.getMessage(), e);</p><p>			</font>recordLogServiceLog(<font class="Fields">"CollectorThread == &gt;"</font> + e.getMessage());</p><p>		}</p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 根据当前的存储位置得到日志的绝对存储路径</font></p><p>	 <font class="Comments">* </font></p><p>	 <font class="Comments">* @return</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">public </font>String getLogPath() {</p><p>		createLogDir();</p><p>		</font>String logFileName = sdf.format(<font class="keyword">new </font>Date()) + <font class="Fields">".log"</font>;<font class="Comments">// 日志文件名称</font></p><p>		<font class="keyword">if </font>(CURR_LOG_TYPE == MEMORY_TYPE) {</p><p>			CURR_INSTALL_LOG_NAME = logFileName;</p><p>			</font>Log.d(TAG, <font class="Fields">"Log stored in memory, the path is:</p><p>					+ LOG_PATH_MEMORY_DIR + File.separator + logFileName);</p><p>			<font class="keyword">return </font>LOG_PATH_MEMORY_DIR + File.separator + logFileName;</p><p>		</font>} <font class="keyword">else </font>{</p><p>			</font>CURR_INSTALL_LOG_NAME = <font class="keyword">null</font>;</p><p>			</font>Log.d(TAG, <font class="Fields">"Log stored in SDcard, the path is:</p><p>					+ LOG_PATH_SDCARD_DIR + File.separator + logFileName);</p><p>			<font class="keyword">return </font>LOG_PATH_SDCARD_DIR + File.separator + logFileName;</p><p>		}</p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 处理日志文件 1.如果日志文件存储位置切换到内存中，删除除了正在写的日志文件 并且部署日志大小监控任务，控制日志大小不超过规定值</font></p><p>	 <font class="Comments">* 2.如果日志文件存储位置切换到SDCard中，删除7天之前的日志，移 动所有存储在内存中的日志到SDCard中，并将之前部署的日志大小 监控取消</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">public </font><font class="keyword">void </font>handleLog() {</p><p>		<font class="keyword">if </font>(CURR_LOG_TYPE == MEMORY_TYPE) {</p><p>			deployLogSizeMonitorTask();</p><p>			deleteMemoryExpiredLog();</p><p>		</font>} <font class="keyword">else </font>{</p><p>			moveLogfile();</p><p>			cancelLogSizeMonitorTask();</p><p>			deleteSDcardExpiredLog();</p><p>		}</p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 部署日志大小监控任务</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">private </font><font class="keyword">void </font>deployLogSizeMonitorTask() {</p><p>		<font class="keyword">if </font>(logSizeMoniting) { <font class="Comments">// 如果当前正在监控着，则不需要继续部署</font></p><p>			<font class="keyword">return</font>;</font></p><p>		}</p><p>		</font>logSizeMoniting = <font class="keyword">true</font>;</p><p>		</font>Intent intent = <font class="keyword">new </font>Intent(MONITOR_LOG_SIZE_ACTION);</p><p>		</font>PendingIntent sender = PendingIntent.getBroadcast(<font class="keyword">this</font>, 0, intent, 0);</p><p>		AlarmManager am = (AlarmManager) getSystemService(ALARM_SERVICE);</p><p>		am.setRepeating(AlarmManager.RTC_WAKEUP, System.currentTimeMillis(),</p><p>				MEMORY_LOG_FILE_MONITOR_INTERVAL, sender);</p><p>		</font>Log.d(TAG, <font class="Fields">"deployLogSizeMonitorTask() succ !"</font>);</p><p>		<font class="Comments">// recordLogServiceLog("deployLogSizeMonitorTask() succ ,start time is "</font></p><p>		<font class="Comments">// + calendar.getTime().toLocaleString());</font></p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 取消部署日志大小监控任务</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">private </font><font class="keyword">void </font>cancelLogSizeMonitorTask() {</p><p>		</font>logSizeMoniting = <font class="keyword">false</font>;</p><p>		AlarmManager am = (AlarmManager) getSystemService(ALARM_SERVICE);</p><p>		</font>Intent intent = <font class="keyword">new </font>Intent(MONITOR_LOG_SIZE_ACTION);</p><p>		</font>PendingIntent sender = PendingIntent.getBroadcast(<font class="keyword">this</font>, 0, intent, 0);</p><p>		am.cancel(sender);</p><p></p><p>		</font>Log.d(TAG, <font class="Fields">"canelLogSizeMonitorTask() succ"</font>);</p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 检查日志文件大小是否超过了规定大小 如果超过了重新开启一个日志收集进程</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">private </font><font class="keyword">void </font>checkLogSize() {</p><p>		<font class="keyword">if </font>(CURR_INSTALL_LOG_NAME != </font><font class="keyword">null</font> && !<font class="Fields">""</font>.equals(CURR_INSTALL_LOG_NAME)) {</p><p>			String path = LOG_PATH_MEMORY_DIR + File.separator</p><p>					+ CURR_INSTALL_LOG_NAME;</p><p>			</font>File file = <font class="keyword">new </font>File(path);</p><p>			<font class="keyword">if </font>(!file.exists()) {</p><p>				<font class="keyword">return</font>;</font></p><p>			}</p><p>			</font>Log.d(TAG, <font class="Fields">"checkLog() ==&gt; The size of the log is too big?"</font>);</p><p>			<font class="keyword">if </font>(file.length() &gt;= MEMORY_LOG_FILE_MAX_SIZE) {</p><p>				</font>Log.d(TAG, <font class="Fields">"The log</font><font class="Fields">'s size is too big!"</font>);</p><p>				<font class="keyword">new </font>LogCollectorThread().start();</p><p>			}</p><p>		}</p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 创建日志目录</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">private </font><font class="keyword">void </font>createLogDir() {</p><p>		</font>File file = <font class="keyword">new </font>File(LOG_PATH_MEMORY_DIR);</p><p>		<font class="keyword">boolean </font>mkOk;</p><p>		<font class="keyword">if </font>(!file.isDirectory()) {</p><p>			mkOk = file.mkdirs();</p><p>			<font class="keyword">if </font>(!mkOk) {</p><p>				mkOk = file.mkdirs();</p><p>			}</p><p>		}</p><p></p><p>		/* ************************************</p><p>		 <font class="Comments">* file = new File(LOG_SERVICE_LOG_PATH); if (!file.exists()) { try {</font></p><p>		 <font class="Comments">* mkOk = file.createNewFile(); if (!mkOk) { file.createNewFile(); } }</font></p><p>		 <font class="Comments">* catch (IOException e) { Log.e(TAG, e.getMessage(), e); } }</font></p><p>		 <font class="Comments">* <font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*<font class="Comments">*</font></p><p>		 <font class="Comments">*/</font></p><p></p><p>		<font class="keyword">if </font>(Environment.getExternalStorageState().equals(</p><p>				Environment.MEDIA_MOUNTED)) {</p><p>			</font>file = <font class="keyword">new </font>File(LOG_PATH_SDCARD_DIR);</p><p>			<font class="keyword">if </font>(!file.isDirectory()) {</p><p>				mkOk = file.mkdirs();</p><p>				<font class="keyword">if </font>(!mkOk) {</p><p>					</font>recordLogServiceLog(<font class="Fields">"move file failed,dir is not created succ"</font>);</p><p>					<font class="keyword">return</font>;</font></p><p>				}</p><p>			}</p><p>		}</p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 将日志文件转移到SD卡下面</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">private </font><font class="keyword">void </font>moveLogfile() {</p><p>		<font class="keyword">if </font>(!Environment.getExternalStorageState().equals(</p><p>				Environment.MEDIA_MOUNTED)) {</p><p>			<font class="Comments">// recordLogServiceLog("move file failed, sd card does not mount");</font></p><p>			<font class="keyword">return</font>;</font></p><p>		}</p><p>		</font>File file = <font class="keyword">new </font>File(LOG_PATH_SDCARD_DIR);</p><p>		<font class="keyword">if </font>(!file.isDirectory()) {</p><p>			<font class="keyword">boolean </font>mkOk = file.mkdirs();</p><p>			<font class="keyword">if </font>(!mkOk) {</p><p>				<font class="Comments">// recordLogServiceLog("move file failed,dir is not created succ");</font></p><p>				<font class="keyword">return</font>;</font></p><p>			}</p><p>		}</p><p></p><p>		</font>file = <font class="keyword">new </font>File(LOG_PATH_MEMORY_DIR);</p><p>		<font class="keyword">if </font>(file.isDirectory()) {</p><p>			File[] allFiles = file.listFiles();</p><p>			<font class="keyword">for </font>(File logFile : allFiles) {</p><p>				String fileName = logFile.getName();</p><p>				<font class="keyword">if </font>(logServiceLogName.equals(fileName)) {</p><p>					<font class="keyword">continue</font>;</p><p>				}</p><p>				<font class="Comments">// String createDateInfo =</font></p><p>				<font class="Comments">// getFileNameWithoutExtension(fileName);</font></p><p>				<font class="keyword">boolean </font>isSucc = copy(logFile, </font><font class="keyword">new </font>File(LOG_PATH_SDCARD_DIR</p><p>						+ File.separator + fileName));</p><p>				<font class="keyword">if </font>(isSucc) {</p><p>					logFile.delete();</p><p>					<font class="Comments">// recordLogServiceLog("move file success,log name is:"+fileName);</font></p><p>				}</p><p>			}</p><p>		}</p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 删除内存下过期的日志</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">private </font><font class="keyword">void </font>deleteSDcardExpiredLog() {</p><p>		</font>File file = <font class="keyword">new </font>File(LOG_PATH_SDCARD_DIR);</p><p>		<font class="keyword">if </font>(file.isDirectory()) {</p><p>			File[] allFiles = file.listFiles();</p><p>			<font class="keyword">for </font>(File logFile : allFiles) {</p><p>				String fileName = logFile.getName();</p><p>				<font class="keyword">if </font>(logServiceLogName.equals(fileName)) {</p><p>					<font class="keyword">continue</font>;</p><p>				}</p><p>				String createDateInfo = getFileNameWithoutExtension(fileName);</p><p>				<font class="keyword">if </font>(canDeleteSDLog(createDateInfo)) {</p><p>					logFile.delete();</p><p>					</font>Log.d(TAG, <font class="Fields">"delete expired log success,the log path is:</p><p>							+ logFile.getAbsolutePath());</p><p></p><p>				}</p><p>			}</p><p>		}</p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 判断sdcard上的日志文件是否可以删除</font></p><p>	 <font class="Comments">* </font></p><p>	 <font class="Comments">* @param createDateStr</font></p><p>	 <font class="Comments">* @return</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">public </font><font class="keyword">boolean </font>canDeleteSDLog(String createDateStr) {</p><p>		<font class="keyword">boolean </font>canDel = </font><font class="keyword">false</font>;</p><p>		Calendar calendar = Calendar.getInstance();</p><p>		calendar.add(Calendar.DAY_OF_MONTH, -1 * SDCARD_LOG_FILE_SAVE_DAYS);<font class="Comments">// 删除7天之前日志</font></p><p>		Date expiredDate = calendar.getTime();</p><p>		<font class="keyword">try </font>{</p><p>			Date createDate = sdf.parse(createDateStr);</p><p>			canDel = createDate.before(expiredDate);</p><p>		</font>} <font class="keyword">catch </font>(ParseException e) {</p><p>			Log.e(TAG, e.getMessage(), e);</p><p>			</font>canDel = <font class="keyword">false</font>;</p><p>		}</p><p>		<font class="keyword">return </font>canDel;</p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 删除内存中的过期日志，删除规则： 除了当前的日志和离当前时间最近的日志保存其他的都删除</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">private </font><font class="keyword">void </font>deleteMemoryExpiredLog() {</p><p>		</font>File file = <font class="keyword">new </font>File(LOG_PATH_MEMORY_DIR);</p><p>		<font class="keyword">if </font>(file.isDirectory()) {</p><p>			File[] allFiles = file.listFiles();</p><p>			</font>Arrays.sort(allFiles, <font class="keyword">new </font>FileComparator());</p><p>			<font class="keyword">for </font>(</font><font class="keyword">int </font>i = 0; i &lt; allFiles.length - 2; i++) { <font class="Comments">// <font class="Fields">"-2"</font>保存最近的两个日志文件</font></p><p>				File _file = allFiles[i];</p><p>				<font class="keyword">if </font>(logServiceLogName.equals(_file.getName())</p><p>						|| _file.getName().equals(CURR_INSTALL_LOG_NAME)) {</p><p>					<font class="keyword">continue</font>;</p><p>				}</p><p>				_file.delete();</p><p>				</font>Log.d(TAG, <font class="Fields">"delete expired log success,the log path is:</p><p>						+ _file.getAbsolutePath());</p><p>			}</p><p>		}</p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 拷贝文件</font></p><p>	 <font class="Comments">* </font></p><p>	 <font class="Comments">* @param source</font></p><p>	 <font class="Comments">* @param target</font></p><p>	 <font class="Comments">* @return</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">private </font><font class="keyword">boolean </font>copy(File source, File target) {</p><p>		</font>FileInputStream in = <font class="keyword">null</font>;</p><p>		</font>FileOutputStream out = <font class="keyword">null</font>;</p><p>		<font class="keyword">try </font>{</p><p>			<font class="keyword">if </font>(!target.exists()) {</p><p>				<font class="keyword">boolean </font>createSucc = target.createNewFile();</p><p>				<font class="keyword">if </font>(!createSucc) {</p><p>					<font class="keyword">return </font><font class="keyword">false</font>;</p><p>				}</p><p>			}</p><p>			</font>in = <font class="keyword">new </font>FileInputStream(source);</p><p>			</font>out = <font class="keyword">new </font>FileOutputStream(target);</p><p>			</font>byte[] buffer = <font class="keyword">new </font>byte[8 * 1024];</p><p>			<font class="keyword">int </font>count;</p><p>			<font class="keyword">while </font>((count = in.read(buffer)) != -1) {</p><p>				out.write(buffer, 0, count);</p><p>			}</p><p>			<font class="keyword">return </font><font class="keyword">true</font>;</p><p>		</font>} <font class="keyword">catch </font>(Exception e) {</p><p>			e.printStackTrace();</p><p>			Log.e(TAG, e.getMessage(), e);</p><p>			</font>recordLogServiceLog(<font class="Fields">"copy file fail"</font>);</p><p>			<font class="keyword">return </font><font class="keyword">false</font>;</p><p>		} finally {</p><p>			<font class="keyword">try </font>{</p><p>				<font class="keyword">if </font>(in != </font><font class="keyword">null</font>) {</p><p>					in.close();</p><p>				}</p><p>				<font class="keyword">if </font>(out != </font><font class="keyword">null</font>) {</p><p>					out.close();</p><p>				}</p><p>			</font>} <font class="keyword">catch </font>(IOException e) {</p><p>				e.printStackTrace();</p><p>				Log.e(TAG, e.getMessage(), e);</p><p>				</font>recordLogServiceLog(<font class="Fields">"copy file fail"</font>);</p><p>				<font class="keyword">return </font><font class="keyword">false</font>;</p><p>			}</p><p>		}</p><p></p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 记录日志服务的基本信息 防止日志服务有错，在LogCat日志中无法查找 此日志名称为Log.log</font></p><p>	 <font class="Comments">* </font></p><p>	 <font class="Comments">* @param msg</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">private </font><font class="keyword">void </font>recordLogServiceLog(String msg) {</p><p>		<font class="keyword">if </font>(writer != </font><font class="keyword">null</font>) {</p><p>			<font class="keyword">try </font>{</p><p>				</font>Date time = <font class="keyword">new </font>Date();</p><p>				</font>writer.write(myLogSdf.format(time) + <font class="Fields">" : "</font> + msg);</p><p>				</font>writer.write(<font class="Fields">"\n"</font>);</p><p>				writer.flush();</p><p>			</font>} <font class="keyword">catch </font>(IOException e) {</p><p>				e.printStackTrace();</p><p>				Log.e(TAG, e.getMessage(), e);</p><p>			}</p><p>		}</p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 去除文件的扩展类型（.log）</font></p><p>	 <font class="Comments">* </font></p><p>	 <font class="Comments">* @param fileName</font></p><p>	 <font class="Comments">* @return</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">private </font>String getFileNameWithoutExtension(String fileName) {</p><p>		<font class="keyword">return </font>fileName.substring(0, fileName.indexOf(<font class="Fields">"."</font>));</p><p>	}</p><p></p><p>	<font class="keyword">class </font>ProcessInfo {</p><p>		<font class="keyword">public </font>String user;</p><p>		<font class="keyword">public </font>String pid;</p><p>		<font class="keyword">public </font>String ppid;</p><p>		<font class="keyword">public </font>String name;</p><p></p><p>		@Override</p><p>		<font class="keyword">public </font>String toString() {</p><p>			</font>String str = <font class="Fields">"user="</font> + user + </font><font class="Fields">" pid="</font> + pid + </font><font class="Fields">" ppid="</font> + ppid</p><p>					</font>+ <font class="Fields">" name="</font> + name;</p><p>			<font class="keyword">return </font>str;</p><p>		}</p><p>	}</p><p></p><p>	<font class="keyword">class </font>StreamConsumer </font><font class="keyword">extends </font>Thread {</p><p>		InputStream is;</p><p>		List&lt;String&gt; list;</p><p></p><p>		StreamConsumer(InputStream is) {</p><p>			<font class="keyword">this</font>.is = is;</p><p>		}</p><p></p><p>		StreamConsumer(InputStream is, List&lt;String&gt; list) {</p><p>			<font class="keyword">this</font>.is = is;</p><p>			<font class="keyword">this</font>.list = list;</p><p>		}</p><p></p><p>		<font class="keyword">public </font><font class="keyword">void </font>run() {</p><p>			<font class="keyword">try </font>{</p><p>				</font>InputStreamReader isr = <font class="keyword">new </font>InputStreamReader(is);</p><p>				</font>BufferedReader br = <font class="keyword">new </font>BufferedReader(isr);</p><p>				</font>String line = <font class="keyword">null</font>;</p><p>				<font class="keyword">while </font>((line = br.readLine()) != </font><font class="keyword">null</font>) {</p><p>					<font class="keyword">if </font>(list != </font><font class="keyword">null</font>) {</p><p>						list.add(line);</p><p>					}</p><p>				}</p><p>			</font>} <font class="keyword">catch </font>(IOException ioe) {</p><p>				ioe.printStackTrace();</p><p>			}</p><p>		}</p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 监控SD卡状态</font></p><p>	 <font class="Comments">* </font></p><p>	 <font class="Comments">* @author Administrator</font></p><p>	 <font class="Comments">* </font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">class </font>SDStateMonitorReceiver </font><font class="keyword">extends </font>BroadcastReceiver {</p><p>		<font class="keyword">public </font><font class="keyword">void </font>onReceive(Context context, Intent intent) {</p><p></p><p>			<font class="keyword">if </font>(Intent.ACTION_MEDIA_UNMOUNTED.equals(intent.getAction())) { <font class="Comments">// 存储卡被卸载</font></p><p>				<font class="keyword">if </font>(CURR_LOG_TYPE == SDCARD_TYPE) {</p><p>					</font>Log.d(TAG, <font class="Fields">"SDcar is UNMOUNTED"</font>);</p><p>					CURR_LOG_TYPE = MEMORY_TYPE;</p><p>					<font class="keyword">new </font>LogCollectorThread().start();</p><p>				}</p><p>			</font>} <font class="keyword">else </font>{ <font class="Comments">// 存储卡被挂载</font></p><p>				<font class="keyword">if </font>(CURR_LOG_TYPE == MEMORY_TYPE) {</p><p>					</font>Log.d(TAG, <font class="Fields">"SDcar is MOUNTED"</font>);</p><p>					CURR_LOG_TYPE = SDCARD_TYPE;</p><p>					<font class="keyword">new </font>LogCollectorThread().start();</p><p></p><p>				}</p><p>			}</p><p>		}</p><p>	}</p><p></p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* 日志任务接收 切换日志，监控日志大小</font></p><p>	 <font class="Comments">* </font></p><p>	 <font class="Comments">* @author Administrator</font></p><p>	 <font class="Comments">* </font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">class </font>LogTaskReceiver </font><font class="keyword">extends </font>BroadcastReceiver {</p><p>		<font class="keyword">public </font><font class="keyword">void </font>onReceive(Context context, Intent intent) {</p><p>			String action = intent.getAction();</p><p>			<font class="keyword">if </font>(SWITCH_LOG_FILE_ACTION.equals(action)) {</p><p>				<font class="keyword">new </font>LogCollectorThread().start();</p><p>			</font>} <font class="keyword">else </font><font class="keyword">if </font>(MONITOR_LOG_SIZE_ACTION.equals(action)) {</p><p>				checkLogSize();</p><p>			}</p><p>		}</p><p>	}</p><p></p><p>	<font class="keyword">class </font>FileComparator </font><font class="keyword">implements </font>Comparator&lt;File&gt; {</p><p>		<font class="keyword">public </font><font class="keyword">int </font>compare(File file1, File file2) {</p><p>			<font class="keyword">if </font>(logServiceLogName.equals(file1.getName())) {</p><p>				<font class="keyword">return </font>-1;</p><p>			</font>} <font class="keyword">else </font><font class="keyword">if </font>(logServiceLogName.equals(file2.getName())) {</p><p>				<font class="keyword">return </font>1;</p><p>			}</p><p></p><p>			String createInfo1 = getFileNameWithoutExtension(file1.getName());</p><p>			String createInfo2 = getFileNameWithoutExtension(file2.getName());</p><p></p><p>			<font class="keyword">try </font>{</p><p>				Date create1 = sdf.parse(createInfo1);</p><p>				Date create2 = sdf.parse(createInfo2);</p><p>				<font class="keyword">if </font>(create1.before(create2)) {</p><p>					<font class="keyword">return </font>-1;</p><p>				</font>} <font class="keyword">else </font>{</p><p>					<font class="keyword">return </font>1;</p><p>				}</p><p>			</font>} <font class="keyword">catch </font>(ParseException e) {</p><p>				<font class="keyword">return </font>0;</p><p>			}</p><p>		}</p><p>	}</p><p></p><p>	@Override</p><p>	<font class="keyword">public </font><font class="keyword">void </font>onDestroy() {</p><p>		<font class="keyword">super</font>.onDestroy();</p><p>		</font>recordLogServiceLog(<font class="Fields">"LogService onDestroy"</font>);</p><p>		<font class="keyword">if </font>(writer != </font><font class="keyword">null</font>) {</p><p>			<font class="keyword">try </font>{</p><p>				writer.close();</p><p>			</font>} <font class="keyword">catch </font>(IOException e) {</p><p>				e.printStackTrace();</p><p>			}</p><p>		}</p><p>		<font class="keyword">if </font>(process != </font><font class="keyword">null</font>) {</p><p>			process.destroy();</p><p>		}</p><p></p><p>		unregisterReceiver(sdStateReceiver);</p><p>		unregisterReceiver(logTaskReceiver);</p><p>	}</p><p></p><p>}</p><p></pre></p><p>最后不要忘记在配置文件中加入</p><p><pre> </p><p>&lt;uses-permission android:name="android.permission.READ_LOGS" /&gt;  </p><p></pre></p><p></p></div>

</DIV></DIV>

<DIV id=footer style="display:none">
<P align="center">  
 
 
 
    </P>
</DIV></BODY></HTML>

