
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML xmlns="http://www.w3.org/1999/xhtml">
<HEAD>
<TITLE>Android Json解析示例代码_Android学习手册</TITLE>
<META content="text/html; charset=gb2312" http-equiv=Content-Type><LINK  rel=stylesheet type=text/css href="../css/c5.css">
<META name=GENERATOR content="MSHTML 8.00.6001.18702">
<meta name="Description" content=Android基础 Android组件 Android用户界面 Android设备功能 Android数据存储 Android网络应用 Android游戏开发 Android多媒体 Android源码开发 Android高级进阶 Android面试题/>
<meta name="Keywords" content="android 学习手册">

</HEAD>
<BODY id=homesecond class=serverscripting>
<DIV id=wrapper>
<DIV id=header><h1><a href="../index.html">Android学习手册</a></h1> 
</DIV>

<DIV id=navfirst>
<div id="indexGuide"><UL><li ><A href="../basic/index.html">Android基础</A> </li><li class="navcurrentLink"><A href="index.html">Android组件</A> </li><li ><A href="../userinterface/index.html">用户界面</A> </li><li ><A href="../device/index.html">设备功能</A> </li><li ><A href="../datastorage/index.html">数据存储</A> </li><li ><A href="../network/index.html">网络应用</A> </li><li ><A href="../game/index.html">游戏开发</A> </li><li ><A href="../multimedia/index.html">多媒体</A> </li><li ><A href="../source/index.html">源码开发</A> </li><li ><A href="../advance/index.html">高级进阶</A> </li><li ><A href="../interview/index.html">Android面试题</A> </li></UL></div>
</DIV>
<DIV id=navsecond>
<DIV id=course>
<div id="kcTitle">课 程 表</div>


  <h2><A title="Activity" href="index_112.html">Activity</A></h2>

  <h2><A title="Intent" href="index_113.html">Intent</A></h2>

  <h2><A title="Service" href="index_114.html">Service</A></h2>

  <h2><A title="Content Provider" href="index_115.html">Content Provider</A></h2>

  <h2><A title="BroadcastReceiver" href="index_116.html">BroadcastReceiver</A></h2>

  <h2><A title="AsyncTask" href="index_117.html">AsyncTask</A></h2>

  <h2><A title="Handler" href="index_118.html">Handler</A></h2>

  <h2><A title="Thread" href="index_119.html">Thread</A></h2>

  <h2><A title="Permission" href="index_120.html">Permission</A></h2>

  <h2><A title="AIDL" href="index_121.html">AIDL</A></h2>

  <h2><A title="Json" href="index_122.html">Json</A></h2>
<UL><li ><A title=Android Json 基础 href="show_1001_122.html">Android Json 基础</A> </li><li ><A title=Json写入类-JsonWriter href="show_1002_122.html">Json写入类-JsonWriter</A> </li><li class="currentLink"><A title=Android Json解析示例代码 href="show_1003_122.html">Android Json解析示例代码</A> </li><li ><A title=Android Json href="show_1004_122.html">Android Json</A> </li></UL>
</DIV></DIV>
<DIV id=maincontent>
<DIV id=w3school>
<H1></H1>
<P><STRONG></STRONG></P></DIV>

<DIV>
<H2>Android Json解析示例代码</H2>
<div style="line-height:20px; font-size:14px;"><p>来自Google官方的有关Android平台的JSON解析示例，如果远程服务器使用了json而不是xml的数据提供，在Android平台上已经内置的org.json包可以很方便的实现手机客户端的解析处理。下面一起分析下这个例子，帮助Android开发者需要有关HTTP通讯、正则表达式、JSON解析、appWidget开发的一些知识。</p><p><pre><font class="keyword">public </font><font class="keyword">class </font>WordWidget </font><font class="keyword">extends </font>AppWidgetProvider { <font class="Comments">// appWidget</font></p><p>	@Override</p><p>	<font class="keyword">public </font><font class="keyword">void </font>onUpdate(Context context, AppWidgetManager appWidgetManager,</p><p>			<font class="keyword">int</font>[] appWidgetIds) {</p><p>		</font>context.startService(<font class="keyword">new </font>Intent(context, UpdateService.</font><font class="keyword">class</font>)); <font class="Comments">// 避免ANR，所以Widget中开了个服务</font></p><p>	}</p><p>	<font class="keyword">public </font><font class="keyword">static </font><font class="keyword">class </font>UpdateService </font><font class="keyword">extends </font>Service {</p><p>		@Override</p><p>		<font class="keyword">public </font><font class="keyword">void </font>onStart(Intent intent, </font><font class="keyword">int </font>startId) {</p><p>			<font class="Comments">// Build the widget update for today</font></p><p>			</font>RemoteViews updateViews = buildUpdate(<font class="keyword">this</font>);</p><p>			</font>ComponentName <font class="keyword">this</font>Widget = </font><font class="keyword">new </font>ComponentName(</font><font class="keyword">this</font>, WordWidget.</font><font class="keyword">class</font>);</p><p>			</font>AppWidgetManager manager = AppWidgetManager.getInstance(<font class="keyword">this</font>);</p><p>			</font>manager.updateAppWidget(<font class="keyword">this</font>Widget, updateViews);</p><p>		}</p><p>		<font class="keyword">public </font>RemoteViews buildUpdate(Context context) {</p><p>			<font class="Comments">// Pick out month names from resources</font></p><p>			Resources res = context.getResources();</p><p>			String[] monthNames = res.getStringArray(R.array.month_names);</p><p>			</font>Time today = <font class="keyword">new </font>Time();</p><p>			today.setToNow();</p><p>			String pageName = res.getString(R.string.template_wotd_title,</p><p>					monthNames[today.month], today.monthDay);</p><p>			</font>RemoteViews updateViews = <font class="keyword">null</font>;</p><p>			</font>String pageContent = <font class="Fields">""</font>;</p><p>			<font class="keyword">try </font>{</p><p>				SimpleWikiHelper.prepareUserAgent(context);</p><p>				</font>pageContent = SimpleWikiHelper.getPageContent(pageName, <font class="keyword">false</font>);</p><p>			</font>} <font class="keyword">catch </font>(ApiException e) {</p><p>				</font>Log.e(<font class="Fields">"WordWidget"</font>, </font><font class="Fields">"Couldn</font><font class="Fields">'t contact API"</font>, e);</p><p>			</font>} <font class="keyword">catch </font>(ParseException e) {</p><p>				</font>Log.e(<font class="Fields">"WordWidget"</font>, </font><font class="Fields">"Couldn</font><font class="Fields">'t parse API response"</font>, e);</p><p>			}</p><p>			Pattern pattern = Pattern</p><p>					.compile(SimpleWikiHelper.WORD_OF_DAY_REGEX); <font class="Comments">// 正则表达式处理，有关定义见下面的SimpleWikiHelper类</font></p><p>			Matcher matcher = pattern.matcher(pageContent);</p><p>			<font class="keyword">if </font>(matcher.find()) {</p><p>				</font>updateViews = <font class="keyword">new </font>RemoteViews(context.getPackageName(),</p><p>						R.layout.widget_word);</p><p>				String wordTitle = matcher.group(1);</p><p>				updateViews.setTextViewText(R.id.word_title, wordTitle);</p><p>				updateViews.setTextViewText(R.id.word_type, matcher.group(2));</p><p>				updateViews.setTextViewText(R.id.definition, matcher.group(3)</p><p>						.trim());</p><p>				String definePage = res.getString(R.string.template_define_url,</p><p>						Uri.encode(wordTitle));</p><p>				</font>Intent defineIntent = <font class="keyword">new </font>Intent(Intent.ACTION_VIEW,</p><p>						Uri.parse(definePage)); <font class="Comments">// 这里是打开相应的网页，所以Uri是http的url，action是view即打开web浏览器</font></p><p>				PendingIntent pendingIntent = PendingIntent.getActivity(</p><p>						context, 0 /* no requestCode */, defineIntent, 0 /*</p><p>																		 <font class="Comments">* no</font></p><p>																		 <font class="Comments">* flags</font></p><p>																		 <font class="Comments">*/);</font></p><p>				updateViews.setOnClickPendingIntent(R.id.widget, pendingIntent); <font class="Comments">// 单击Widget打开Activity</font></p><p>			</font>} <font class="keyword">else </font>{</p><p>				</font>updateViews = <font class="keyword">new </font>RemoteViews(context.getPackageName(),</p><p>						R.layout.widget_message);</p><p>				CharSequence errorMessage = context</p><p>						.getText(R.string.widget_error);</p><p>				updateViews.setTextViewText(R.id.message, errorMessage);</p><p>			}</p><p>			<font class="keyword">return </font>updateViews;</p><p>		}</p><p>		@Override</p><p>		<font class="keyword">public </font>IBinder onBind(Intent intent) {</p><p>			<font class="Comments">// We don't need to bind to this service</font></p><p>			<font class="keyword">return </font><font class="keyword">null</font>;</p><p>		}</p><p>	}</p><p>}</p><p></pre></p><p>有关网络通讯的实体类，以及一些常量定义如下:</p><p><pre><font class="keyword">public </font><font class="keyword">class </font>SimpleWikiHelper {</p><p>	<font class="keyword">private </font><font class="keyword">static </font><font class="keyword">final </font>String TAG = <font class="Fields">"SimpleWikiHelper"</font>;</p><p>	<font class="keyword">public </font><font class="keyword">static </font><font class="keyword">final </font>String WORD_OF_DAY_REGEX = <font class="Fields">"(?s)\\{\\{wotd\\|(.+?)\\|(.+?)\\|([^</font>\\|]+).*?\\</font>}\\</font>}"</font>;</p><p>	<font class="keyword">private </font><font class="keyword">static </font><font class="keyword">final </font>String WIKTIONARY_PAGE = <font class="Fields">"http:<font class="Comments">//en.wiktionary.org/w/api.php?action=query&prop=revisions&titles=%s&</font></p><p>			</font>+ <font class="Fields">"rvprop=content&format=json%s"</font>;</p><p>	<font class="keyword">private </font><font class="keyword">static </font><font class="keyword">final </font>String WIKTIONARY_EXPAND_TEMPLATES = <font class="Fields">"&rvexpandtemplates=</font><font class="keyword">true</font>"</font>;</p><p>	<font class="keyword">private </font><font class="keyword">static </font><font class="keyword">final </font><font class="keyword">int </font>HTTP_STATUS_OK = 200;</p><p>	<font class="keyword">private </font><font class="keyword">static </font>byte[] sBuffer = </font><font class="keyword">new </font>byte[512];</p><p>	<font class="keyword">private </font><font class="keyword">static </font>String sUserAgent = </font><font class="keyword">null</font>;</p><p>	<font class="keyword">public </font><font class="keyword">static </font><font class="keyword">class </font>ApiException </font><font class="keyword">extends </font>Exception {</p><p>		<font class="keyword">public </font>ApiException(String detailMessage, Throwable throwable) {</p><p>			<font class="keyword">super</font>(detailMessage, throwable);</p><p>		}</p><p>		<font class="keyword">public </font>ApiException(String detailMessage) {</p><p>			<font class="keyword">super</font>(detailMessage);</p><p>		}</p><p>	}</p><p>	<font class="keyword">public </font><font class="keyword">static </font><font class="keyword">class </font>ParseException </font><font class="keyword">extends </font>Exception {</p><p>		<font class="keyword">public </font>ParseException(String detailMessage, Throwable throwable) {</p><p>			<font class="keyword">super</font>(detailMessage, throwable);</p><p>		}</p><p>	}</p><p>	<font class="keyword">public </font><font class="keyword">static </font><font class="keyword">void </font>prepareUserAgent(Context context) {</p><p>		<font class="keyword">try </font>{</p><p>			<font class="Comments">// Read package name and version number from manifest</font></p><p>			PackageManager manager = context.getPackageManager();</p><p>			PackageInfo info = manager.getPackageInfo(context.getPackageName(),</p><p>					0);</p><p>			sUserAgent = String.format(</p><p>					context.getString(R.string.template_user_agent),</p><p>					info.packageName, info.versionName);</p><p>		</font>} <font class="keyword">catch </font>(NameNotFoundException e) {</p><p>			</font>Log.e(TAG, <font class="Fields">"Couldn</font><font class="Fields">'t find package information in PackageManager"</font>, e);</p><p>		}</p><p>	}</p><p>	<font class="keyword">public </font><font class="keyword">static </font>String getPageContent(String title, </font><font class="keyword">boolean </font>expandTemplates)</p><p>			<font class="keyword">throws </font>ApiException, ParseException {</p><p>		String encodedTitle = Uri.encode(title);</p><p>		String expandClause = expandTemplates ? WIKTIONARY_EXPAND_TEMPLATES</p><p>				</font>: <font class="Fields">""</font>;</p><p>		String content = getUrlContent(String.format(WIKTIONARY_PAGE,</p><p>				encodedTitle, expandClause));</p><p>		<font class="keyword">try </font>{</p><p>			</font>JSONObject response = <font class="keyword">new </font>JSONObject(content);</p><p>			</font>JSONObject query = response.getJSONObject(<font class="Fields">"query"</font>);</p><p>			</font>JSONObject pages = query.getJSONObject(<font class="Fields">"pages"</font>);</p><p>			JSONObject page = pages.getJSONObject((String) pages.keys().next());</p><p>			</font>JSONArray revisions = page.getJSONArray(<font class="Fields">"revisions"</font>);</p><p>			JSONObject revision = revisions.getJSONObject(0);</p><p>			<font class="keyword">return </font>revision.getString(<font class="Fields">"*"</font>);</p><p>		</font>} <font class="keyword">catch </font>(JSONException e) {</p><p>			<font class="keyword">throw </font><font class="keyword">new </font>ParseException(<font class="Fields">"Problem parsing API response"</font>, e);</p><p>		}</p><p>	}</p><p>	<font class="keyword">protected </font><font class="keyword">static </font><font class="keyword">synchronized </font>String getUrlContent(String url)</p><p>			<font class="keyword">throws </font>ApiException {</p><p>		<font class="keyword">if </font>(sUserAgent == </font><font class="keyword">null</font>) {</p><p>			<font class="keyword">throw </font><font class="keyword">new </font>ApiException(<font class="Fields">"User-Agent string must be prepared"</font>);</p><p>		}</p><p>		</font>HttpClient client = <font class="keyword">new </font>DefaultHttpClient();</p><p>		</font>HttpGet request = <font class="keyword">new </font>HttpGet(url);</p><p>		</font>request.setHeader(<font class="Fields">"User-Agent"</font>, sUserAgent); <font class="Comments">// 设置客户端标识</font></p><p>		<font class="keyword">try </font>{</p><p>			HttpResponse response = client.execute(request);</p><p></p><p>			StatusLine status = response.getStatusLine();</p><p>			<font class="keyword">if </font>(status.getStatusCode() != HTTP_STATUS_OK) {</p><p>				<font class="keyword">throw </font><font class="keyword">new </font>ApiException(<font class="Fields">"Invalid response from server: </p><p>						+ status.toString());</p><p>			}</p><p>			HttpEntity entity = response.getEntity();</p><p>			InputStream inputStream = entity.getContent(); <font class="Comments">// 获取HTTP返回的数据流</font></p><p>			</font>ByteArrayOutputStream content = <font class="keyword">new </font>ByteArrayOutputStream();</p><p>			<font class="keyword">int </font>readBytes = 0;</p><p>			<font class="keyword">while </font>((readBytes = inputStream.read(sBuffer)) != -1) {</p><p>				content.write(sBuffer, 0, readBytes); <font class="Comments">// 转化为字节数组流</font></p><p>			}</p><p>			<font class="keyword">return </font><font class="keyword">new </font>String(content.toByteArray()); <font class="Comments">// 从字节数组构建String</font></p><p>		</font>} <font class="keyword">catch </font>(IOException e) {</p><p>			<font class="keyword">throw </font><font class="keyword">new </font>ApiException(<font class="Fields">"Problem communicating with API"</font>, e);</p><p>		}</p><p>	}</p><p>}</p><p></pre></p><p>有关整个每日维基的widget例子比较简单，主要是帮助大家积累常用代码，了解Android平台 JSON的处理方式，毕竟很多Server还是Java的。</p><p></p></div>

</DIV></DIV>

<DIV id=footer style="display:none">
<P align="center">  
 
 
 
    </P>
</DIV></BODY></HTML>

