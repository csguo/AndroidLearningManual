
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML xmlns="http://www.w3.org/1999/xhtml">
<HEAD>
<TITLE>Android 完美解决自定义preference与ActivityGroup UI更新的问题_Android学习手册</TITLE>
<META content="text/html; charset=gb2312" http-equiv=Content-Type><LINK  rel=stylesheet type=text/css href="../css/c5.css">
<META name=GENERATOR content="MSHTML 8.00.6001.18702">
<meta name="Description" content=Android基础 Android组件 Android用户界面 Android设备功能 Android数据存储 Android网络应用 Android游戏开发 Android多媒体 Android源码开发 Android高级进阶 Android面试题/>
<meta name="Keywords" content="android 学习手册">

</HEAD>
<BODY id=homesecond class=serverscripting>
<DIV id=wrapper>
<DIV id=header><h1><a href="../index.html">Android学习手册</a></h1> 
</DIV>

<DIV id=navfirst>
<div id="indexGuide"><UL><li ><A href="../basic/index.html">Android基础</A> </li><li ><A href="../component/index.html">Android组件</A> </li><li ><A href="../userinterface/index.html">用户界面</A> </li><li ><A href="../device/index.html">设备功能</A> </li><li class="navcurrentLink"><A href="index.html">数据存储</A> </li><li ><A href="../network/index.html">网络应用</A> </li><li ><A href="../game/index.html">游戏开发</A> </li><li ><A href="../multimedia/index.html">多媒体</A> </li><li ><A href="../source/index.html">源码开发</A> </li><li ><A href="../advance/index.html">高级进阶</A> </li><li ><A href="../interview/index.html">Android面试题</A> </li></UL></div>
</DIV>
<DIV id=navsecond>
<DIV id=course>
<div id="kcTitle">课 程 表</div>


  <h2><A title="ContentProvider" href="index_170.html">ContentProvider</A></h2>

  <h2><A title="Preferences" href="index_171.html">Preferences</A></h2>
<UL><li ><A title=Android API-SharedPreferences href="show_101_171.html">Android API-SharedPreferences</A> </li><li ><A title=Android SharedPreferences用法 href="show_102_171.html">Android SharedPreferences用法</A> </li><li ><A title=Android SharedPreferences用法（二） href="show_103_171.html">Android SharedPreferences用法（二）</A> </li><li ><A title=Android preferenceActivity用法 href="show_104_171.html">Android preferenceActivity用法</A> </li><li ><A title=Android 首选项框架ListPreference（一） href="show_105_171.html">Android 首选项框架ListPreference（一）</A> </li><li ><A title=Android 首选项框架ListPreference（二） href="show_106_171.html">Android 首选项框架ListPreference（二）</A> </li><li ><A title=Android 首选项框架ListPreference（三） href="show_107_171.html">Android 首选项框架ListPreference（三）</A> </li><li ><A title=Android 首选项框架ListPreference（四） href="show_108_171.html">Android 首选项框架ListPreference（四）</A> </li><li ><A title=Android 首选项框架ListPreference（五） href="show_109_171.html">Android 首选项框架ListPreference（五）</A> </li><li ><A title=Android之SharedPreferences href="show_110_171.html">Android之SharedPreferences</A> </li><li ><A title=SharedPreferences与Preferences href="show_111_171.html">SharedPreferences与Preferences</A> </li><li ><A title=onSaveInstanceState和onRestoreInstanceState的用处 href="show_112_171.html">onSaveInstanceState和onRestoreInstanceState的用处</A> </li><li ><A title=用SharedPreferences获取其他应用中用SharedPreferences保存的数据 href="show_113_171.html">用SharedPreferences获取其他应用中用SharedPreferences保存的数据</A> </li><li ><A title=PreferenceActivity 参数设置UI的使用 href="show_114_171.html">PreferenceActivity 参数设置UI的使用</A> </li><li ><A title=Android 让浏览器全屏显示 href="show_115_171.html">Android 让浏览器全屏显示</A> </li><li ><A title=Android EditTextPreference href="show_116_171.html">Android EditTextPreference</A> </li><li ><A title=Android下获取开机时间 href="show_117_171.html">Android下获取开机时间</A> </li><li ><A title=是否记住密码功能 href="show_118_171.html">是否记住密码功能</A> </li><li ><A title=在Activity中获取PreferenceActivity设置的值 href="show_119_171.html">在Activity中获取PreferenceActivity设置的值</A> </li><li class="currentLink"><A title=Android 完美解决自定义preference与ActivityGroup UI更新的问题 href="show_120_171.html">Android 完美解决自定义preference与ActivityGroup UI更新的问题</A> </li><li ><A title=Android 自定义 SeekBarPreference href="show_121_171.html">Android 自定义 SeekBarPreference</A> </li></UL>
  <h2><A title="SQLite" href="index_172.html">SQLite</A></h2>

  <h2><A title="SD卡" href="index_173.html">SD卡</A></h2>

  <h2><A title="数据库" href="index_174.html">数据库</A></h2>

  <h2><A title="URI" href="index_175.html">URI</A></h2>

  <h2><A title="MediaStore" href="index_176.html">MediaStore</A></h2>

</DIV></DIV>
<DIV id=maincontent>
<DIV id=w3school>
<H1></H1>
<P><STRONG></STRONG></P></DIV>

<DIV>
<H2>Android 完美解决自定义preference与ActivityGroup UI更新的问题</H2>
<div style="line-height:20px; font-size:14px;"><p>之前发过一篇有关于自定义preference在ActivityGroup的包容下出现UI不能更新的问题，当时还以为是Android的一个BUG现在想想真可笑。其实是自己对机制的理解不够深刻，看来以后要多看看源码才行。</p><p>本篇讲述内容大致为如何自定义preference 开始到与ActivityGroup 互用下UI更新的解决方法。</p><p>首先从扩展preference开始：</p><p>类文件必须继承自Preference并实现构造函数，这里我一般实现两个构造函数分别如下（类名为：test）：</p><p><pre><font class="keyword">public </font>test(Context context) {</p><p>	<font class="keyword">this</font>(context, </font><font class="keyword">null</font>);</p><p>}</p><p><font class="keyword">public </font>test(Context context, AttributeSet attrs) {</p><p>	<font class="keyword">super</font>(context, attrs);</p><p>}</p><p></pre></p><p>这里第二个构造函数第二个参数为可以使用attrs 为我们自定义的preference 添加扩展的注册属性，比如我们如果希望为扩展的preference 添加一个数组引用，就可使用如下代码：</p><p><pre><font class="keyword">int </font>resouceId = attrs.getAttributeResourceValue(</font><font class="keyword">null</font>, <font class="Fields">"Entries"</font>, 0);</p><p><font class="keyword">if </font>(resouceId &gt; 0) {</p><p>	mEntries = getContext().getResources().getTextArray(resouceId);</p><p>}</p><p></pre></p><p>这里的mEntries 是头部声明的一个数组，我们可以在xml文件通过 Entries=数组索引得到一个数组。在这里不深入为大家示范了。</p><p>我们扩展preference 有时想让其UI更丰富更好看，这里我们可以通过引用一个layout 文件为其指定UI，可以通过实现如下两个回调函数：</p><p><pre>@Override</p><p><font class="keyword">protected </font>View onCreateView(ViewGroup parent) {</p><p>	<font class="keyword">return </font>LayoutInflater.from(getContext()).inflate(</p><p>			</font>R.layout.preference_screen, parent, <font class="keyword">false</font>);</p><p>}</p><p></pre></p><p>此回调函数与onBindView 一一对应，并优先执行于onBindView ，当创建完后将得到的VIEW返回出去给onBindView处理，如下代码：</p><p><pre>@Override</p><p><font class="keyword">protected </font><font class="keyword">void </font>onBindView(View view) {</p><p>	<font class="keyword">super</font>.onBindView(view);</p><p>	canlendar = Calendar.getInstance();</p><p>	layout = (RelativeLayout) view.findViewById(R.id.area);</p><p>	title = (TextView) view.findViewById(R.id.title);</p><p>	summary = (TextView) view.findViewById(R.id.summary);</p><p>	</font>layout.setOnClickListener(<font class="keyword">this</font>);</p><p>	title.setText(getTitle());</p><p>	</font>summary.setText(getPersistedString(canlendar.get(Calendar.YEAR) + <font class="Fields">"/</p><p>			</font>+ (canlendar.get(Calendar.MONTH) + 1) + <font class="Fields">"/</p><p>			+ canlendar.get(Calendar.DAY_OF_MONTH)));</p><p>}</p><p></pre></p><p>Tip：onBindView不是必须的，可以将onBindView里的处理代码在onCreateView回调函数一并完成然后返回给onBindView，具体怎么写看自己的代码风格吧。我个人比较喜欢这种写法，比较明了。</p><p>下面我们来了解一下我扩展preference 比较常用到的几个方法：</p><p><pre>compareTo(Preference another)</p><p>与另外一个preference比较，如果相等则返回0，不相等则返回小于0的数字。</p><p>getContext()</p><p>获取上下文</p><p>getEditor()</p><p>得到一个SharePrefence 的Editor 对象</p><p>getIntent()</p><p>获取Intetn</p><p>getKey()</p><p>获取当前我们在XML为其注册的KEY</p><p>getLayoutResource()</p><p>得到当前layout 的来源</p><p>getOnPreferenceChangeListener()</p><p>值改变的监听事件</p><p>getPreferenceManager()</p><p>获得一个preference管理</p><p>getSharedPreferences()</p><p>通过获得管理获取当前的sharePreferences</p><p>getSummary()</p><p>获得当前我们在XML为其注册的备注为summary 的值。Tip：在OnBindView 或者onCreateView 找到VIEW的时候如果存在summary 的View 对象必须为其设置summary</p><p>getTitle()</p><p>如上，不过这里是获取标题</p><p></pre></p><p>callChangeListener(Object newValue)</p><p>如果你希望你扩展的Preference 可以支持当数值改变时候可以调用OnPreferenceChangeListener此监听方法，则必须调用此方法，查看该方法源码为：</p><p><pre><font class="keyword">protected </font><font class="keyword">boolean </font>callChangeListener(Object newValue) {</p><p>	<font class="keyword">return </font>mOnChangeListener == </font><font class="keyword">null</font> ? </font><font class="keyword">true</font> : mOnChangeListener.onPreferenceChange(</font><font class="keyword">this</font>, newValue);</p><p>}</p><p></pre> </p><p>源码简单不做过多介绍，只是实现一个接口。</p><p>getPersistedBoolean(boolean defaultReturnValue)</p><p>获得一个保存后的布尔值，查看一下源码：</p><p><pre><font class="keyword">protected </font><font class="keyword">boolean </font>getPersistedBoolean(</font><font class="keyword">boolean </font>defaultReturnValue) {</p><p>	<font class="keyword">if </font>(!shouldPersist()) {</p><p>		<font class="keyword">return </font>defaultReturnValue;</p><p>	}</p><p>	<font class="keyword">return </font>mPreferenceManager.getSharedPreferences().getBoolean(mKey, defaultReturnValue);</p><p>}</p><p></pre></p><p>如果你有接触过sharePreference 相信一眼就能看出这里它为我们做了什么。</p><p>getPersistedFloat(float defaultReturnValue)</p><p>如上，这里获取一个Float 的值</p><p>getPersistedInt(int defaultReturnValue)</p><p>如上，获取一个int 的值</p><p>getPersistedLong(long defaultReturnValue)</p><p>如上，获取一个Long 型数值</p><p>getPersistedString(String defaultReturnValue)</p><p>如上，获取一个String 数值</p><p>persistBoolean(boolean value)</p><p>将一个布尔值保存在sharepreference中，查看一下源码：</p><p><pre><font class="keyword">protected </font><font class="keyword">boolean </font>persistBoolean(</font><font class="keyword">boolean </font>value) {</p><p>	<font class="keyword">if </font>(shouldPersist()) {</p><p>		<font class="keyword">if </font>(value == getPersistedBoolean(!value)) {</p><p>			<font class="Comments">// It's already there, so the same as persisting</font></p><p>			<font class="keyword">return </font><font class="keyword">true</font>;</p><p>		}</p><p>		</p><p>		SharedPreferences.Editor editor = mPreferenceManager.getEditor();</p><p>		editor.putBoolean(mKey, value);</p><p>		tryCommit(editor);</p><p>		<font class="keyword">return </font><font class="keyword">true</font>;</p><p>	}</p><p>	<font class="keyword">return </font><font class="keyword">false</font>;</p><p>}</p><p></pre></p><p>都是sharePreference 的知识，这里不做过多介绍。其他的跟上面的都 一样，略过。</p><p>通过如上的一些设置，一个基本的扩展preference就己经完成，下面来讲讲如果在ActivityGroup里面让扩展的preference可以更新UI。之前农民伯伯探讨过，他建议我使用onContentChanged()方法，可以使UI更新，试了一下发现有些许问题，不过非常感谢农民伯伯。这个方法是全局刷新，则全部UI都刷新一次，但是这样不是很合理，我想了一下，那既然此方法可以更新UI那么一定可以行得通，我查看一下源码，下面把源码贴出来：</p><p><pre>@Override</p><p><font class="keyword">public </font><font class="keyword">void </font>onContentChanged() {</p><p>	<font class="keyword">super</font>.onContentChanged();</p><p>	postBindPreferences();</p><p>}</p><p><font class="Comments">/**</font></p><p> <font class="Comments">* Posts a message to bind the preferences to the list view.</font></p><p> <font class="Comments">* &lt;p&gt;</font></p><p> <font class="Comments">* Binding late is preferred as any custom preference types created in</font></p><p> <font class="Comments">* {@link onCreate(Bundle)} are able to have their views recycled.</font></p><p> <font class="Comments">*/</font></p><p><font class="keyword">private </font><font class="keyword">void </font>postBindPreferences() {</p><p>	<font class="keyword">if </font>(mHandler.hasMessages(MSG_BIND_PREFERENCES)) </font><font class="keyword">return</font>;</font></p><p>	mHandler.obtainMessage(MSG_BIND_PREFERENCES).sendToTarget();</p><p>}</p><p><font class="keyword">private </font><font class="keyword">void </font>bindPreferences() {</p><p>	<font class="keyword">final </font>PreferenceScreen preferenceScreen = getPreferenceScreen();</p><p>	<font class="keyword">if </font>(preferenceScreen != </font><font class="keyword">null</font>) {</p><p>		preferenceScreen.bind(getListView());</p><p>	}</p><p>}</p><p><font class="keyword">private </font><font class="keyword">static </font><font class="keyword">final </font><font class="keyword">int </font>MSG_BIND_PREFERENCES = 0;</p><p><font class="keyword">private </font>Handler mHandler = </font><font class="keyword">new </font>Handler() {</p><p>	@Override</p><p>	<font class="keyword">public </font><font class="keyword">void </font>handleMessage(Message msg) {</p><p>		<font class="keyword">switch </font>(msg.what) {</p><p>			</p><p>			<font class="keyword">case </font>MSG_BIND_PREFERENCES:</p><p>				bindPreferences();</p><p>				<font class="keyword">break</font>;</p><p>		}</p><p>	}</p><p>};</p><p></pre></p><p>原来，这里它是另开一条线程来更新UI，然后当值发生变化时为其发送消息，在消息队列里面处理UI，只不过它这里继承了listActivity 更新了一整个listView ，那么我们就将它提取出来，只更新我们想要的UI则可。OK，思路出来了，下面将我扩展的一个preference 的源码提供出来：</p><p><pre><font class="keyword">import </font>java.util.ArrayList;</p><p><font class="keyword">import </font>java.util.HashMap;</p><p><font class="keyword">import </font>java.util.List;</p><p><font class="keyword">import </font>android.R;</p><p><font class="keyword">import </font>android.app.Dialog;</p><p><font class="keyword">import </font>android.content.Context;</p><p><font class="keyword">import </font>android.content.DialogInterface;</p><p><font class="keyword">import </font>android.os.Handler;</p><p><font class="keyword">import </font>android.os.Message;</p><p><font class="keyword">import </font>android.preference.Preference;</p><p><font class="keyword">import </font>android.preference.PreferenceGroup;</p><p><font class="keyword">import </font>android.util.AttributeSet;</p><p><font class="keyword">import </font>android.view.LayoutInflater;</p><p><font class="keyword">import </font>android.view.View;</p><p><font class="keyword">import </font>android.view.View.OnClickListener;</p><p><font class="keyword">import </font>android.view.ViewGroup;</p><p><font class="keyword">import </font>android.widget.AdapterView;</p><p><font class="keyword">import </font>android.widget.AdapterView.OnItemClickListener;</p><p><font class="keyword">import </font>android.widget.ListView;</p><p><font class="keyword">import </font>android.widget.RelativeLayout;</p><p><font class="keyword">import </font>android.widget.SimpleAdapter;</p><p><font class="keyword">import </font>android.widget.TextView;</p><p><font class="keyword">public </font><font class="keyword">class </font>PreferenceScreenExt </font><font class="keyword">extends </font>PreferenceGroup implements</p><p>		OnItemClickListener, DialogInterface.OnDismissListener {</p><p>	<font class="keyword">private </font>Dialog dialog;</p><p>	<font class="keyword">private </font>TextView title, summary;</p><p>	<font class="keyword">private </font>RelativeLayout area;</p><p>	<font class="keyword">private </font>ListView listView;</p><p>	List&lt;Preference&gt; list;</p><p>	<font class="keyword">private </font>List&lt;HashMap&lt;String, String&gt;&gt; listStr;</p><p>	<font class="keyword">private </font>CharSequence[] mEntries;</p><p>	<font class="keyword">private </font>String mValue;</p><p>	<font class="keyword">private </font>SimpleAdapter simple;</p><p>	<font class="keyword">private </font><font class="keyword">static </font><font class="keyword">final </font><font class="keyword">int </font>MSG_BIND_PREFERENCES = 0;</p><p>	<font class="keyword">private </font>Handler mHandler = </font><font class="keyword">new </font>Handler() {</p><p>		@Override</p><p>		<font class="keyword">public </font><font class="keyword">void </font>handleMessage(Message msg) {</p><p>			<font class="keyword">switch </font>(msg.what) {</p><p></p><p>			<font class="keyword">case </font>MSG_BIND_PREFERENCES:</p><p>				setValue(mValue);</p><p>				<font class="keyword">break</font>;</p><p>			}</p><p>		}</p><p>	};</p><p>	<font class="keyword">public </font>PreferenceScreenExt(Context context, AttributeSet attrs) {</p><p>		<font class="keyword">this</font>(context, attrs, android.R.attr.preferenceScreenStyle);</p><p>	}</p><p>	<font class="keyword">public </font>PreferenceScreenExt(Context context, AttributeSet attrs, </font><font class="keyword">int </font>defStyle) {</p><p>		<font class="keyword">super</font>(context, attrs, android.R.attr.preferenceScreenStyle);</p><p>		<font class="keyword">int </font>resouceId = attrs.getAttributeResourceValue(</font><font class="keyword">null</font>, <font class="Fields">"Entries"</font>, 0);</p><p>		<font class="keyword">if </font>(resouceId &gt; 0) {</p><p>			mEntries = getContext().getResources().getTextArray(resouceId);</p><p>		}</p><p>	}</p><p>	@Override</p><p>	<font class="keyword">protected </font><font class="keyword">void </font>onBindView(View view) {</p><p>		<font class="Comments">// TODO Auto-generated method stub</font></p><p>		area = (RelativeLayout) view.findViewById(R.id.area);</p><p>		title = (TextView) view.findViewById(R.id.title);</p><p>		summary = (TextView) view.findViewById(R.id.summary);</p><p>		title.setText(getTitle());</p><p>		summary.setText(getPersistedString(getSummary().toString()));</p><p>		</font>area.setOnClickListener(<font class="keyword">new </font>OnClickListener() {</p><p>			@Override</p><p>			<font class="keyword">public </font><font class="keyword">void </font>onClick(View v) {</p><p>				showDialog();</p><p>			}</p><p>		});</p><p>	}</p><p>	@Override</p><p>	<font class="keyword">protected </font>View onCreateView(ViewGroup parent) {</p><p>		View view = LayoutInflater.from(getContext()).inflate(</p><p>				</font>R.layout.preference_screen, parent, <font class="keyword">false</font>);</p><p>		<font class="keyword">return </font>view;</p><p>	}</p><p>	<font class="keyword">public </font><font class="keyword">void </font>bindView(ListView listview) {</p><p>		<font class="keyword">int </font>length = mEntries.length;</p><p>		<font class="keyword">int </font>i = 0;</p><p>		</font>listStr = <font class="keyword">new </font>ArrayList&lt;HashMap&lt;String, String&gt;&gt;();</p><p>		<font class="keyword">for </font>(i = 0; i &lt; length; i++) {</p><p>			</font>HashMap&lt;String, String&gt; map = <font class="keyword">new </font>HashMap&lt;String, String&gt;();</p><p>			</font>map.put(<font class="Fields">"keyname"</font>, mEntries[i].toString());</p><p>			listStr.add(map);</p><p>		}</p><p>		</font>simple = <font class="keyword">new </font>SimpleAdapter(getContext(), listStr, R.layout.dialog_view,</p><p>				<font class="keyword">new </font>String[] { <font class="Fields">"keyname"</font> </font>}, </font><font class="keyword">new </font><font class="keyword">int</font>[] { R.id.text </font>});</p><p>		listview.setAdapter(simple);</p><p>		</font>listview.setOnItemClickListener(<font class="keyword">this</font>);</p><p>	}</p><p>	<font class="keyword">public </font><font class="keyword">void </font>showDialog() {</p><p>		</font>listView = <font class="keyword">new </font>ListView(getContext());</p><p>		bindView(listView);</p><p>		</font>dialog = <font class="keyword">new </font>Dialog(getContext(), android.R.style.Theme_NoTitleBar);</p><p>		dialog.setContentView(listView);</p><p>		</font>dialog.setOnDismissListener(<font class="keyword">this</font>);</p><p>		dialog.show();</p><p>	}</p><p>	@Override</p><p>	<font class="keyword">public </font><font class="keyword">void </font>onItemClick(AdapterView&lt;?&gt; parent, View view, </font><font class="keyword">int </font>position,</p><p>			<font class="keyword">long </font>id) {</p><p>		</font>mValue = listStr.get(position).get(<font class="Fields">"keyname"</font>).toString();</p><p>		persistString(mValue);</p><p>		callChangeListener(mValue);</p><p>		dialog.dismiss();</p><p>	}</p><p>	@Override</p><p>	<font class="keyword">public </font><font class="keyword">void </font>onDismiss(DialogInterface dialog) {</p><p>	}</p><p>	<font class="keyword">private </font>OnPreferenceChangeListener temp;</p><p>	<font class="keyword">public </font><font class="keyword">interface </font>OnPreferenceChangeListener {</p><p>		<font class="keyword">public </font><font class="keyword">boolean </font>onPreferenceChange(Preference preference, Object newValue);</p><p>	}</p><p>	<font class="keyword">public </font><font class="keyword">void </font>setOnPreferenceChangeListener(</p><p>			OnPreferenceChangeListener preference) {</p><p>		<font class="keyword">this</font>.temp = preference;</p><p>	}</p><p>	<font class="keyword">public </font><font class="keyword">void </font>setValue(String value) {</p><p>		summary.setText(value);</p><p>	}</p><p>	<font class="keyword">public </font><font class="keyword">boolean </font>callChangeListener(Object newValue) {</p><p>		<font class="keyword">return </font>temp == </font><font class="keyword">null</font> ? </font><font class="keyword">true</font> : temp.onPreferenceChange(</font><font class="keyword">this</font>, newValue);</p><p>	}</p><p>	<font class="keyword">public </font><font class="keyword">void </font>postBindPreferences() {</p><p>		<font class="keyword">if </font>(mHandler.hasMessages(MSG_BIND_PREFERENCES))</p><p>			<font class="keyword">return</font>;</font></p><p>		mHandler.obtainMessage(MSG_BIND_PREFERENCES).sendToTarget();</p><p>	}</p><p>}</p><p></pre></p><p>然后在preferenceActivity 界面在回调函数：onPreferenceChange调用postBindPreferences即可更新。</p><p>Tip:这里的onPreferenceChange  调用postBindPreferences 不是必须的，你同样可以在内部里面实现，通过执行某一操作发送消息也可。</p><p></p></div>

</DIV></DIV>

<DIV id=footer style="display:none">
<P align="center">  
 
 
 
    </P>
</DIV></BODY></HTML>

