
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML xmlns="http://www.w3.org/1999/xhtml">
<HEAD>
<TITLE>【Android2D游戏开发之十】详细剖析Android Traceview效率检视工具_Android学习手册</TITLE>
<META content="text/html; charset=gb2312" http-equiv=Content-Type><LINK  rel=stylesheet type=text/css href="../css/c5.css">
<META name=GENERATOR content="MSHTML 8.00.6001.18702">
<meta name="Description" content=Android基础 Android组件 Android用户界面 Android设备功能 Android数据存储 Android网络应用 Android游戏开发 Android多媒体 Android源码开发 Android高级进阶 Android面试题/>
<meta name="Keywords" content="android 学习手册">

</HEAD>
<BODY id=homesecond class=serverscripting>
<DIV id=wrapper>
<DIV id=header><h1><a href="../index.html">Android学习手册</a></h1> 
</DIV>

<DIV id=navfirst>
<div id="indexGuide"><UL><li ><A href="../basic/index.html">Android基础</A> </li><li ><A href="../component/index.html">Android组件</A> </li><li ><A href="../userinterface/index.html">用户界面</A> </li><li ><A href="../device/index.html">设备功能</A> </li><li ><A href="../datastorage/index.html">数据存储</A> </li><li ><A href="../network/index.html">网络应用</A> </li><li class="navcurrentLink"><A href="index.html">游戏开发</A> </li><li ><A href="../multimedia/index.html">多媒体</A> </li><li ><A href="../source/index.html">源码开发</A> </li><li ><A href="../advance/index.html">高级进阶</A> </li><li ><A href="../interview/index.html">Android面试题</A> </li></UL></div>
</DIV>
<DIV id=navsecond>
<DIV id=course>
<div id="kcTitle">课 程 表</div>


  <h2><A title="游戏开发须知" href="index_187.html">游戏开发须知</A></h2>

  <h2><A title="游戏策划、设计分析" href="index_188.html">游戏策划、设计分析</A></h2>

  <h2><A title="Android OpenGL学习" href="index_190.html">Android OpenGL学习</A></h2>

  <h2><A title="Android游戏开发之旅" href="index_191.html">Android游戏开发之旅</A></h2>

  <h2><A title="Android2D游戏开发" href="index_192.html">Android2D游戏开发</A></h2>
<UL><li ><A title=【Android2D游戏开发之一】设置全屏以及绘画简单的图形 href="show_501_192.html">【Android2D游戏开发之一】设置全屏以及绘画简单的图形</A> </li><li ><A title=【Android2D游戏开发之二】剖析游戏开发用view还是sarfaceView？ href="show_502_192.html">【Android2D游戏开发之二】剖析游戏开发用view还是sarfaceView？</A> </li><li ><A title=【Android2D游戏开发之三】剖析 SurfaceView ！ Callback以及SurfaceHol href="show_503_192.html">【Android2D游戏开发之三】剖析 SurfaceView ！ Callback以及SurfaceHol</A> </li><li ><A title=【Android2D游戏开发之四】Android 游戏框架（游戏角色行走demo) href="show_504_192.html">【Android2D游戏开发之四】Android 游戏框架（游戏角色行走demo)</A> </li><li ><A title=【Android2D游戏开发之五】游戏注册界面,两个Activity切换交互 href="show_505_192.html">【Android2D游戏开发之五】游戏注册界面,两个Activity切换交互</A> </li><li ><A title=【Android2D游戏开发之六】在SurfaceView中添加组件！并交互数据 href="show_506_192.html">【Android2D游戏开发之六】在SurfaceView中添加组件！并交互数据</A> </li><li ><A title=【Android2D游戏开发之七】游戏开发样式!再剖析SurfaceView组件 href="show_507_192.html">【Android2D游戏开发之七】游戏开发样式!再剖析SurfaceView组件</A> </li><li ><A title=【Android2D游戏开发之八】游戏音频 href="show_508_192.html">【Android2D游戏开发之八】游戏音频</A> </li><li ><A title=【Android2D游戏开发之九】触屏Bug解决方案及禁止横竖屏切换! href="show_509_192.html">【Android2D游戏开发之九】触屏Bug解决方案及禁止横竖屏切换!</A> </li><li class="currentLink"><A title=【Android2D游戏开发之十】详细剖析Android Traceview效率检视工具 href="show_510_192.html">【Android2D游戏开发之十】详细剖析Android Traceview效率检视工具</A> </li><li ><A title=【Android2D游戏开发十一】手把手让你爱上Android “9妹” href="show_511_192.html">【Android2D游戏开发十一】手把手让你爱上Android “9妹”</A> </li><li ><A title=【Android2D游戏开发十二】详解SharedPreference,FIle将数据存到SD卡 href="show_512_192.html">【Android2D游戏开发十二】详解SharedPreference,FIle将数据存到SD卡</A> </li><li ><A title=【Android2D游戏开发十三】详解SQLite，并把数据库文件存SD卡中-2 href="show_513_192.html">【Android2D游戏开发十三】详解SQLite，并把数据库文件存SD卡中-2</A> </li><li ><A title=【Android2D游戏开发十四】在SurfaceView中照样使用Animation(下) href="show_514_192.html">【Android2D游戏开发十四】在SurfaceView中照样使用Animation(下)</A> </li><li ><A title=【Android2D游戏开发十五】游戏触屏事件的性能优化笔记！ href="show_515_192.html">【Android2D游戏开发十五】游戏触屏事件的性能优化笔记！</A> </li><li ><A title=【Android2D游戏开发十六】详解Gesture 手势操作！实现切换图片 href="show_516_192.html">【Android2D游戏开发十六】详解Gesture 手势操作！实现切换图片</A> </li><li ><A title=【Android2D游戏开发十七】输入法手势技术,自定义手势玩游戏 href="show_517_192.html">【Android2D游戏开发十七】输入法手势技术,自定义手势玩游戏</A> </li><li ><A title=【Android2D游戏开发十八】解放手指,利用传感器开发游戏！ href="show_518_192.html">【Android2D游戏开发十八】解放手指,利用传感器开发游戏！</A> </li><li ><A title=【Android2D游戏开发十九】(必看篇)剖析Back与Home键及异常处理 href="show_519_192.html">【Android2D游戏开发十九】(必看篇)剖析Back与Home键及异常处理</A> </li><li ><A title=【Android2D游戏开发二十】物理游戏之重力系统开发 href="show_520_192.html">【Android2D游戏开发二十】物理游戏之重力系统开发</A> </li><li ><A title=【Android2D游戏开发二十一】Android设备谎言分辨率的解决方案 href="show_521_192.html">【Android2D游戏开发二十一】Android设备谎言分辨率的解决方案</A> </li><li ><A title=【Android游戏开发二十二】详解游戏中如何灵活实现动画播放! href="show_522_192.html">【Android游戏开发二十二】详解游戏中如何灵活实现动画播放!</A> </li><li ><A title=【Android游戏开发二十三】自定义【通用】ListView适配器 href="show_523_192.html">【Android游戏开发二十三】自定义【通用】ListView适配器</A> </li><li ><A title=【Android游戏开发二十四】360°平滑游戏摇杆 href="show_524_192.html">【Android游戏开发二十四】360°平滑游戏摇杆</A> </li><li ><A title=【Android游戏开发二十五】Android平台使用《贝赛尔曲线》！ href="show_525_192.html">【Android游戏开发二十五】Android平台使用《贝赛尔曲线》！</A> </li><li ><A title=【Android游戏开发二十六】追加简述SurfaceView 与 GLSurfaceView效 href="show_526_192.html">【Android游戏开发二十六】追加简述SurfaceView 与 GLSurfaceView效</A> </li></UL>
  <h2><A title="Android经典实例教程解析" href="index_193.html">Android经典实例教程解析</A></h2>

  <h2><A title="Android游戏开发实例" href="index_194.html">Android游戏开发实例</A></h2>

  <h2><A title="Libgdx游戏引擎" href="index_195.html">Libgdx游戏引擎</A></h2>

</DIV></DIV>
<DIV id=maincontent>
<DIV id=w3school>
<H1></H1>
<P><STRONG></STRONG></P></DIV>

<DIV>
<H2>【Android2D游戏开发之十】详细剖析Android Traceview效率检视工具</H2>
<div style="line-height:20px; font-size:14px;"><p>由于本人现在在一家专职做网游的公司，所以现在需要使用一些方法对现运营的网游代码进行精简和优化，那么就要使用到Android sdk中提供的一款很好的检视工具—Android TraceView、下面先给出对此的解释：然后讲解实现的详细步骤和需要特别注意的一点！</p><p style="color:#3333FF;">什么是TraceView？先看下百度出来的解释吧：</p><p>Traceview是android平台配备一个很好的性能分析的工具。它可以通过图形化的方式让我们了解我们要跟踪的程序的性能，并且能具体到method。</p><p style="color:#3333FF;">关于Traceview的使用</p><p>首先，必须在程序当中加入代码，以便生成trace文件，有了这个trace文件才可以将其转化为图形。</p><p>要添加的代码如下：</p><p><pre><font class="Comments">// start tracing to "/sdcard/yourActivityTrace.trace"</font></p><p>Debug.startMethodTracing(<font class="Fields">"yourActivityTrace"</font>);</p><p><font class="Comments">// ... <font class="Comments">// stop tracing Debug.stopMethodTracing();</font></p><p><font class="Comments">// start tracing to "/sdcard/yourActivityTrace.trace" Debug.startMethodTracing("yourActivityTrace");</font></p><p><font class="Comments">// ... <font class="Comments">// stop tracing Debug.stopMethodTracing();</font></p><p></pre></p><p>Google Dev Guide当中说可以在activity的onCreate()中添加Debug.startMethodTracing(), 而在onDestroy()中添加Debug.stopMethodTracing()，但是在实际的测试时发现这种方式其实并不好用，因为通常情况下我们的activity的onDestroy()是由系统决定何时调用的，因此可能等了很长时间都不会得到这个trace文件。因此决定在onStop()中来调用Debug.stopMethodTracing()。这样当我们切换到其它activity或者点击home键的时候onStop()就会被调用，我们也就可以得到完整的trace file。</p><p>在运行程序之前，首先要保证我们的AVD是一个带有SD card的AVD，这样才能使trace文件保存到/sdcard/...当中。运行后可以任意做一些操作，然后点击home键。这是通过DDMS file explore就可以看到/sdcard/目录下有一个trace文件，现在把这个文件copy到电脑上指定的目录，假设是C:\tracefile 目录下。</p><p>可以通过命令行来执行traceview，进入tools目录后，执行</p><p><pre>traceview C:\tracefile\yourActivityTrace.trace</p><p></pre></p><p>之后就可以看到图形了，接下来就是按照Google Dev Guide中的解释去分析图形就OK了。</p><p>下面来看如何实现以及需要注意的地方：</p><p>实现的步骤分为三步：1.必须先在我们的模拟器中创建sdCard ；2.将我们的调试代码嵌入工程；3.利用TraceView来观察和分析代码情况;</p><p style="color:#3333FF;">1.对于创建模拟器的sdCard这里写出两种方式：</p><p>第一种：我们在eclipse中创建avd的时候的时候 在选择api下面有个 Sd Card 的选项，第一项填入创建sdcard的大小即可。</p><p><img src="../img/games_2d/10_2dgames.jpg"></p><p>第二种：cmd 命令！ 打开cmd 并且cd 到android sdk tool 路径下；（或者在环境变量Path中将sdk tool路径配置上，然后重新打开cmd）</p><p>使用 mksdcard -l mycard 1024M F:\mysdcard.img 创建了一个1G的sdcard；</p><p>使用 emulator -avd my_android -sdcard F:\mysdcard.img 激活sdcard!</p><p>最后在eclipse Preferences--&gt;Android--&gt;Launch加入 -sdcard F:\mysdcard.img （此步骤就是在第一种创建方式中添加sdcard的支持）</p><p>备注1：</p><p>如果sdcard分配的空间太小，则程序追踪文件就一直记录到sd储蓄卡容量慢为止，所以调试前，要为程序生成一个适当的SD存储卡也较为重要,因为程序运行时间越长，这个追踪文件也就越大。</p><p>备注2;</p><p>(如果第二种创建方式中的第二部激活出现 emulator: ERROR: the user data image is used by another emulator. aborting，请关闭模拟器，或者进入目录： /Documents and Settings / 用户 / .android /的AVD / *设备* / (比如我的目录是：C:\Documents and Settings\Administrator\.android\avd\android2.0.avd)</p><p>然后删去以.lock结尾的文件夹就行(我简单解释下为什么要删除这些文件呢，其实.lock是加锁，如果程序崩溃等原因导致无法清除这些以.lock结尾的文件夹，就会出现这个问题，也就是这个avd的锁没有被释放，导致avd　manager以为这个avd正在使用当中。))</p><p style="color:#3333FF;">2.将我们的调试代码嵌入工程</p><p>正如我们百度到的说明一样，在程序运行的开端加上 　Debug.startMethodTracing("yourActivityTrace");  然后在onPause（）中调用Debug.stopMethodTracing(); 为什么要将结束写在onPause（）中而不写在onStop（），那么如果你去看api的话，你会看到，Api中介绍onPause（）会在你返回和点击home按键后触发，而onStop（）一般是由系统来触发，当该程序处于后台的时候，而且当内存紧张的时候，可能会调用，但是可能永远不会调用到！</p><p>备注：要记住当把调试代码加入项目中以后不要立即运行项目，而是必须在AndroidMainfest.xml中定义一条"写入SD卡的权限"那么添加权限的代码如下：</p><p>&lt;uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"&gt;&lt;/uses-permission&gt;</p><p>因为咱们的调试代码会在SD卡中生成一个追踪文件，也就是往SD卡中写入了数据，所以需要声明一条权限。这里必须注意哦！</p><p><pre>&lt;?xml version=<font class="Fields">"1.0"</font> encoding=</font><font class="Fields">"utf-8"</font>?&gt;  </p><p>&lt;manifest xmlns:android=<font class="Fields">"http:<font class="Comments">//schemas.android.com/apk/res/android"</font>  </font></p><p>      </font>package=<font class="Fields">"com.android"</font></p><p>      </font>android:versionCode=<font class="Fields">"1"</font></p><p>      </font>android:versionName=<font class="Fields">"1.0"</font>&gt;</p><p>    </font>&lt;application android:icon=<font class="Fields">"@drawable/icon"</font> android:label=</font><font class="Fields">"@string/app_name"</font>&gt;</p><p>        </font>&lt;activity android:name=<font class="Fields">".MainActivity"</font></p><p>                  </font>android:label=<font class="Fields">"@string/app_name"</font>&gt;</p><p>            &lt;intent-filter&gt;</p><p>                </font>&lt;action android:name=<font class="Fields">"android.intent.action.MAIN"</font> /&gt;</p><p>                </font>&lt;category android:name=<font class="Fields">"android.intent.category.LAUNCHER"</font> /&gt;</p><p>            &lt;/intent-filter&gt;</p><p>        &lt;/activity&gt;</p><p>    &lt;/application&gt;</p><p>    </font>&lt;uses-permission android:name=<font class="Fields">"android.permission.WRITE_EXTERNAL_STORAGE"</font>&gt;&lt;/uses-permission&gt;</p><p>    </font>&lt;uses-sdk android:minSdkVersion=<font class="Fields">"4"</font> /&gt;</p><p>&lt;/manifest&gt;  </p><p></pre></p><p style="color:#3333FF;">3.运行项目并且退出项目从而得到的追踪文件</p><p>利用TraceView来进行分析代码运行状况：打当正常运行了项目并且点击返回或者home按键就会在 sdcard中生成一个.trace的文件。sdcard 目录 在eclipse下，点击:windows-show view-other-android-File explorer</p><p><img src="../img/games_2d/10_2dgames2.jpg"></p><p>右上角的两个箭头，第一个表示从模拟器sdcard导出文件，第二个表示从PC上导入文件到sdcard中、“—”代表删除.....然后我们通过cmd来运行生成的追踪文件  traceview C:\name追踪文件所在的路径放在C盘，放在C盘以外别的盘的话我这里是无法正常打开traceview的不知道什么原因。   </p><p>name 表示生成的.trace文件，cmd的时候不需要输入“.trace”后缀 ;然后会出现TraceView的分析窗口;【cmd 命令！ 打开cmd 并且cd到android sdk tools 路径下；（或者在环境变量Path中将sdk tool路径配置上，然后重新打开cmd）】</p><p>注意1：如果出现一下图片这种内存溢出的问题;</p><p><img src="../img/games_2d/10_2dgames3.jpg"></p><p>解决方法：到SDK 下的tools 下 找到  traceview.bat 文件，鼠标右键-编辑（或者记事本打开），最后一行替换成这样：call java -Xms128m -Xmx512m -Djava.ext.dirs=%javaextdirs% -jar %jarpath% %*注意2：如果出现路径不对的问题：例如：我的android.trace放在了C盘,那么我的cmd命令是:traceview c:\android然后回车！但是这里要小心，因为\h这样可能被认为是转义字符！！！为了避免可以尽可能不要使用h,n,r,t,等等成为名字的头字母，当然还有一种就可以完全避免这种问题，例如还是我的C盘 android.trace 文件，可以写cmd命令的时候写成：traceview c://android 要注意细节。 </p><p>下面是运行起来的TranceView：</p><p><img src="../img/games_2d/10_2dgames4.jpg"></p><p>最右上角表示运行程序总共用了多少时间，从traceview画面中我们看到有各种颜色，每种颜色代表不同的函数和步骤，那么同一颜色的区域越大，就代表这个步骤运行时间越长，或者看到下面的统计表，明显可以看出除了序列 0 1 是系统函数外，2. 3.函数 占用的时间比较长，那么序列4是个自定义的函数名为 “hot”这个占用了几乎与主线程 主draw的时间一样了，那么肯定有问题。当然其实这个方法是我故意写的，就是为了来演示traceview。这个hot函数的代码如下：</p><p><pre><font class="Comments">/** </font></p><p><font class="Comments">* @author android </font></p><p><font class="Comments">* @param canvas </font></p><p><font class="Comments">*/  </font></p><p><font class="keyword">public </font><font class="keyword">void </font>hot(Canvas canvas) {  </p><p>	<font class="keyword">for </font>(</font><font class="keyword">int </font>i = 1; i &lt; 100; i++) {  </p><p>		Bitmap bmp = BitmapFactory.decodeResource(getResources(),</p><p>				R.drawable.icon);</p><p>		</font>canvas.drawBitmap(bmp, i += 2, i += 2, pa<font class="keyword">int</font>);</p><p>	}  </p><p>}</p><p></pre></p><p>很明显我在故意消耗内存和时间。那么，在traceview的右半部统计字段中:Exclusive:同级函数本身运行的时间Inclusive就是说除统计函数本身运行的时间外再加上调用子函数所运行的时间Name：列出的是所有的调用项，前面的数字是编号，展开可以看到有的有Parent和Children子项，就是指被调用和调用。</p><p><pre>Incl: inclusive时间占总时间的白分比</p><p>Excl: 执行占总时间的白分比。</p><p>Calls+Recur Calls/Total: 调用和重复调用的次数</p><p>Time/Call: 总的时间。(ms)</p><p></pre></p><p>所以traceview是个非常好的程序监视工具，可以帮助找出程序运行缓慢时的函数，让我们的代码不断完善和改进！</p><p></p></div>

</DIV></DIV>

<DIV id=footer style="display:none">
<P align="center">  
 
 
 
    </P>
</DIV></BODY></HTML>

