
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML xmlns="http://www.w3.org/1999/xhtml">
<HEAD>
<TITLE>Android中发送Http请求实例（包括文件上传、servlet接收）_Android学习手册</TITLE>
<META content="text/html; charset=gb2312" http-equiv=Content-Type><LINK  rel=stylesheet type=text/css href="../css/c5.css">
<META name=GENERATOR content="MSHTML 8.00.6001.18702">
<meta name="Description" content=Android基础 Android组件 Android用户界面 Android设备功能 Android数据存储 Android网络应用 Android游戏开发 Android多媒体 Android源码开发 Android高级进阶 Android面试题/>
<meta name="Keywords" content="android 学习手册">

</HEAD>
<BODY id=homesecond class=serverscripting>
<DIV id=wrapper>
<DIV id=header><h1><a href="../index.html">Android学习手册</a></h1> 
</DIV>

<DIV id=navfirst>
<div id="indexGuide"><UL><li ><A href="../basic/index.html">Android基础</A> </li><li ><A href="../component/index.html">Android组件</A> </li><li ><A href="../userinterface/index.html">用户界面</A> </li><li ><A href="../device/index.html">设备功能</A> </li><li ><A href="../datastorage/index.html">数据存储</A> </li><li class="navcurrentLink"><A href="index.html">网络应用</A> </li><li ><A href="../game/index.html">游戏开发</A> </li><li ><A href="../multimedia/index.html">多媒体</A> </li><li ><A href="../source/index.html">源码开发</A> </li><li ><A href="../advance/index.html">高级进阶</A> </li><li ><A href="../interview/index.html">Android面试题</A> </li></UL></div>
</DIV>
<DIV id=navsecond>
<DIV id=course>
<div id="kcTitle">课 程 表</div>


  <h2><A title="3G" href="index_177.html">3G</A></h2>

  <h2><A title="WIFI" href="index_178.html">WIFI</A></h2>

  <h2><A title="蓝牙" href="index_179.html">蓝牙</A></h2>

  <h2><A title="HTTP协议" href="index_180.html">HTTP协议</A></h2>
<UL><li ><A title=网络开发必备的HTTP协议知识 href="show_301_180.html">网络开发必备的HTTP协议知识</A> </li><li ><A title=Android通过http协议数据交互 href="show_302_180.html">Android通过http协议数据交互</A> </li><li ><A title=Android通过https协议与服务器端进行通信 href="show_303_180.html">Android通过https协议与服务器端进行通信</A> </li><li ><A title=Android HTTP服务实例（一） href="show_304_180.html">Android HTTP服务实例（一）</A> </li><li ><A title=Android HTTP服务实例（二） href="show_305_180.html">Android HTTP服务实例（二）</A> </li><li ><A title=Android HTTP服务实例（三） href="show_306_180.html">Android HTTP服务实例（三）</A> </li><li ><A title=Android中HTTP通信和XML解析 href="show_307_180.html">Android中HTTP通信和XML解析</A> </li><li ><A title=关于HTTP协议中的KeepAlive属性 href="show_308_180.html">关于HTTP协议中的KeepAlive属性</A> </li><li ><A title=Android Http下载文件到手机内存与SDCard href="show_309_180.html">Android Http下载文件到手机内存与SDCard</A> </li><li class="currentLink"><A title=Android中发送Http请求实例（包括文件上传、servlet接收） href="show_310_180.html">Android中发送Http请求实例（包括文件上传、servlet接收）</A> </li><li ><A title=Android使用http协议上传文件 href="show_311_180.html">Android使用http协议上传文件</A> </li><li ><A title=关于Android Http访问,上传 href="show_312_180.html">关于Android Http访问,上传</A> </li><li ><A title=在Android中发送HTTP POST请求示范 href="show_313_180.html">在Android中发送HTTP POST请求示范</A> </li></UL>
  <h2><A title="Socket" href="index_181.html">Socket</A></h2>

  <h2><A title="HTML与HTML5" href="index_182.html">HTML与HTML5</A></h2>

  <h2><A title="JavaScript" href="index_183.html">JavaScript</A></h2>

  <h2><A title="Email" href="index_184.html">Email</A></h2>

  <h2><A title="NFC" href="index_185.html">NFC</A></h2>

  <h2><A title="Web Service" href="index_186.html">Web Service</A></h2>

</DIV></DIV>
<DIV id=maincontent>
<DIV id=w3school>
<H1></H1>
<P><STRONG></STRONG></P></DIV>

<DIV>
<H2>Android中发送Http请求实例（包括文件上传、servlet接收）</H2>
<div style="line-height:20px; font-size:14px;"><p>前天开始要准备实现手机端往服务器传参数，还要能传附件，找了不少文章和资料，现在总结一下分享分享：代码中的catch什么的就省略了，尝试了图片、txt、xml是没问题的.. 各位尽情拍砖吧。</p><p>发完发现代码部分的格式……这个编辑器不太会用，怎么感觉把换行都去掉了,处理好换行缩进也……</p><p>首先我是写了个java工程测试发送post请求：可以包含文本参数和文件参数</p><p><pre><font class="Comments">/**</font></p><p> <font class="Comments">* 通过http协议提交数据到服务端，实现表单提交功能，包括上传文件</font></p><p> <font class="Comments">* @param actionUrl</font></p><p> <font class="Comments">*            上传路径</font></p><p> <font class="Comments">* @param params</font></p><p> <font class="Comments">*            请求参数 key为参数名,value为参数值</font></p><p> <font class="Comments">* @param file</font></p><p> <font class="Comments">*            上传文件</font></p><p> <font class="Comments">*/</font></p><p><font class="keyword">public </font><font class="keyword">static </font><font class="keyword">void </font>postMultiParams(String actionUrl,</p><p>		Map&lt;String, String&gt; params, FormBean[] files) {</p><p>	<font class="keyword">try </font>{</p><p>		</font>PostMethod post = <font class="keyword">new </font>PostMethod(actionUrl);</p><p>		</font>List&lt;art&gt; formParams = <font class="keyword">new </font>ArrayList&lt;art&gt;();</p><p>		<font class="keyword">for </font>(Map.Entry&lt;String, String&gt; en</font><font class="keyword">try </font>: params.entrySet()) {</p><p>			</font>formParams.add(<font class="keyword">new </font>StringPart(entry.getKey(), entry.getValue()));</p><p>		}</p><p>		<font class="keyword">if </font>(files != </font><font class="keyword">null</font>)</p><p>			<font class="keyword">for </font>(FormBean file : files) {</p><p>				<font class="Comments">// filename为在服务端接收时希望保存成的文件名，filepath是本地文件路径(包括了源文件名)，filebean中就包含了这俩属性</font></p><p>				</font>formParams.add(<font class="keyword">new </font>FilePart(<font class="Fields">"file"</font>, file.getFilename(),</p><p>						<font class="keyword">new </font>File(file.getFilepath())));</p><p>			}</p><p>		</font>Part[] parts = <font class="keyword">new </font>Part[formParams.size()];</p><p>		Iterator&lt;art&gt; pit = formParams.iterator();</p><p>		<font class="keyword">int </font>i = 0;</p><p></p><p>		<font class="keyword">while </font>(pit.hasNext()) {</p><p>			parts[i++] = pit.next();</p><p>		}</p><p>		<font class="Comments">// 如果出现乱码可以尝试一下方式</font></p><p>		<font class="Comments">// StringPart sp = new StringPart("TEXT", "testValue", "GB2312");</font></p><p>		<font class="Comments">// FilePart fp = new FilePart("file", "test.txt", new</font></p><p>		<font class="Comments">// File("./temp/test.txt"), null, "GB2312"</font></p><p>		<font class="Comments">// postMethod.getParams().setContentCharset("GB2312");</font></p><p>		</font>MultipartRequestEntity mrp = <font class="keyword">new </font>MultipartRequestEntity(parts,</p><p>				post.getParams());</p><p>		post.setRequestEntity(mrp);</p><p>		<font class="Comments">// execute post method</font></p><p>		</font>HttpClient client = <font class="keyword">new </font>HttpClient();</p><p>		<font class="keyword">int </font>code = client.executeMethod(post);</p><p>		</font>System.<font class="Fields">out</font>.println(code);</p><p>	</font>} <font class="keyword">catch </font>(Exception e) {</p><p>	}</p><p>}</p><p></pre></p><p>通过以上代码可以成功的模拟java客户端发送post请求，服务端也能接收并保存文件</p><p>java端测试的main方法：</p><p><pre><font class="keyword">public </font><font class="keyword">static </font><font class="keyword">void </font>main(String[] args) {</p><p>	</font>String actionUrl = <font class="Fields">"http:<font class="Comments">//192.168.0.123:8080/WSserver/androidUploadServlet"</font>;</font></p><p>	</font>Map&lt;String, String&gt; strParams = <font class="keyword">new </font>HashMap&lt;String, String&gt;();</p><p>	</font>strParams.put(<font class="Fields">"paramOne"</font>, </font><font class="Fields">"valueOne"</font>);</p><p>	</font>strParams.put(<font class="Fields">"paramTwo"</font>, </font><font class="Fields">"valueTwo"</font>);</p><p>	</font>FormBean[] files = <font class="keyword">new </font>FormBean[] { </font><font class="keyword">new </font>FormBean(<font class="Fields">"dest1.xml"</font>,</p><p>			<font class="Fields">"F:/testpostsrc/main.xml"</font>) </font>};</p><p>	HttpTool.postMultiParams(actionUrl, strParams, files);</p><p>}</p><p></pre></p><p>本以为大功告成了，结果一移植到android工程中，编译是没有问题的。</p><p>但是运行时抛了异常 先是说找不到PostMethod类，org.apache.commons.httpclient.methods.PostMethod这个类绝对是有包含的；</p><p>还有个异常就是VerifyError。 开发中有几次碰到这个异常都束手无策，觉得是SDK不兼容还是怎么地，哪位知道可得跟我说说～～</p><p>于是看网上有直接分析http request的内容构建post请求的，也有找到带上传文件的，拿下来运行老是有些问题，便直接通过运行上面的java工程发送的post请求，在servlet中打印出请求内容，然后对照着拼接字符串和流终于给实现了！代码如下：</p><p><pre><font class="Comments">/**</font></p><p> <font class="Comments">* 通过拼接的方式构造请求内容，实现参数传输以及文件传输</font></p><p> <font class="Comments">* @param actionUrl</font></p><p> <font class="Comments">* @param params</font></p><p> <font class="Comments">* @param files</font></p><p> <font class="Comments">* @return</font></p><p> <font class="Comments">* @throws IOException</font></p><p> <font class="Comments">*/</font></p><p><font class="keyword">public </font><font class="keyword">static </font>String post(String actionUrl, Map&lt;String, String&gt; params,</p><p>		</font>Map&lt;String, File&gt; files) <font class="keyword">throws </font>IOException {</p><p>	String BOUNDARY = java.util.UUID.randomUUID().toString();</p><p>	</font>String PREFIX = <font class="Fields">"--"</font>, LINEND = </font><font class="Fields">"\r\n"</font>;</p><p>	</font>String MULTIPART_FROM_DATA = <font class="Fields">"multipart/form-data"</font>;</p><p>	</font>String CHARSET = <font class="Fields">"UTF-8"</font>;</p><p>	</font>URL uri = <font class="keyword">new </font>URL(actionUrl);</p><p>	HttpURLConnection conn = (HttpURLConnection) uri.openConnection();</p><p>	conn.setReadTimeout(5 * 1000); <font class="Comments">// 缓存的最长时间</font></p><p>	</font>conn.setDoInput(<font class="keyword">true</font>);<font class="Comments">// 允许输入</font></p><p>	</font>conn.setDoOutput(<font class="keyword">true</font>);<font class="Comments">// 允许输出</font></p><p>	</font>conn.setUseCaches(<font class="keyword">false</font>); <font class="Comments">// 不允许使用缓存</font></p><p>	</font>conn.setRequestMethod(<font class="Fields">"POST"</font>);</p><p>	</font>conn.setRequestProperty(<font class="Fields">"connection"</font>, </font><font class="Fields">"keep-alive"</font>);</p><p>	</font>conn.setRequestProperty(<font class="Fields">"Charsert"</font>, </font><font class="Fields">"UTF-8"</font>);</p><p>	</font>conn.setRequestProperty(<font class="Fields">"Content-Type"</font>, MULTIPART_FROM_DATA</p><p>			</font>+ <font class="Fields">";boundary="</font> + BOUNDARY);</p><p>	<font class="Comments">// 首先组拼文本类型的参数</font></p><p>	</font>StringBuilder sb = <font class="keyword">new </font>StringBuilder();</p><p>	<font class="keyword">for </font>(Map.Entry&lt;String, String&gt; en</font><font class="keyword">try </font>: params.entrySet()) {</p><p>		sb.append(PREFIX);</p><p>		sb.append(BOUNDARY);</p><p>		sb.append(LINEND);</p><p>		</font>sb.append(<font class="Fields">"Content-Disposition: form-data; name=\</p><p>				</font>+ entry.getKey() + <font class="Fields">"\"</font></font><font class="Fields">" + LINEND);</p><p>		</font>sb.append(<font class="Fields">"Content-Type: text/plain; charset="</font> + CHARSET + LINEND);</p><p>		</font>sb.append(<font class="Fields">"Content-Transfer-Encoding: 8bit"</font> + LINEND);</p><p>		sb.append(LINEND);</p><p>		sb.append(entry.getValue());</p><p>		sb.append(LINEND);</p><p>	}</p><p>	</font>DataOutputStream outStream = <font class="keyword">new </font>DataOutputStream(</p><p>			conn.getOutputStream());</p><p>	outStream.write(sb.toString().getBytes());</p><p>	<font class="Comments">// 发送文件数据</font></p><p>	<font class="keyword">if </font>(files != </font><font class="keyword">null</font>)</p><p>		<font class="keyword">for </font>(Map.Entry&lt;String, File&gt; file : files.entrySet()) {</p><p>			</font>StringBuilder sb1 = <font class="keyword">new </font>StringBuilder();</p><p>			sb1.append(PREFIX);</p><p>			sb1.append(BOUNDARY);</p><p>			sb1.append(LINEND);</p><p>			</font>sb1.append(<font class="Fields">"Content-Disposition: form-data; name=\"</font>file\</font><font class="Fields">"; filename=\</p><p>					</font>+ file.getKey() + <font class="Fields">"\"</font></font><font class="Fields">" + LINEND);</p><p>			</font>sb1.append(<font class="Fields">"Content-Type: application/octet-stream; charset=</p><p>					+ CHARSET + LINEND);</p><p>			sb1.append(LINEND);</p><p>			outStream.write(sb1.toString().getBytes());</p><p>			</font>InputStream is = <font class="keyword">new </font>FileInputStream(file.getValue());</p><p>			</font>byte[] buffer = <font class="keyword">new </font>byte[1024];</p><p>			<font class="keyword">int </font>len = 0;</p><p>			<font class="keyword">while </font>((len = is.read(buffer)) != -1) {</p><p>				outStream.write(buffer, 0, len);</p><p>			}</p><p>			is.close();</p><p>			outStream.write(LINEND.getBytes());</p><p>		}</p><p>	<font class="Comments">// 请求结束标志</font></p><p>	byte[] end_data = (PREFIX + BOUNDARY + PREFIX + LINEND).getBytes();</p><p>	outStream.write(end_data);</p><p>	outStream.flush();</p><p>	<font class="Comments">// 得到响应码</font></p><p>	<font class="keyword">int </font>res = conn.getResponseCode();</p><p>	<font class="keyword">if </font>(res == 200) {</p><p>		InputStream in = conn.getInputStream();</p><p>		<font class="keyword">int </font>ch;</p><p>		</font>StringBuilder sb2 = <font class="keyword">new </font>StringBuilder();</p><p>		<font class="keyword">while </font>((ch = in.read()) != -1) {</p><p>			sb2.append((char) ch);</p><p>		}</p><p>	}</p><p>	outStream.close();</p><p>	conn.disconnect();</p><p>	<font class="keyword">return </font>in.toString();</p><p>}</p><p></pre></p><p>**********************</p><p>button响应中的代码：</p><p>**********************</p><p><pre><font class="keyword">public </font><font class="keyword">void </font>onClick(View v) {</p><p>	String actionUrl = getApplicationContext().getString(</p><p>			R.string.wtsb_req_upload);</p><p>	</font>Map&lt;String, String&gt; params = <font class="keyword">new </font>HashMap&lt;String, String&gt;();</p><p>	</font>params.put(<font class="Fields">"strParamName"</font>, </font><font class="Fields">"strParamValue"</font>);</p><p>	</font>Map&lt;String, File&gt; files = <font class="keyword">new </font>HashMap&lt;String, File&gt;();</p><p>	</font>files.put(<font class="Fields">"tempAndroid.txt"</font>, <font class="keyword">new </font>File(</font><font class="Fields">"/sdcard/temp.txt"</font>));</p><p>	<font class="keyword">try </font>{</p><p>		HttpTool.postMultiParams(actionUrl, params, files);</p><p>	</font>} <font class="keyword">catch </font>(Exception e) {</p><p>	}</p><p>}</p><p></pre></p><p>***************************</p><p>服务器端servlet代码：</p><p>***************************</p><p><pre><font class="keyword">public </font><font class="keyword">void </font>doPost(HttpServletRequest request, HttpServletResponse response)</p><p>			<font class="keyword">throws </font>ServletException, IOException {</p><p>	<font class="Comments">// print request.getInputStream to check request content</font></p><p>	<font class="Comments">// HttpTool.printStreamContent(request.getInputStream());</font></p><p>	</font>RequestContext req = <font class="keyword">new </font>ServletRequestContext(request);</p><p>	<font class="keyword">if </font>(FileUpload.isMultipartContent(req)) {</p><p>		</font>DiskFileItemFactory factory = <font class="keyword">new </font>DiskFileItemFactory();</p><p>		</font>ServletFileUpload fileUpload = <font class="keyword">new </font>ServletFileUpload(factory);</p><p>		fileUpload.setFileSizeMax(FILE_MAX_SIZE);</p><p>		</font>List items = <font class="keyword">new </font>ArrayList();</p><p>		<font class="keyword">try </font>{</p><p>			items = fileUpload.parseRequest(request);</p><p>		</font>} <font class="keyword">catch </font>(Exception e) {</p><p>		}</p><p>		Iterator it = items.iterator();</p><p>		<font class="keyword">while </font>(it.hasNext()) {</p><p>			FileItem fileItem = (FileItem) it.next();</p><p>			<font class="keyword">if </font>(fileItem.isFormField()) {</p><p>				</font>System.<font class="Fields">out</font>.println(fileItem.getFieldName()</p><p>						</font>+ <font class="Fields">"</p><p>						+ fileItem.getName()</p><p>						</font>+ <font class="Fields">"</p><p>						</font>+ <font class="keyword">new </font>String(fileItem.getString().getBytes(</p><p>								<font class="Fields">"ISO-8859-1"</font>), </font><font class="Fields">"GBK"</font>));</p><p>			</font>} <font class="keyword">else </font>{</p><p>				</font>System.<font class="Fields">out</font>.println(fileItem.getFieldName() + </font><font class="Fields">" </p><p>						</font>+ fileItem.getName() + <font class="Fields">" "</font> + fileItem.isInMemory()</p><p>						</font>+ <font class="Fields">" "</font> + fileItem.getContentType() + </font><font class="Fields">"</p><p>						+ fileItem.getSize());</p><p>				<font class="keyword">if </font>(fileItem.getName() != </font><font class="keyword">null</font> && fileItem.getSize() != 0) {</p><p>					</font>File fullFile = <font class="keyword">new </font>File(fileItem.getName());</p><p>					</font>File newFile = <font class="keyword">new </font>File(FILE_SAVE_PATH</p><p>							+ fullFile.getName());</p><p>					<font class="keyword">try </font>{</p><p>						fileItem.write(newFile);</p><p>					</font>} <font class="keyword">catch </font>(Exception e) {</p><p>					}</p><p>				}</p><p>			}</p><p>		}</p><p>	}</p><p>}</p><p><font class="keyword">public </font><font class="keyword">void </font>init() </font><font class="keyword">throws </font>ServletException {</p><p>	<font class="Comments">// 读取在web.xml中配置的init-param</font></p><p>	</font>FILE_MAX_SIZE = Long.parseLong(<font class="keyword">this</font>.getInitParameter(<font class="Fields">"file_max_size"</font>));<font class="Comments">// 上传文件大小限制</font></p><p>	</font>FILE_SAVE_PATH = <font class="keyword">this</font>.getInitParameter(<font class="Fields">"file_save_path"</font>);<font class="Comments">// 文件保存位置</font></p><p>}</p><p></pre></p><p></p></div>

</DIV></DIV>

<DIV id=footer style="display:none">
<P align="center">  
 
 
 
    </P>
</DIV></BODY></HTML>

