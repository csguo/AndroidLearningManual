
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML xmlns="http://www.w3.org/1999/xhtml">
<HEAD>
<TITLE>Socket编程(多线程、双向通信)_Android学习手册</TITLE>
<META content="text/html; charset=gb2312" http-equiv=Content-Type><LINK  rel=stylesheet type=text/css href="../css/c5.css">
<META name=GENERATOR content="MSHTML 8.00.6001.18702">
<meta name="Description" content=Android基础 Android组件 Android用户界面 Android设备功能 Android数据存储 Android网络应用 Android游戏开发 Android多媒体 Android源码开发 Android高级进阶 Android面试题/>
<meta name="Keywords" content="android 学习手册">

</HEAD>
<BODY id=homesecond class=serverscripting>
<DIV id=wrapper>
<DIV id=header><h1><a href="../index.html">Android学习手册</a></h1> 
</DIV>

<DIV id=navfirst>
<div id="indexGuide"><UL><li ><A href="../basic/index.html">Android基础</A> </li><li ><A href="../component/index.html">Android组件</A> </li><li ><A href="../userinterface/index.html">用户界面</A> </li><li ><A href="../device/index.html">设备功能</A> </li><li ><A href="../datastorage/index.html">数据存储</A> </li><li class="navcurrentLink"><A href="index.html">网络应用</A> </li><li ><A href="../game/index.html">游戏开发</A> </li><li ><A href="../multimedia/index.html">多媒体</A> </li><li ><A href="../source/index.html">源码开发</A> </li><li ><A href="../advance/index.html">高级进阶</A> </li><li ><A href="../interview/index.html">Android面试题</A> </li></UL></div>
</DIV>
<DIV id=navsecond>
<DIV id=course>
<div id="kcTitle">课 程 表</div>


  <h2><A title="3G" href="index_177.html">3G</A></h2>

  <h2><A title="WIFI" href="index_178.html">WIFI</A></h2>

  <h2><A title="蓝牙" href="index_179.html">蓝牙</A></h2>

  <h2><A title="HTTP协议" href="index_180.html">HTTP协议</A></h2>

  <h2><A title="Socket" href="index_181.html">Socket</A></h2>
<UL><li ><A title=Android 浅谈Socket（一） href="show_401_181.html">Android 浅谈Socket（一）</A> </li><li ><A title=Android 浅谈Socket（二） href="show_402_181.html">Android 浅谈Socket（二）</A> </li><li class="currentLink"><A title=Socket编程(多线程、双向通信) href="show_403_181.html">Socket编程(多线程、双向通信)</A> </li><li ><A title=Android开发之socket通信向PC机发信息获取本机IP href="show_404_181.html">Android开发之socket通信向PC机发信息获取本机IP</A> </li><li ><A title=Http和Socket区别 href="show_405_181.html">Http和Socket区别</A> </li><li ><A title=PC客户端与Android服务端的Socket同步通信（一） href="show_406_181.html">PC客户端与Android服务端的Socket同步通信（一）</A> </li><li ><A title=PC客户端与Android服务端的Socket同步通信（二） href="show_407_181.html">PC客户端与Android服务端的Socket同步通信（二）</A> </li><li ><A title=PC客户端与Android服务端的Socket同步通信（三） href="show_408_181.html">PC客户端与Android服务端的Socket同步通信（三）</A> </li><li ><A title=Android解析socket流 href="show_409_181.html">Android解析socket流</A> </li><li ><A title=Android 实例Socket发送Http请求 href="show_410_181.html">Android 实例Socket发送Http请求</A> </li><li ><A title=Android socket和seversocket的用法 href="show_411_181.html">Android socket和seversocket的用法</A> </li><li ><A title=Android与PC的socket通信 href="show_412_181.html">Android与PC的socket通信</A> </li><li ><A title=测试Android作为客户端使用socket网络编程连接到数据库 href="show_413_181.html">测试Android作为客户端使用socket网络编程连接到数据库</A> </li></UL>
  <h2><A title="HTML与HTML5" href="index_182.html">HTML与HTML5</A></h2>

  <h2><A title="JavaScript" href="index_183.html">JavaScript</A></h2>

  <h2><A title="Email" href="index_184.html">Email</A></h2>

  <h2><A title="NFC" href="index_185.html">NFC</A></h2>

  <h2><A title="Web Service" href="index_186.html">Web Service</A></h2>

</DIV></DIV>
<DIV id=maincontent>
<DIV id=w3school>
<H1></H1>
<P><STRONG></STRONG></P></DIV>

<DIV>
<H2>Socket编程(多线程、双向通信)</H2>
<div style="line-height:20px; font-size:14px;"><p style="color:#3333FF;">一、概述</p><p>网络通信无论在手机还是其他设备上都应用得非常广泛，因此掌握网络编程是非常有必要的，而我觉得socket编程是网络编程的基础。在进入正题之前，先介绍几点网络知识，一：socket编程有分TCP和UDP两种，TCP是基于连接的，而UDP是无连接的；二：一个TCP连接包括了输入和输出两条独立的路径；三：服务器必须先运行然后客户端才能与它进行通信。四：客户端与服务器所使用的编码方式要相同，否则会出现乱码。</p><p>加入了多线程，这样UI线程就不会被阻塞；实现了客户端和服务器的双向通信，只要客户端发起了连接并成功连接后那么两者就可以随意进行通信了。</p><p style="color:#3333FF;">二、实现</p><p>新建MyClient工程，修改main.xml文件，如下：</p><p><pre>&lt;?xml version=<font class="Fields">"1.0"</font> encoding=</font><font class="Fields">"utf-8"</font>?&gt;</p><p>&lt;LinearLayout xmlns:android=<font class="Fields">"http:<font class="Comments">//schemas.android.com/apk/res/android</font></p><p>    </font>android:layout_width=<font class="Fields">"fill_parent</p><p>    </font>android:layout_height=<font class="Fields">"fill_parent</p><p>    </font>android:orientation=<font class="Fields">"vertical"</font> &gt;</p><p>    &lt;EditText</p><p>        </font>android:id=<font class="Fields">"@+id/edittext</p><p>        </font>android:layout_width=<font class="Fields">"fill_parent</p><p>        </font>android:layout_height=<font class="Fields">"wrap_content</p><p>        </font>android:hint=<font class="Fields">"请输入要发送的内容"</font> /&gt;</p><p>    &lt;Button</p><p>        </font>android:id=<font class="Fields">"@+id/connectbutton</p><p>        </font>android:layout_width=<font class="Fields">"fill_parent</p><p>        </font>android:layout_height=<font class="Fields">"wrap_content</p><p>        </font>android:text=<font class="Fields">"连接"</font> /&gt;</p><p>    &lt;Button</p><p>        </font>android:id=<font class="Fields">"@+id/sendbutton</p><p>        </font>android:layout_width=<font class="Fields">"fill_parent</p><p>        </font>android:layout_height=<font class="Fields">"wrap_content</p><p>        </font>android:text=<font class="Fields">"发送"</font> /&gt;</p><p>&lt;/LinearLayout&gt;</p><p></pre></p><p>接着，修改MyclientActivity.java文件，主要是定义了一个继承自Thread类的用于接收数据的类，覆写了其中的run（）方法，在这个函数里面接收数据，接收到数据后就通过Handler发送消息，收到消息后在UI线程里更新接收到的数据。完整的内容如下：</p><p><pre><font class="keyword">import </font>java.io.IOException;</p><p><font class="keyword">import </font>java.io.InputStream;</p><p><font class="keyword">import </font>java.io.OutputStream;</p><p><font class="keyword">import </font>java.io.UnsupportedEncodingException;</p><p><font class="keyword">import </font>java.net.Socket;</p><p><font class="keyword">import </font>java.net.UnknownHostException;</p><p><font class="keyword">import </font>android.app.Activity;</p><p><font class="keyword">import </font>android.os.Bundle;</p><p><font class="keyword">import </font>android.os.Handler;</p><p><font class="keyword">import </font>android.os.Message;</p><p><font class="keyword">import </font>android.view.View;</p><p><font class="keyword">import </font>android.widget.Button;</p><p><font class="keyword">import </font>android.widget.EditText;</p><p><font class="keyword">import </font>android.widget.TextView;</p><p><font class="keyword">import </font>android.widget.Toast;</p><p><font class="keyword">public </font><font class="keyword">class </font>MyClientActivity </font><font class="keyword">extends </font>Activity {</p><p>	<font class="keyword">private </font>EditText mEditText = </font><font class="keyword">null</font>;</p><p>	<font class="keyword">private </font>Button connectButton = </font><font class="keyword">null</font>;</p><p>	<font class="keyword">private </font>Button sendButton = </font><font class="keyword">null</font>;</p><p>	<font class="keyword">private </font>TextView mTextView = </font><font class="keyword">null</font>;</p><p>	<font class="keyword">private </font>Socket clientSocket = </font><font class="keyword">null</font>;</p><p>	<font class="keyword">private </font>OutputStream outStream = </font><font class="keyword">null</font>;</p><p>	<font class="keyword">private </font>Handler mHandler = </font><font class="keyword">null</font>;</p><p>	<font class="keyword">private </font>ReceiveThread mReceiveThread = </font><font class="keyword">null</font>;</p><p>	<font class="keyword">private </font><font class="keyword">boolean </font>stop = </font><font class="keyword">true</font>;</p><p>	@Override</p><p>	<font class="keyword">public </font><font class="keyword">void </font>onCreate(Bundle savedInstanceState) {</p><p>		<font class="keyword">super</font>.onCreate(savedInstanceState);</p><p>		setContentView(R.layout.main);</p><p>		</font>mEditText = (EditText) <font class="keyword">this</font>.findViewById(R.id.edittext);</p><p>		</font>mTextView = (TextView) <font class="keyword">this</font>.findViewById(R.id.retextview);</p><p>		</font>connectButton = (Button) <font class="keyword">this</font>.findViewById(R.id.connectbutton);</p><p>		</font>sendButton = (Button) <font class="keyword">this</font>.findViewById(R.id.sendbutton);</p><p>		</font>sendButton.setEnabled(<font class="keyword">false</font>);</p><p>		<font class="Comments">// 连接按钮监听</font></p><p>		</font>connectButton.setOnClickListener(<font class="keyword">new </font>View.OnClickListener() {</p><p>			@Override</p><p>			<font class="keyword">public </font><font class="keyword">void </font>onClick(View v) {</p><p>				<font class="keyword">try </font>{</p><p>					<font class="Comments">// 实例化对象并连接到服务器</font></p><p>					</font>clientSocket = <font class="keyword">new </font>Socket(<font class="Fields">"113.114.170.246"</font>, 8888);</p><p>				</font>} <font class="keyword">catch </font>(UnknownHostException e) {</p><p>					e.printStackTrace();</p><p>				</font>} <font class="keyword">catch </font>(IOException e) {</p><p>					e.printStackTrace();</p><p>				}</p><p>				</font>displayToast(<font class="Fields">"连接成功！"</font>);</p><p>				<font class="Comments">// 连接按钮使能</font></p><p>				</font>connectButton.setEnabled(<font class="keyword">false</font>);</p><p>				<font class="Comments">// 发送按钮使能</font></p><p>				</font>sendButton.setEnabled(<font class="keyword">true</font>);</p><p>				</font>mReceiveThread = <font class="keyword">new </font>ReceiveThread(clientSocket);</p><p>				</font>stop = <font class="keyword">false</font>;</p><p>				<font class="Comments">// 开启线程</font></p><p>				mReceiveThread.start();</p><p>			}</p><p>		});</p><p>		<font class="Comments">// 发送数据按钮监听</font></p><p>		</font>sendButton.setOnClickListener(<font class="keyword">new </font>View.OnClickListener() {</p><p>			@Override</p><p>			<font class="keyword">public </font><font class="keyword">void </font>onClick(View v) {</p><p>				</font>byte[] msgBuffer = <font class="keyword">null</font>;</p><p>				<font class="Comments">// 获得EditTex的内容</font></p><p>				String text = mEditText.getText().toString();</p><p>				<font class="keyword">try </font>{</p><p>					<font class="Comments">// 字符编码转换</font></p><p>					</font>msgBuffer = text.getBytes(<font class="Fields">"GB2312"</font>);</p><p>				</font>} <font class="keyword">catch </font>(UnsupportedEncodingException e1) {</p><p>					e1.printStackTrace();</p><p>				}</p><p>				<font class="keyword">try </font>{</p><p>					<font class="Comments">// 获得Socket的输出流</font></p><p>					outStream = clientSocket.getOutputStream();</p><p>				</font>} <font class="keyword">catch </font>(IOException e) {</p><p>					e.printStackTrace();</p><p>				}</p><p>				<font class="keyword">try </font>{</p><p>					<font class="Comments">// 发送数据</font></p><p>					outStream.write(msgBuffer);</p><p>				</font>} <font class="keyword">catch </font>(IOException e) {</p><p>					e.printStackTrace();</p><p>				}</p><p>				<font class="Comments">// 清空内容</font></p><p>				</font>mEditText.setText(<font class="Fields">""</font>);</p><p>				</font>displayToast(<font class="Fields">"发送成功！"</font>);</p><p>			}</p><p>		});</p><p>		<font class="Comments">// 消息处理</font></p><p>		</font>mHandler = <font class="keyword">new </font>Handler() {</p><p>			@Override</p><p>			<font class="keyword">public </font><font class="keyword">void </font>handleMessage(Message msg) {</p><p>				<font class="Comments">// 显示接收到的内容</font></p><p>				mTextView.setText((msg.obj).toString());</p><p>			}</p><p>		};</p><p>	}</p><p>	<font class="Comments">// 显示Toast函数</font></p><p>	<font class="keyword">private </font><font class="keyword">void </font>displayToast(String s) {</p><p>		</font>Toast.makeText(<font class="keyword">this</font>, s, Toast.LENGTH_SHORT).show();</p><p>	}</p><p>	<font class="keyword">private </font><font class="keyword">class </font>ReceiveThread </font><font class="keyword">extends </font>Thread {</p><p>		<font class="keyword">private </font>InputStream inStream = </font><font class="keyword">null</font>;</p><p>		<font class="keyword">private </font>byte[] buf;</p><p>		<font class="keyword">private </font>String str = </font><font class="keyword">null</font>;</p><p>		ReceiveThread(Socket s) {</p><p>			<font class="keyword">try </font>{</p><p>				<font class="Comments">// 获得输入流</font></p><p>				<font class="keyword">this</font>.inStream = s.getInputStream();</p><p>			</font>} <font class="keyword">catch </font>(IOException e) {</p><p>				e.printStackTrace();</p><p>			}</p><p>		}</p><p>		@Override</p><p>		<font class="keyword">public </font><font class="keyword">void </font>run() {</p><p>			<font class="keyword">while </font>(!stop) {</p><p>				<font class="keyword">this</font>.buf = </font><font class="keyword">new </font>byte[512];</p><p>				<font class="keyword">try </font>{</p><p>					<font class="Comments">// 读取输入数据（阻塞）</font></p><p>					<font class="keyword">this</font>.inStream.read(</font><font class="keyword">this</font>.buf);</p><p>				</font>} <font class="keyword">catch </font>(IOException e) {</p><p>					e.printStackTrace();</p><p>				}</p><p>				<font class="Comments">// 字符编码转换</font></p><p>				<font class="keyword">try </font>{</p><p>					<font class="keyword">this</font>.str = </font><font class="keyword">new </font>String(</font><font class="keyword">this</font>.buf, <font class="Fields">"GB2312"</font>).trim();</p><p>				</font>} <font class="keyword">catch </font>(UnsupportedEncodingException e) {</p><p>					e.printStackTrace();</p><p>				}</p><p>				</font>Message msg = <font class="keyword">new </font>Message();</p><p>				</font>msg.obj = <font class="keyword">this</font>.str;</p><p>				<font class="Comments">// 发送消息</font></p><p>				mHandler.sendMessage(msg);</p><p>			}</p><p>		}</p><p>	}</p><p>	@Override</p><p>	<font class="keyword">public </font><font class="keyword">void </font>onDestroy() {</p><p>		<font class="keyword">super</font>.onDestroy();</p><p>		<font class="keyword">if </font>(mReceiveThread != </font><font class="keyword">null</font>) {</p><p>			</font>stop = <font class="keyword">true</font>;</p><p>			mReceiveThread.interrupt();</p><p>		}</p><p>	}</p><p>}</p><p></pre></p><p>同样，新建MyServer工程，修改里面的main.xml文件，在里面添加了两个TextView，一个用于显示客户端的IP，一个用于显示接收到的内容，一个用于发送数据的Button，还有一个EditText，完整的main.xml如下：</p><p><pre>&lt;?xml version=<font class="Fields">"1.0"</font> encoding=</font><font class="Fields">"utf-8"</font>?&gt;</p><p>&lt;LinearLayout xmlns:android=<font class="Fields">"http:<font class="Comments">//schemas.android.com/apk/res/android</font></p><p>    </font>android:layout_width=<font class="Fields">"fill_parent</p><p>    </font>android:layout_height=<font class="Fields">"fill_parent</p><p>    </font>android:orientation=<font class="Fields">"vertical"</font> &gt;</p><p>    &lt;TextView</p><p>        </font>android:id=<font class="Fields">"@+id/iptextview</p><p>        </font>android:layout_width=<font class="Fields">"fill_parent</p><p>        </font>android:layout_height=<font class="Fields">"wrap_content</p><p>        </font>android:gravity=<font class="Fields">"center_horizontal</p><p>        </font>android:textSize=<font class="Fields">"20dip"</font> /&gt;</p><p>    &lt;EditText</p><p>        </font>android:id=<font class="Fields">"@+id/sedittext</p><p>        </font>android:layout_width=<font class="Fields">"fill_parent</p><p>        </font>android:layout_height=<font class="Fields">"wrap_content</p><p>        </font>android:hint=<font class="Fields">"请输入要发送的内容"</font> /&gt;</p><p>    &lt;Button</p><p>        </font>android:id=<font class="Fields">"@+id/sendbutton</p><p>        </font>android:layout_width=<font class="Fields">"fill_parent</p><p>        </font>android:layout_height=<font class="Fields">"wrap_content</p><p>        </font>android:text=<font class="Fields">"发送"</font> /&gt;</p><p>    &lt;TextView</p><p>        </font>android:id=<font class="Fields">"@+id/textview</p><p>        </font>android:layout_width=<font class="Fields">"fill_parent</p><p>        </font>android:layout_height=<font class="Fields">"wrap_content</p><p>        </font>android:textSize=<font class="Fields">"15dip"</font> /&gt;</p><p>&lt;/LinearLayout&gt;</p><p></pre></p><p>接着，修改MyServerActivity.java文件，定义了两个Thread子类，一个用于监听客户端的连接，一个用于接收数据，其他地方与MyClientActivity.java差不多。完整的内容如下：</p><p><pre><font class="keyword">import </font>java.io.IOException;</p><p><font class="keyword">import </font>java.io.InputStream;</p><p><font class="keyword">import </font>java.io.OutputStream;</p><p><font class="keyword">import </font>java.io.UnsupportedEncodingException;</p><p><font class="keyword">import </font>java.net.ServerSocket;</p><p><font class="keyword">import </font>java.net.Socket;</p><p><font class="keyword">import </font>android.app.Activity;</p><p><font class="keyword">import </font>android.os.Bundle;</p><p><font class="keyword">import </font>android.os.Handler;</p><p><font class="keyword">import </font>android.os.Message;</p><p><font class="keyword">import </font>android.view.View;</p><p><font class="keyword">import </font>android.widget.Button;</p><p><font class="keyword">import </font>android.widget.EditText;</p><p><font class="keyword">import </font>android.widget.TextView;</p><p><font class="keyword">import </font>android.widget.Toast;</p><p><font class="keyword">public </font><font class="keyword">class </font>MyServerActivity </font><font class="keyword">extends </font>Activity {</p><p>	<font class="keyword">private </font>TextView ipTextView = </font><font class="keyword">null</font>;</p><p>	<font class="keyword">private </font>EditText mEditText = </font><font class="keyword">null</font>;</p><p>	<font class="keyword">private </font>Button sendButton = </font><font class="keyword">null</font>;</p><p>	<font class="keyword">private </font>TextView mTextView = </font><font class="keyword">null</font>;</p><p>	<font class="keyword">private </font>OutputStream outStream = </font><font class="keyword">null</font>;</p><p>	<font class="keyword">private </font>Socket clientSocket = </font><font class="keyword">null</font>;</p><p>	<font class="keyword">private </font>ServerSocket mServerSocket = </font><font class="keyword">null</font>;</p><p>	<font class="keyword">private </font>Handler mHandler = </font><font class="keyword">null</font>;</p><p>	<font class="keyword">private </font>AcceptThread mAcceptThread = </font><font class="keyword">null</font>;</p><p>	<font class="keyword">private </font>ReceiveThread mReceiveThread = </font><font class="keyword">null</font>;</p><p>	<font class="keyword">private </font><font class="keyword">boolean </font>stop = </font><font class="keyword">true</font>;</p><p>	@Override</p><p>	<font class="keyword">public </font><font class="keyword">void </font>onCreate(Bundle savedInstanceState) {</p><p>		<font class="keyword">super</font>.onCreate(savedInstanceState);</p><p>		setContentView(R.layout.main);</p><p>		</font>ipTextView = (TextView) <font class="keyword">this</font>.findViewById(R.id.iptextview);</p><p>		</font>mEditText = (EditText) <font class="keyword">this</font>.findViewById(R.id.sedittext);</p><p>		</font>sendButton = (Button) <font class="keyword">this</font>.findViewById(R.id.sendbutton);</p><p>		</font>sendButton.setEnabled(<font class="keyword">false</font>);</p><p>		</font>mTextView = (TextView) <font class="keyword">this</font>.findViewById(R.id.textview);</p><p>		<font class="Comments">// 发送数据按钮监听</font></p><p>		</font>sendButton.setOnClickListener(<font class="keyword">new </font>View.OnClickListener() {</p><p>			@Override</p><p>			<font class="keyword">public </font><font class="keyword">void </font>onClick(View v) {</p><p>				</font>byte[] msgBuffer = <font class="keyword">null</font>;</p><p>				<font class="Comments">// 获得EditTex的内容</font></p><p>				String text = mEditText.getText().toString();</p><p>				<font class="keyword">try </font>{</p><p>					<font class="Comments">// 字符编码转换</font></p><p>					</font>msgBuffer = text.getBytes(<font class="Fields">"GB2312"</font>);</p><p>				</font>} <font class="keyword">catch </font>(UnsupportedEncodingException e1) {</p><p>					e1.printStackTrace();</p><p>				}</p><p>				<font class="keyword">try </font>{</p><p>					<font class="Comments">// 获得Socket的输出流</font></p><p>					outStream = clientSocket.getOutputStream();</p><p>				</font>} <font class="keyword">catch </font>(IOException e) {</p><p>					e.printStackTrace();</p><p>				}</p><p>				<font class="keyword">try </font>{</p><p>
					<font class="Comments">// 发送数据</font></p><p>					outStream.write(msgBuffer);</p><p>				</font>} <font class="keyword">catch </font>(IOException e) {</p><p>					e.printStackTrace();</p><p>				}</p><p>				<font class="Comments">// 清空内容</font></p><p>				</font>mEditText.setText(<font class="Fields">""</font>);</p><p>				</font>displayToast(<font class="Fields">"发送成功！"</font>);</p><p>			}</p><p>		});</p><p>		<font class="Comments">// 消息处理</font></p><p>		</font>mHandler = <font class="keyword">new </font>Handler() {</p><p>			@Override</p><p>			<font class="keyword">public </font><font class="keyword">void </font>handleMessage(Message msg) {</p><p>				<font class="keyword">switch </font>(msg.what) {</p><p>				<font class="keyword">case </font>0: {</p><p>					<font class="Comments">// 显示客户端IP</font></p><p>					ipTextView.setText((msg.obj).toString());</p><p>					<font class="Comments">// 使能发送按钮</font></p><p>					</font>sendButton.setEnabled(<font class="keyword">true</font>);</p><p>					<font class="keyword">break</font>;</p><p>				}</p><p>				<font class="keyword">case </font>1: {</p><p>					<font class="Comments">// 显示接收到的数据</font></p><p>					mTextView.setText((msg.obj).toString());</p><p>					<font class="keyword">break</font>;</p><p>				}</p><p>				}</p><p>			}</p><p>		};</p><p>		</font>mAcceptThread = <font class="keyword">new </font>AcceptThread();</p><p>		<font class="Comments">// 开启监听线程</font></p><p>		mAcceptThread.start();</p><p>	}</p><p>	<font class="Comments">// 显示Toast函数</font></p><p>	<font class="keyword">private </font><font class="keyword">void </font>displayToast(String s) {</p><p>		</font>Toast.makeText(<font class="keyword">this</font>, s, Toast.LENGTH_SHORT).show();</p><p>	}</p><p>	<font class="keyword">private </font><font class="keyword">class </font>AcceptThread </font><font class="keyword">extends </font>Thread {</p><p>		@Override</p><p>		<font class="keyword">public </font><font class="keyword">void </font>run() {</p><p>			<font class="keyword">try </font>{</p><p>				<font class="Comments">// 实例化ServerSocket对象并设置端口号为8888</font></p><p>				</font>mServerSocket = <font class="keyword">new </font>ServerSocket(8888);</p><p>			</font>} <font class="keyword">catch </font>(IOException e) {</p><p>				e.printStackTrace();</p><p>			}</p><p>			<font class="keyword">try </font>{</p><p>				<font class="Comments">// 等待客户端的连接（阻塞）</font></p><p>				clientSocket = mServerSocket.accept();</p><p>			</font>} <font class="keyword">catch </font>(IOException e) {</p><p>				e.printStackTrace();</p><p>			}</p><p>			</font>mReceiveThread = <font class="keyword">new </font>ReceiveThread(clientSocket);</p><p>			</font>stop = <font class="keyword">false</font>;</p><p>			<font class="Comments">// 开启接收线程</font></p><p>			mReceiveThread.start();</p><p>			</font>Message msg = <font class="keyword">new </font>Message();</p><p>			msg.what = 0;</p><p>			<font class="Comments">// 获取客户端IP</font></p><p>			msg.obj = clientSocket.getInetAddress().getHostAddress();</p><p>			<font class="Comments">// 发送消息</font></p><p>			mHandler.sendMessage(msg);</p><p>		}</p><p>	}</p><p>	<font class="keyword">private </font><font class="keyword">class </font>ReceiveThread </font><font class="keyword">extends </font>Thread {</p><p>		<font class="keyword">private </font>InputStream mInputStream = </font><font class="keyword">null</font>;</p><p>		<font class="keyword">private </font>byte[] buf;</p><p>		<font class="keyword">private </font>String str = </font><font class="keyword">null</font>;</p><p>		ReceiveThread(Socket s) {</p><p>			<font class="keyword">try </font>{</p><p>				<font class="Comments">// 获得输入流</font></p><p>				<font class="keyword">this</font>.mInputStream = s.getInputStream();</p><p>			</font>} <font class="keyword">catch </font>(IOException e) {</p><p>				e.printStackTrace();</p><p>			}</p><p>		}</p><p>		@Override</p><p>		<font class="keyword">public </font><font class="keyword">void </font>run() {</p><p>			<font class="keyword">while </font>(!stop) {</p><p>				<font class="keyword">this</font>.buf = </font><font class="keyword">new </font>byte[512];</p><p>				<font class="Comments">// 读取输入的数据(阻塞读)</font></p><p>				<font class="keyword">try </font>{</p><p>					<font class="keyword">this</font>.mInputStream.read(buf);</p><p>				</font>} <font class="keyword">catch </font>(IOException e1) {</p><p>					e1.printStackTrace();</p><p>				}</p><p>				<font class="Comments">// 字符编码转换</font></p><p>				<font class="keyword">try </font>{</p><p>					<font class="keyword">this</font>.str = </font><font class="keyword">new </font>String(</font><font class="keyword">this</font>.buf, <font class="Fields">"GB2312"</font>).trim();</p><p>				</font>} <font class="keyword">catch </font>(UnsupportedEncodingException e) {</p><p>					e.printStackTrace();</p><p>				}</p><p>				</font>Message msg = <font class="keyword">new </font>Message();</p><p>				msg.what = 1;</p><p>				</font>msg.obj = <font class="keyword">this</font>.str;</p><p>				<font class="Comments">// 发送消息</font></p><p>				mHandler.sendMessage(msg);</p><p>			}</p><p>		}</p><p>	}</p><p>	@Override</p><p>	<font class="keyword">public </font><font class="keyword">void </font>onDestroy() {</p><p>		<font class="keyword">super</font>.onDestroy();</p><p>		<font class="keyword">if </font>(mReceiveThread != </font><font class="keyword">null</font>) {</p><p>			</font>stop = <font class="keyword">true</font>;</p><p>			mReceiveThread.interrupt();</p><p>		}</p><p>	}</p><p>}</p><p></pre></p><p>两个工程都修改好了，在模拟器上运行客户端：</p><p><img src="../img/network_socket/03_socket.png"></p><p>在真机上运行服务器端：</p><p><img src="../img/network_socket/03_socket2.png"></p><p>接着，点击客户端的“连接”按钮，看到“连接成功”提示后输入一些内容再点击“发送”按钮，此时客户端显示：</p><p><img src="../img/network_socket/03_socket3.png"></p><p>服务器端显示：</p><p><img src="../img/network_socket/03_socket4.png"></p><p>接下来两边都可以随意发送数据了。</p><p></p></div>

</DIV></DIV>

<DIV id=footer style="display:none">
<P align="center">  
 
 
 
    </P>
</DIV></BODY></HTML>

