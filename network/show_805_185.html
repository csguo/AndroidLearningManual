
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML xmlns="http://www.w3.org/1999/xhtml">
<HEAD>
<TITLE>Android中NFC功能流程图解析及代码演示_Android学习手册</TITLE>
<META content="text/html; charset=gb2312" http-equiv=Content-Type><LINK  rel=stylesheet type=text/css href="../css/c5.css">
<META name=GENERATOR content="MSHTML 8.00.6001.18702">
<meta name="Description" content=Android基础 Android组件 Android用户界面 Android设备功能 Android数据存储 Android网络应用 Android游戏开发 Android多媒体 Android源码开发 Android高级进阶 Android面试题/>
<meta name="Keywords" content="android 学习手册">

</HEAD>
<BODY id=homesecond class=serverscripting>
<DIV id=wrapper>
<DIV id=header><h1><a href="../index.html">Android学习手册</a></h1> 
</DIV>

<DIV id=navfirst>
<div id="indexGuide"><UL><li ><A href="../basic/index.html">Android基础</A> </li><li ><A href="../component/index.html">Android组件</A> </li><li ><A href="../userinterface/index.html">用户界面</A> </li><li ><A href="../device/index.html">设备功能</A> </li><li ><A href="../datastorage/index.html">数据存储</A> </li><li class="navcurrentLink"><A href="index.html">网络应用</A> </li><li ><A href="../game/index.html">游戏开发</A> </li><li ><A href="../multimedia/index.html">多媒体</A> </li><li ><A href="../source/index.html">源码开发</A> </li><li ><A href="../advance/index.html">高级进阶</A> </li><li ><A href="../interview/index.html">Android面试题</A> </li></UL></div>
</DIV>
<DIV id=navsecond>
<DIV id=course>
<div id="kcTitle">课 程 表</div>


  <h2><A title="3G" href="index_177.html">3G</A></h2>

  <h2><A title="WIFI" href="index_178.html">WIFI</A></h2>

  <h2><A title="蓝牙" href="index_179.html">蓝牙</A></h2>

  <h2><A title="HTTP协议" href="index_180.html">HTTP协议</A></h2>

  <h2><A title="Socket" href="index_181.html">Socket</A></h2>

  <h2><A title="HTML与HTML5" href="index_182.html">HTML与HTML5</A></h2>

  <h2><A title="JavaScript" href="index_183.html">JavaScript</A></h2>

  <h2><A title="Email" href="index_184.html">Email</A></h2>

  <h2><A title="NFC" href="index_185.html">NFC</A></h2>
<UL><li ><A title=Android NFC 开发教程之一 href="show_801_185.html">Android NFC 开发教程之一</A> </li><li ><A title=Android NFC 开发教程之二 href="show_802_185.html">Android NFC 开发教程之二</A> </li><li ><A title=Android NFC 开发教程之三 href="show_803_185.html">Android NFC 开发教程之三</A> </li><li ><A title=Android学习笔记之NFC近距离无线通讯技术（Dean） href="show_804_185.html">Android学习笔记之NFC近距离无线通讯技术（Dean）</A> </li><li class="currentLink"><A title=Android中NFC功能流程图解析及代码演示 href="show_805_185.html">Android中NFC功能流程图解析及代码演示</A> </li><li ><A title=关于NFC的android开发 href="show_806_185.html">关于NFC的android开发</A> </li></UL>
  <h2><A title="Web Service" href="index_186.html">Web Service</A></h2>

</DIV></DIV>
<DIV id=maincontent>
<DIV id=w3school>
<H1></H1>
<P><STRONG></STRONG></P></DIV>

<DIV>
<H2>Android中NFC功能流程图解析及代码演示</H2>
<div style="line-height:20px; font-size:14px;"><p>在Android4.0推出的时候，一个非常引人注目的功能就是NFC(Near Field Communication).</p><p>Near Field Communication (NFC) is a set of short-range wireless technologies, typically requiring a distance of 4cm or less to initiate a connection. NFC allows you to share small payloads of data between an NFC tag and an Android-powered device, or between two Android-powered devices.</p><p>翻译：</p><p>近场通讯(NFC)是一系列短距离无线技术，一般需要4cm或者更短去初始化连接。近场通讯(NFC)允许你在NFC tag和Android设备或者两个Android设备间共享小负载数据。</p><p>典型的应用为刷卡应用，如刷信用卡，公交车卡，吃饭的饭卡之类。腾讯2011年1月份文章“Android首款NFC近场通信应用推出”，说明了基于Android的NFC应用目前已经有了，得益于日本在手机刷卡的应用氛围。据2011年7月网易文章“PayPal推出Android系统NFC移动支付服务”报道，PayPal已经做了尝试了，相信这股风很快要刮到中国。</p><p>下面我们从技术的层面来分析一下这个技术。</p><p>这是NFC的开发流程，参考文章 “【NFC在android中的应用API】”。</p><p>相关的类代码有：NfcAdapter,NdefMessage, NdefRecord,ACTION_TAG_DISCOVERED.</p><p>在功能层面上，涉及到了NFC的读写功能。下面我们分别来做总结。</p><p>在代码层上面：</p><p>使用的时候，需要在AndroidManifest.xml里面加一些权限以及属性。</p><p><pre>&lt;uses-permission android:name=<font class="Fields">"android.permission.NFC"</font>/&gt;</p><p>&lt;uses-feature android:name=<font class="Fields">"android.hardware.nfc"</font> android:required=</font><font class="Fields">"<font class="keyword">true</font>"</font>/&gt;</p><p>&lt;uses-sdk android:minSdkVersion=<font class="Fields">"10"</font>/&gt;</p><p></pre></p><p>这里注意，在Android Version 9的时候仅仅支持了ACTION_TAG_DISCOVERED，对于其他的需要10以上。</p><p>在上面的基础上，还需要增加intent-filter的支持。</p><p><pre>&lt;intent-filter&gt; </p><p>	</font>&lt;action android:name=<font class="Fields">"android.nfc.action.NDEF_DISCOVERED"</font>/&gt;</p><p>	</font>&lt;category android:name=<font class="Fields">"android.intent.category.DEFAULT"</font>/&gt;</p><p>	</font>&lt;data android:mimeType=<font class="Fields">"text/plain"</font>/&gt;</p><p>&lt;/intent-filter&gt;</p><p></pre></p><p>获取NfcAdapter的代码为</p><p><pre><font class="keyword">public </font><font class="keyword">static </font>String getStatusNfcDevice() {</p><p>	NfcAdapter nfcAdapter = NfcAdapter.getDefaultAdapter();</p><p>	<font class="keyword">if </font>(nfcAdapter.isEnabled()) {</p><p>		</font>String status = <font class="Fields">"enabled"</font>;</p><p>		<font class="keyword">return </font>status;</p><p>	</font>} <font class="keyword">else </font>{</p><p>		</font>String status = <font class="Fields">"disabled"</font>;</p><p>		<font class="keyword">return </font>status;</p><p>	}</p><p>}</p><p></pre></p><p>处理函数为</p><p><pre><font class="keyword">public </font><font class="keyword">void </font>onResume() {</p><p>	<font class="keyword">super</font>.onResume();</p><p>	<font class="keyword">if </font>(NfcAdapter.ACTION_NDEF_DISCOVERED.equals(getIntent().getAction())) {</p><p>		Parcelable[] rawMsgs = intent</p><p>				.getParcelableArrayExtra(NfcAdapter.EXTRA_NDEF_MESSAGES);</p><p>		<font class="keyword">if </font>(rawMsgs != </font><font class="keyword">null</font>) {</p><p>			</font>msgs = <font class="keyword">new </font>NdefMessage[rawMsgs.length];</p><p>			<font class="keyword">for </font>(</font><font class="keyword">int </font>i = 0; i &lt; rawMsgs.length; i++) {</p><p>				msgs[i] = (NdefMessage) rawMsgs[i];</p><p>			}</p><p>		}</p><p>	}</p><p>	<font class="Comments">// process the msgs array</font></p><p>}</p><p></pre></p><p>完整的一个操作代码摘自Google Android NFC Guide代码（略加注释）：</p><p><pre><font class="keyword">import </font>android.app.Activity;</p><p><font class="keyword">import </font>android.content.Intent;</p><p><font class="keyword">import </font>android.nfc.NdefMessage;</p><p><font class="keyword">import </font>android.nfc.NdefRecord;</p><p><font class="keyword">import </font>android.nfc.NfcAdapter;</p><p><font class="keyword">import </font>android.nfc.NfcAdapter.CreateNdefMessageCallback;</p><p><font class="keyword">import </font>android.nfc.NfcEvent;</p><p><font class="keyword">import </font>android.os.Bundle;</p><p><font class="keyword">import </font>android.os.Parcelable;</p><p><font class="keyword">import </font>android.widget.TextView;</p><p><font class="keyword">import </font>android.widget.Toast;</p><p><font class="keyword">import </font>java.nio.charset.Charset;</p><p></p><p><font class="Comments">//继承并实现接口CreateNdefMessageCallback方法createNdefMessage</font></p><p><font class="keyword">public </font><font class="keyword">class </font>Beam </font><font class="keyword">extends </font>Activity </font><font class="keyword">implements </font>CreateNdefMessageCallback {</p><p>	NfcAdapter mNfcAdapter;</p><p>	TextView textView;</p><p>	@Override</p><p>	<font class="keyword">public </font><font class="keyword">void </font>onCreate(Bundle savedInstanceState) {</p><p>		<font class="keyword">super</font>.onCreate(savedInstanceState);</p><p>		setContentView(R.layout.main);</p><p>		TextView textView = (TextView) findViewById(R.id.textView);</p><p>		<font class="Comments">// Check for available NFC Adapter</font></p><p>		<font class="Comments">// 检测是否有NFC适配器</font></p><p>		</font>mNfcAdapter = NfcAdapter.getDefaultAdapter(<font class="keyword">this</font>);</p><p>		<font class="keyword">if </font>(mNfcAdapter == </font><font class="keyword">null</font>) {</p><p>			</font>Toast.makeText(<font class="keyword">this</font>, <font class="Fields">"NFC is not available"</font>, Toast.LENGTH_LONG)</p><p>					.show();</p><p>			finish();</p><p>			<font class="keyword">return</font>;</font></p><p>		}</p><p>		<font class="Comments">// Register callback</font></p><p>		<font class="Comments">// 注册回调函数</font></p><p>		</font>mNfcAdapter.setNdefPushMessageCallback(<font class="keyword">this</font>, </font><font class="keyword">this</font>);</p><p>	}</p><p></p><p>	@Override</p><p>	<font class="keyword">public </font>NdefMessage createNdefMessage(NfcEvent event) {</p><p>		</font>String text = (<font class="Fields">"Beam me up, Android!\n\n"</font> + </font><font class="Fields">"Beam Time: "</font> + System</p><p>				.currentTimeMillis());</p><p>		<font class="Comments">// 回调函数，构造NdefMessage格式</font></p><p>		</font>NdefMessage msg = <font class="keyword">new </font>NdefMessage(</font><font class="keyword">new </font>NdefRecord[] { createMimeRecord(</p><p>				<font class="Fields">"application/com.example.android.beam"</font>, text.getBytes())</p><p>		<font class="Comments">/**</font></p><p>		 <font class="Comments">* The Android Application Record (AAR) is commented out. When a device</font></p><p>		 <font class="Comments">* receives a push with an AAR in it, the application specified in the</font></p><p>		 <font class="Comments">* AAR is guaranteed to run. The AAR overrides the tag dispatch system.</font></p><p>		 <font class="Comments">* You can add it back in to guarantee that this activity starts when</font></p><p>		 <font class="Comments">* receiving a beamed message. For now, this code uses the tag dispatch</font></p><p>		 <font class="Comments">* system.</font></p><p>		 <font class="Comments">*/</font></p><p>		<font class="Comments">// ,NdefRecord.createApplicationRecord("com.example.android.beam")</font></p><p>				});</p><p>		<font class="keyword">return </font>msg;</p><p>	}</p><p>	@Override</p><p>	<font class="keyword">public </font><font class="keyword">void </font>onResume() {</p><p>		<font class="keyword">super</font>.onResume();</p><p>		<font class="Comments">// Check to see that the Activity started due to an Android Beam</font></p><p>		<font class="Comments">// 得到是否检测到ACTION_NDEF_DISCOVERED触发</font></p><p>		<font class="keyword">if </font>(NfcAdapter.ACTION_NDEF_DISCOVERED.equals(getIntent().getAction())) {</p><p>			processIntent(getIntent());</p><p>		}</p><p>	}</p><p>	<font class="Comments">// 重载Activity类方法处理当新Intent到来事件</font></p><p>	@Override</p><p>	<font class="keyword">public </font><font class="keyword">void </font>onNewIntent(Intent intent) {</p><p>		<font class="Comments">// onResume gets called after this to handle the intent</font></p><p>		setIntent(intent);</p><p>	}</p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* Parses the NDEF Message from the intent and prints to the TextView</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="Comments">// 关键处理函数，处理扫描到的NdefMessage</font></p><p>	<font class="keyword">void </font>processIntent(Intent intent) {</p><p>		textView = (TextView) findViewById(R.id.textView);</p><p>		Parcelable[] rawMsgs = intent</p><p>				.getParcelableArrayExtra(NfcAdapter.EXTRA_NDEF_MESSAGES);</p><p>		<font class="Comments">// only one message sent during the beam</font></p><p>		NdefMessage msg = (NdefMessage) rawMsgs[0];</p><p>		<font class="Comments">// record 0 contains the MIME type, record 1 is the AAR, if present</font></p><p>		</font>textView.setText(<font class="keyword">new </font>String(msg.getRecords()[0].getPayload()));</p><p>	}</p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* Creates a custom MIME type encapsulated in an NDEF record</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">public </font>NdefRecord createMimeRecord(String mimeType, byte[] payload) {</p><p>		</font>byte[] mimeBytes = mimeType.getBytes(Charset.forName(<font class="Fields">"US-ASCII"</font>));</p><p>		</font>NdefRecord mimeRecord = <font class="keyword">new </font>NdefRecord(NdefRecord.TNF_MIME_MEDIA,</p><p>				</font>mimeBytes, <font class="keyword">new </font>byte[0], payload);</p><p>		<font class="keyword">return </font>mimeRecord;</p><p>	}</p><p>}</p><p></pre></p><p>上面代码还需要在AndroidManifest.xml文件里面添加</p><p><pre>&lt;intent-filter&gt;</p><p>  </font>&lt;action android:name=<font class="Fields">"android.nfc.action.NDEF_DISCOVERED"</font>/&gt;</p><p>  </font>&lt;category android:name=<font class="Fields">"android.intent.category.DEFAULT"</font>/&gt;</p><p>  </font>&lt;data android:mimeType=<font class="Fields">"application/com.example.android.beam"</font>/&gt;</p><p>&lt;/intent-filter&gt;</p><p></pre></p><p>在对NFC设备进行写操作的时候，相关代码:</p><p><pre><font class="keyword">public </font><font class="keyword">class </font>Snippet {</p><p>	<font class="keyword">private </font><font class="keyword">void </font>enableTagWriteMode() {</p><p>		</font>mWriteMode = <font class="keyword">true</font>;</p><p>		</font>IntentFilter tagDetected = <font class="keyword">new </font>IntentFilter(</p><p>				NfcAdapter.ACTION_TAG_DISCOVERED);</p><p>		</font>mWriteTagFilters = <font class="keyword">new </font>IntentFilter[] { tagDetected </font>};</p><p>		</font>mNfcAdapter.enableForegroundDispatch(<font class="keyword">this</font>, mNfcPendingIntent,</p><p>				</font>mWriteTagFilters, <font class="keyword">null</font>);</p><p>	}</p><p>	@Override</p><p>	<font class="keyword">protected </font><font class="keyword">void </font>onNewIntent(Intent intent) {</p><p>		<font class="Comments">// Tag writing mode</font></p><p>		<font class="keyword">if </font>(mWriteMode</p><p>				&& NfcAdapter.ACTION_TAG_DISCOVERED.equals(intent.getAction())) {</p><p>			Tag detectedTag = intent.getParcelableExtra(NfcAdapter.EXTRA_TAG);</p><p>			<font class="keyword">if </font>(NfcUtils.writeTag(NfcUtils.getPlaceidAsNdef(placeidToWrite),</p><p>					detectedTag)) {</p><p>				</font>Toast.makeText(<font class="keyword">this</font>, <font class="Fields">"Success: Wrote placeid to nfc tag"</font>,</p><p>						Toast.LENGTH_LONG).show();</p><p>				</font>NfcUtils.soundNotify(<font class="keyword">this</font>);</p><p>			</font>} <font class="keyword">else </font>{</p><p>				</font>Toast.makeText(<font class="keyword">this</font>, <font class="Fields">"Write failed"</font>, Toast.LENGTH_LONG).show();</p><p>			}</p><p>		}</p><p>	}</p><p>	/*</p><p>	 <font class="Comments">* Writes an NdefMessage to a NFC tag</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">public </font><font class="keyword">static </font><font class="keyword">boolean </font>writeTag(NdefMessage message, Tag tag) {</p><p>		<font class="keyword">int </font>size = message.toByteArray().length;</p><p>		<font class="keyword">try </font>{</p><p>			Ndef ndef = Ndef.get(tag);</p><p>			<font class="keyword">if </font>(ndef != </font><font class="keyword">null</font>) {</p><p>				ndef.connect();</p><p>				<font class="keyword">if </font>(!ndef.isWritable()) {</p><p>					<font class="keyword">return </font><font class="keyword">false</font>;</p><p>				}</p><p>				<font class="keyword">if </font>(ndef.getMaxSize() &lt; size) {</p><p>					<font class="keyword">return </font><font class="keyword">false</font>;</p><p>				}</p><p>				ndef.writeNdefMessage(message);</p><p>				<font class="keyword">return </font><font class="keyword">true</font>;</p><p>			</font>} <font class="keyword">else </font>{</p><p>				NdefFormatable format = NdefFormatable.get(tag);</p><p>				<font class="keyword">if </font>(format != </font><font class="keyword">null</font>) {</p><p>					<font class="keyword">try </font>{</p><p>						format.connect();</p><p>						format.format(message);</p><p>						<font class="keyword">return </font><font class="keyword">true</font>;</p><p>					</font>} <font class="keyword">catch </font>(IOException e) {</p><p>						<font class="keyword">return </font><font class="keyword">false</font>;</p><p>					}</p><p>				</font>} <font class="keyword">else </font>{</p><p>					<font class="keyword">return </font><font class="keyword">false</font>;</p><p>				}</p><p>			}</p><p>		</font>} <font class="keyword">catch </font>(Exception e) {</p><p>			<font class="keyword">return </font><font class="keyword">false</font>;</p><p>		}</p><p>	}</p><p>}</p><p>&lt;activity android:name=<font class="Fields">".CheckInActivity"</font>&gt;</p><p>	&lt;intent-filter&gt;</p><p>		</font>&lt;action android:name=<font class="Fields">"android.nfc.action.NDEF_DISCOVERED"</font>/&gt;</p><p>		</font>&lt;data android:mimeType=<font class="Fields">"application/vnd.facebook.places"</font>/&gt;</p><p>		</font>&lt;category android:name=<font class="Fields">"android.intent.category.DEFAULT"</font>/&gt;</p><p>	&lt;/intent-filter&gt;</p><p>&lt;/activity&gt;</p><p></pre></p><p></p></div>

</DIV></DIV>

<DIV id=footer style="display:none">
<P align="center">  
 
 
 
    </P>
</DIV></BODY></HTML>

