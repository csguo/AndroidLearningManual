
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML xmlns="http://www.w3.org/1999/xhtml">
<HEAD>
<TITLE>在android的状态栏(statusbar)中增加menu，home和back快捷键的方法_Android学习手册</TITLE>
<META content="text/html; charset=gb2312" http-equiv=Content-Type><LINK  rel=stylesheet type=text/css href="../css/c5.css">
<META name=GENERATOR content="MSHTML 8.00.6001.18702">
<meta name="Description" content=Android基础 Android组件 Android用户界面 Android设备功能 Android数据存储 Android网络应用 Android游戏开发 Android多媒体 Android源码开发 Android高级进阶 Android面试题/>
<meta name="Keywords" content="android 学习手册">

</HEAD>
<BODY id=homesecond class=serverscripting>
<DIV id=wrapper>
<DIV id=header><h1><a href="../index.html">Android学习手册</a></h1> 
</DIV>

<DIV id=navfirst>
<div id="indexGuide"><UL><li ><A href="../basic/index.html">Android基础</A> </li><li ><A href="../component/index.html">Android组件</A> </li><li ><A href="../userinterface/index.html">用户界面</A> </li><li ><A href="../device/index.html">设备功能</A> </li><li ><A href="../datastorage/index.html">数据存储</A> </li><li ><A href="../network/index.html">网络应用</A> </li><li ><A href="../game/index.html">游戏开发</A> </li><li ><A href="../multimedia/index.html">多媒体</A> </li><li class="navcurrentLink"><A href="index.html">源码开发</A> </li><li ><A href="../advance/index.html">高级进阶</A> </li><li ><A href="../interview/index.html">Android面试题</A> </li></UL></div>
</DIV>
<DIV id=navsecond>
<DIV id=course>
<div id="kcTitle">课 程 表</div>


  <h2><A title="Launcher" href="index_207.html">Launcher</A></h2>

  <h2><A title="电话系统RIL" href="index_208.html">电话系统RIL</A></h2>

  <h2><A title="进程间通信" href="index_209.html">进程间通信</A></h2>

  <h2><A title="内部sensor系统" href="index_210.html">内部sensor系统</A></h2>

  <h2><A title="内部surface系统" href="index_211.html">内部surface系统</A></h2>

  <h2><A title="启动流程" href="index_212.html">启动流程</A></h2>

  <h2><A title="源码编译" href="index_213.html">源码编译</A></h2>

  <h2><A title="状态栏" href="index_214.html">状态栏</A></h2>
<UL><li ><A title=Android 软件中状态栏图标处理 href="show_701_214.html">Android 软件中状态栏图标处理</A> </li><li ><A title=Android 状态栏上添加按钮 href="show_702_214.html">Android 状态栏上添加按钮</A> </li><li ><A title=Android全屏 去除标题栏和状态栏 href="show_703_214.html">Android全屏 去除标题栏和状态栏</A> </li><li ><A title=浅析HoneyComb中左下角三个导航键的实现源码 href="show_704_214.html">浅析HoneyComb中左下角三个导航键的实现源码</A> </li><li class="currentLink"><A title=在android的状态栏(statusbar)中增加menu，home和back快捷键的方法 href="show_705_214.html">在android的状态栏(statusbar)中增加menu，home和back快捷键的方法</A> </li><li ><A title=在状态栏添加文字显示的解决方法 href="show_706_214.html">在状态栏添加文字显示的解决方法</A> </li><li ><A title=Android 状态栏提示的另一种方法（一） href="show_707_214.html">Android 状态栏提示的另一种方法（一）</A> </li><li ><A title=Android 状态栏提示的另一种方法（二） href="show_708_214.html">Android 状态栏提示的另一种方法（二）</A> </li></UL>
</DIV></DIV>
<DIV id=maincontent>
<DIV id=w3school>
<H1></H1>
<P><STRONG></STRONG></P></DIV>

<DIV>
<H2>在android的状态栏(statusbar)中增加menu，home和back快捷键的方法</H2>
<div style="line-height:20px; font-size:14px;"><p>由于完全改了status bar，建议先做几张png图片，加到Frameworks/base/core/res/res/drawable下。最好做一张背景图，替换statusbar_background.png</p><p>另外我又加了几张icon，分别是home menu和back的正常和按下状态。</p><p>这些图片为：</p><p><pre>frameworks\base\core\res\res\drawable\ic_menu_back_pressed.png</p><p>frameworks\base\core\res\res\drawable\ic_menu_home_pressed.png</p><p>frameworks\base\core\res\res\drawable\ic_menu_more_pressed.png</p><p>frameworks\base\core\res\res\drawable\ic_volume_down_pressed.png</p><p>frameworks\base\core\res\res\drawable\ic_volume_up_pressed.png</p><p>frameworks\base\core\res\res\drawable\ic_menu_back.png</p><p>frameworks\base\core\res\res\drawable\ic_menu_home.png</p><p>frameworks\base\core\res\res\drawable\ic_menu_more.png</p><p>frameworks\base\core\res\res\drawable\ic_volume_down.png</p><p>frameworks\base\core\res\res\drawable\ic_volume_up.png</p><p></pre></p><p>修改步骤为：</p><p style="color:#3333FF;">一．修改xml界面</p><p style="color:#3333FF;">1.创建按钮</p><p><pre>frameworks\base\core\res\res\drawable\btn_sbicon_back.xml</p><p>frameworks\base\core\res\res\drawable\btn_sbicon_home.xml</p><p>frameworks\base\core\res\res\drawable\btn_sbicon_menu.xml</p><p>frameworks\base\core\res\res\drawable\btn_sbicon_vol_down.xml</p><p>frameworks\base\core\res\res\drawable\btn_sbicon_vol_up.xml</p><p></pre></p><p>基结构如下：</p><p><pre>&lt;?xml version=<font class="Fields">"1.0"</font> encoding=</font><font class="Fields">"utf-8"</font>?&gt;</p><p>&lt;selector xmlns:android=<font class="Fields">"http:<font class="Comments">//schemas.android.com/apk/res/android "</font>&gt;</font></p><p>    </font>&lt;item android:drawable=<font class="Fields">"@drawable/ic_menu_back_pressed"</font> android:state_pressed=</font><font class="Fields">"<font class="keyword">true</font>"</font>/&gt;</p><p>    </font>&lt;item android:drawable=<font class="Fields">"@drawable/ic_menu_back"</font> android:state_pressed=</font><font class="Fields">"<font class="keyword">false</font>"</font>/&gt;</p><p>&lt;/selector&gt;</p><p></pre></p><p style="color:#3333FF;">2. 增加图标</p><p>更改整个status bar，我的方法是：</p><p>修改status bar的layerout文件：</p><p>Frameworks/base/core/res/res/layout/status_bar.xml</p><p>在原来的linearlayout中新增 image view</p><p><pre>&lt;?xml version=<font class="Fields">"1.0"</font> encoding=</font><font class="Fields">"utf-8"</font>?&gt;</p><p>&lt;com.android.server.status.StatusBarView xmlns:android=<font class="Fields">"http:<font class="Comments">//schemas.android.com/apk/res/android </font></p><p>    </font>android:background=<font class="Fields">"@drawable/statusbar_background</p><p>    </font>android:descendantFocusability=<font class="Fields">"afterDescendants</p><p>    </font>android:focusable=<font class="Fields">"<font class="keyword">true</font></p><p>    </font>android:orientation=<font class="Fields">"vertical"</font> &gt;</p><p>    &lt;LinearLayout</p><p>        </font>android:id=<font class="Fields">"@+id/keys</p><p>        </font>android:layout_width=<font class="Fields">"wrap_content</p><p>        </font>android:layout_height=<font class="Fields">"fill_parent</p><p>        </font>android:orientation=<font class="Fields">"horizontal"</font> &gt;</p><p>        &lt;ImageView</p><p>            </font>android:id=<font class="Fields">"@+id/status_home</p><p>            </font>android:layout_width=<font class="Fields">"40dip</p><p>            </font>android:layout_height=<font class="Fields">"40dip</p><p>            </font>android:layout_gravity=<font class="Fields">"top</p><p>            </font>android:clickable=<font class="Fields">"<font class="keyword">true</font></p><p>            </font>android:paddingLeft=<font class="Fields">"1dip</p><p>            </font>android:paddingRight=<font class="Fields">"1dip</p><p>            </font>android:paddingTop=<font class="Fields">"1dip</p><p>            </font>android:src=<font class="Fields">"@drawable/btn_sbicon_home"</font> /&gt;</p><p>        &lt;ImageView</p><p>            </font>android:id=<font class="Fields">"@+id/status_back</p><p>            </font>android:layout_width=<font class="Fields">"40dip</p><p>            </font>android:layout_height=<font class="Fields">"40dip</p><p>            </font>android:layout_gravity=<font class="Fields">"top</p><p>            </font>android:clickable=<font class="Fields">"<font class="keyword">true</font></p><p>            </font>android:paddingLeft=<font class="Fields">"1dip</p><p>            </font>android:paddingRight=<font class="Fields">"1dip</p><p>            </font>android:paddingTop=<font class="Fields">"1dip</p><p>            </font>android:src=<font class="Fields">"@drawable/btn_sbicon_back"</font> /&gt;</p><p>        &lt;ImageView</p><p>            </font>android:id=<font class="Fields">"@+id/status_menu</p><p>            </font>android:layout_width=<font class="Fields">"40dip</p><p>            </font>android:layout_height=<font class="Fields">"40dip</p><p>            </font>android:layout_gravity=<font class="Fields">"top</p><p>            </font>android:clickable=<font class="Fields">"<font class="keyword">true</font></p><p>            </font>android:paddingLeft=<font class="Fields">"1dip</p><p>            </font>android:paddingRight=<font class="Fields">"1dip</p><p>            </font>android:paddingTop=<font class="Fields">"1dip</p><p>            </font>android:src=<font class="Fields">"@drawable/btn_sbicon_menu"</font> /&gt;</p><p>        &lt;ImageView</p><p>            </font>android:id=<font class="Fields">"@+id/status_vol_down</p><p>            </font>android:layout_width=<font class="Fields">"40dip</p><p>            </font>android:layout_height=<font class="Fields">"40dip</p><p>            </font>android:layout_gravity=<font class="Fields">"top</p><p>            </font>android:clickable=<font class="Fields">"<font class="keyword">true</font></p><p>            </font>android:paddingLeft=<font class="Fields">"1dip</p><p>            </font>android:paddingRight=<font class="Fields">"1dip</p><p>            </font>android:paddingTop=<font class="Fields">"1dip</p><p>            </font>android:src=<font class="Fields">"@drawable/btn_sbicon_vol_down"</font> /&gt;</p><p>        &lt;ImageView</p><p>            </font>android:id=<font class="Fields">"@+id/status_vol_up</p><p>            </font>android:layout_width=<font class="Fields">"40dip</p><p>            </font>android:layout_height=<font class="Fields">"40dip</p><p>            </font>android:layout_gravity=<font class="Fields">"top</p><p>            </font>android:clickable=<font class="Fields">"<font class="keyword">true</font></p><p>            </font>android:paddingLeft=<font class="Fields">"1dip</p><p>            </font>android:paddingRight=<font class="Fields">"1dip</p><p>            </font>android:paddingTop=<font class="Fields">"1dip</p><p>            </font>android:src=<font class="Fields">"@drawable/btn_sbicon_vol_up"</font> /&gt;</p><p>    &lt;/LinearLayout&gt;</p><p>&lt;/com.android.server.status.StatusBarView&gt;</p><p></pre></p><p>这样做的好处就是简单。同时保证home、menu、back按钮，不受它本来的约束。这样status bar上即可看到这些按钮了。</p><p>图标的位置，可通过修改 paddingRight， paddingLeft 和paddingTop的值达到最佳视觉效果。</p><p style="color:#3333FF;">3. 修改status bar的高度。</p><p>既然要在status bar上增加那么几个按钮，当然是想要使用触摸操作的，android自带的status bar高度太小，不适用。对于7寸屏的话，50pixel的高度应该是差不多了。</p><p>修改高度很简单，修改frameworks/base/core/res/res/values/dimens.xml的status_bar_height属性</p><p><pre>&lt;!-- Height of the status bar --&gt;</p><p>&lt;dimen name=<font class="Fields">"status_bar_height"</font>&gt;50dip&lt;/dimen&gt;</p><p></pre></p><p>也可以更改状态栏Icon的大小，frameworks\base\core\res\res\layout\status_bar_icon.xml</p><p><pre>&lt;FrameLayout xmlns:android=<font class="Fields">"http:<font class="Comments">//schemas.android.com/apk/res/android "</font> </font></p><p>	</font>android:layout_width=<font class="Fields">"25dp"</font></p><p>	</font>android:layout_height=<font class="Fields">"25dp"</font> &gt;</p><p></pre></p><p>当然，如果相改title的高度，可以修改 Frameworks/base/core/res/res/values/themes.xml中的Window attributes的windowTitleSize值</p><p>编译运行一下：</p><p><pre>~/donut$ source ./env.sh   </p><p>~/donut$ make –j8   </p><p>~/donut$ emulator –skin WVGA800 </p><p>~/donut$ source ./env.sh</p><p>~/donut$ make –j8</p><p>~/donut$ emulator –skin WVGA800</p><p></pre></p><p>看状态栏是不是改变了？</p><p style="color:#3333FF;">二 为按钮添加模拟按键</p><p>修改frameworks\base\services\java\com\android\server\status\StatusBarView.java</p><p style="color:#3333FF;">1.添加各个图片按钮的引用，</p><p><pre>android.widget.LinearLayout keysLayout;</p><p>android.widget.ImageView btnHome;</p><p>android.widget.ImageView btnBack;</p><p>android.widget.ImageView btnMenu;</p><p>android.widget.ImageView btnVolUp;</p><p>android.widget.ImageView btnVolDown;</p><p></pre></p><p style="color:#3333FF;">2.修改onFinishInflate()函数，各个图片ID在上面的status_bar.xml中已经定义</p><p><pre>@Override</p><p><font class="keyword">protected </font><font class="keyword">void </font>onFinishInflate() {</p><p>	/* Begin : Added by TigerPan */</p><p>	keysLayout = (android.widget.LinearLayout) findViewById(R.id.keys);</p><p>	btnHome = (android.widget.ImageView) findViewById(R.id.status_home);</p><p>	btnBack = (android.widget.ImageView) findViewById(R.id.status_back);</p><p>	btnMenu = (android.widget.ImageView) findViewById(R.id.status_menu);</p><p>	btnVolUp = (android.widget.ImageView) findViewById(R.id.status_vol_up);</p><p>	btnVolDown = (android.widget.ImageView) findViewById(R.id.status_vol_down);</p><p>	btnHome.setOnClickListener(mKeysListener);</p><p>	btnBack.setOnClickListener(mKeysListener);</p><p>	btnMenu.setOnClickListener(mKeysListener);</p><p>	btnVolUp.setOnClickListener(mKeysListener);</p><p>	btnVolDown.setOnClickListener(mKeysListener);</p><p>}</p><p></pre></p><p style="color:#3333FF;">3.添加各个按钮的事件监听Listener</p><p><pre>android.view.View.OnClickListener mKeysListener = <font class="keyword">new </font>android.view.View.OnClickListener() {</p><p>	<font class="keyword">public </font><font class="keyword">void </font>onClick(View v) {</p><p>		<font class="keyword">switch </font>(v.getId()) {</p><p>		<font class="keyword">case </font>R.id.status_home:</p><p>			mKeysHandler.sendEmptyMessage(KEY_HOME);</p><p>			<font class="keyword">break</font>;</p><p>		<font class="keyword">case </font>R.id.status_back:</p><p>			mKeysHandler.sendEmptyMessage(KEY_BACK);</p><p>			<font class="keyword">break</font>;</p><p>		<font class="keyword">case </font>R.id.status_menu:</p><p>			mKeysHandler.sendEmptyMessage(KEY_MENU);</p><p>			<font class="keyword">break</font>;</p><p>		<font class="keyword">case </font>R.id.status_vol_up:</p><p>			mKeysHandler.sendEmptyMessage(KEY_VOL_UP);</p><p>			<font class="keyword">break</font>;</p><p>		<font class="keyword">case </font>R.id.status_vol_down:</p><p>			mKeysHandler.sendEmptyMessage(KEY_VOL_DOWN);</p><p>			<font class="keyword">break</font>;</p><p>		<font class="keyword">default</font>:</p><p>			<font class="keyword">break</font>;</p><p>		}</p><p>	}</p><p>};</p><p></pre></p><p style="color:#3333FF;">4.添加模拟按键处理</p><p><pre><font class="keyword">private </font><font class="keyword">static </font><font class="keyword">final </font><font class="keyword">int </font>KEY_HOME = 1000;</p><p><font class="keyword">private </font><font class="keyword">static </font><font class="keyword">final </font><font class="keyword">int </font>KEY_BACK = 1001;</p><p><font class="keyword">private </font><font class="keyword">static </font><font class="keyword">final </font><font class="keyword">int </font>KEY_MENU = 1002;</p><p><font class="keyword">private </font><font class="keyword">static </font><font class="keyword">final </font><font class="keyword">int </font>KEY_VOL_UP = 1003;</p><p><font class="keyword">private </font><font class="keyword">static </font><font class="keyword">final </font><font class="keyword">int </font>KEY_VOL_DOWN = 1004;</p><p><font class="keyword">private </font>Handler mKeysHandler = </font><font class="keyword">new </font>Handler() {</p><p>	<font class="keyword">public </font><font class="keyword">void </font>handleMessage(Message msg) {</p><p>		<font class="keyword">switch </font>(msg.what) {</p><p>		<font class="keyword">case </font>KEY_HOME:</p><p>			sendKey(KeyEvent.KEYCODE_HOME);</p><p>			<font class="keyword">break</font>;</p><p>		<font class="keyword">case </font>KEY_BACK:</p><p>			sendKey(KeyEvent.KEYCODE_BACK);</p><p>			<font class="keyword">break</font>;</p><p>		<font class="keyword">case </font>KEY_MENU:</p><p>			sendKey(KeyEvent.KEYCODE_MENU);</p><p>			<font class="keyword">break</font>;</p><p>		<font class="keyword">case </font>KEY_VOL_UP:</p><p>			((android.media.AudioManager) mContext</p><p>					.getSystemService(Context.AUDIO_SERVICE)).adjustVolume(</p><p>					android.media.AudioManager.ADJUST_RAISE,</p><p>					android.media.AudioManager.STREAM_MUSIC);</p><p>			<font class="keyword">break</font>;</p><p>		<font class="keyword">case </font>KEY_VOL_DOWN:</p><p>			((android.media.AudioManager) mContext</p><p>					.getSystemService(Context.AUDIO_SERVICE)).adjustVolume(</p><p>					android.media.AudioManager.ADJUST_LOWER,</p><p>					android.media.AudioManager.STREAM_MUSIC);</p><p>			<font class="keyword">break</font>;</p><p>		<font class="keyword">default</font>:</p><p>			<font class="keyword">break</font>;</p><p>		}</p><p>	}</p><p>	<font class="keyword">private </font><font class="keyword">void </font>sendKey(</font><font class="keyword">int </font>keyCode) {</p><p>		<font class="keyword">long </font>now = SystemClock.uptimeMillis();</p><p>		<font class="keyword">long </font>n = System.currentTimeMillis();</p><p>		</font>Log.d(<font class="Fields">"Tiger"</font>, </font><font class="Fields">"Intent.ACTION_SOFT_"</font> + keyCode + </font><font class="Fields">"_PRESSED   0=</p><p>				+ n);</p><p>		<font class="keyword">try </font>{</p><p>			</font>KeyEvent down = <font class="keyword">new </font>KeyEvent(now, now, KeyEvent.ACTION_DOWN,</p><p>					keyCode, 0);</p><p>			</font>KeyEvent up = <font class="keyword">new </font>KeyEvent(now, now, KeyEvent.ACTION_UP,</p><p>					keyCode, 0);</p><p>			</font>Log.d(<font class="Fields">"Tiger"</font>, </font><font class="Fields">"Intent.ACTION_SOFT_"</font> + keyCode</p><p>					</font>+ <font class="Fields">"_PRESSED   1=</p><p>					+ (System.currentTimeMillis()/*-n*/));</p><p>			IWindowManager wm = IWindowManager.Stub</p><p>					</font>.asInterface(ServiceManager.getService(<font class="Fields">"window"</font>));</p><p>			</font>Log.d(<font class="Fields">"Tiger"</font>, </font><font class="Fields">"Intent.ACTION_SOFT_"</font> + keyCode</p><p>					</font>+ <font class="Fields">"_PRESSED   2=</p><p>					+ (System.currentTimeMillis()/*-n*/));</p><p>			</font>wm.injectKeyEvent(down, <font class="keyword">false</font>);</p><p>			</font>Log.d(<font class="Fields">"Tiger"</font>, </font><font class="Fields">"Intent.ACTION_SOFT_"</font> + keyCode</p><p>					</font>+ <font class="Fields">"_PRESSED   3=</p><p>					+ (System.currentTimeMillis()/*-n*/));</p><p>			</font>wm.injectKeyEvent(up, <font class="keyword">false</font>);</p><p>			</font>Log.d(<font class="Fields">"Tiger"</font>, </font><font class="Fields">"Intent.ACTION_SOFT_"</font> + keyCode</p><p>					</font>+ <font class="Fields">"_PRESSED   4=</p><p>					+ (System.currentTimeMillis()/*-n*/));</p><p>		</font>} <font class="keyword">catch </font>(RemoteException e) {</p><p>			</font>Log.i(<font class="Fields">"Input"</font>, </font><font class="Fields">"DeadOjbectException"</font>);</p><p>		}</p><p>	}</p><p>};</p><p></pre></p><p style="color:#3333FF;">5.避免在按下这几个按钮时，触发下拉Notification视图，影响性能</p><p>修改onInterceptTouchEvent(MotionEvent event)函数</p><p><pre>@Override</p><p><font class="keyword">public </font><font class="keyword">boolean </font>onInterceptTouchEvent(MotionEvent event) {</p><p>	<font class="keyword">if </font>(keysLayout.getRight() &lt; event.getX())</p><p>		<font class="keyword">return </font>mService.interceptTouchEvent(event) ? </font><font class="keyword">true</font> : </font><font class="keyword">super</font></p><p>				.onInterceptTouchEvent(event);</p><p>	/*</p><p>	 <font class="Comments">* int parentLeft = mStatusIcons.getLeft();</font></p><p>	 <font class="Comments">* android.util.Log.i("Tiger","....."+(event.getX() &lt; (parentLeft +</font></p><p>	 <font class="Comments">* iconVolDown.getLeft()) || event.getX() &gt; (parentLeft +</font></p><p>	 <font class="Comments">* iconHome.getRight()))); if(event.getX() &lt; (parentLeft +</font></p><p>	 <font class="Comments">* iconVolDown.getLeft()) || event.getX() &gt; (parentLeft +</font></p><p>	 <font class="Comments">* iconHome.getRight())) return mService.interceptTouchEvent(event) ?</font></p><p>	 <font class="Comments">* true : super.onInterceptTouchEvent(event);</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">return </font><font class="keyword">false</font>;</p><p>}</p><p></pre></p><p>这样，基本上就完成了。</p><p>编译一下</p><p><pre>~/donut$ source ./env.sh   </p><p>~/donut$ make update-api   </p><p>~/donut$ make –j8   </p><p>~/donut$ emulator –skin WVGA800 </p><p>~/donut$ source ./env.sh</p><p>~/donut$ make update-api</p><p>~/donut$ make –j8</p><p>~/donut$ emulator –skin WVGA800</p><p></pre></p><p></p></div>

</DIV></DIV>

<DIV id=footer style="display:none">
<P align="center">  
 
 
 
    </P>
</DIV></BODY></HTML>

