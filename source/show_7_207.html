
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML xmlns="http://www.w3.org/1999/xhtml">
<HEAD>
<TITLE>提取Launcher中的WorkSapce，可以左右滑动切换屏幕页面的类_Android学习手册</TITLE>
<META content="text/html; charset=gb2312" http-equiv=Content-Type><LINK  rel=stylesheet type=text/css href="../css/c5.css">
<META name=GENERATOR content="MSHTML 8.00.6001.18702">
<meta name="Description" content=Android基础 Android组件 Android用户界面 Android设备功能 Android数据存储 Android网络应用 Android游戏开发 Android多媒体 Android源码开发 Android高级进阶 Android面试题/>
<meta name="Keywords" content="android 学习手册">

</HEAD>
<BODY id=homesecond class=serverscripting>
<DIV id=wrapper>
<DIV id=header><h1><a href="../index.html">Android学习手册</a></h1> 
</DIV>

<DIV id=navfirst>
<div id="indexGuide"><UL><li ><A href="../basic/index.html">Android基础</A> </li><li ><A href="../component/index.html">Android组件</A> </li><li ><A href="../userinterface/index.html">用户界面</A> </li><li ><A href="../device/index.html">设备功能</A> </li><li ><A href="../datastorage/index.html">数据存储</A> </li><li ><A href="../network/index.html">网络应用</A> </li><li ><A href="../game/index.html">游戏开发</A> </li><li ><A href="../multimedia/index.html">多媒体</A> </li><li class="navcurrentLink"><A href="index.html">源码开发</A> </li><li ><A href="../advance/index.html">高级进阶</A> </li><li ><A href="../interview/index.html">Android面试题</A> </li></UL></div>
</DIV>
<DIV id=navsecond>
<DIV id=course>
<div id="kcTitle">课 程 表</div>


  <h2><A title="Launcher" href="index_207.html">Launcher</A></h2>
<UL><li ><A title=Android Launcher 分析（一） href="show_1_207.html">Android Launcher 分析（一）</A> </li><li ><A title=Android Launcher 分析（二） href="show_2_207.html">Android Launcher 分析（二）</A> </li><li ><A title=Android Launcher 分析（三） href="show_3_207.html">Android Launcher 分析（三）</A> </li><li ><A title=Android 启动唯一的Launcher href="show_4_207.html">Android 启动唯一的Launcher</A> </li><li ><A title=Launcher之文件夹美化 href="show_5_207.html">Launcher之文件夹美化</A> </li><li ><A title=关于使用Eclipse调试Launcher的完美解决方法 href="show_6_207.html">关于使用Eclipse调试Launcher的完美解决方法</A> </li><li class="currentLink"><A title=提取Launcher中的WorkSapce，可以左右滑动切换屏幕页面的类 href="show_7_207.html">提取Launcher中的WorkSapce，可以左右滑动切换屏幕页面的类</A> </li><li ><A title=使用ViewPager实现高仿launcher拖动效果 href="show_8_207.html">使用ViewPager实现高仿launcher拖动效果</A> </li><li ><A title=Android 深入研究拖放功能Launcher（一） href="show_9_207.html">Android 深入研究拖放功能Launcher（一）</A> </li><li ><A title=Android 深入研究拖放功能Launcher（二） href="show_10_207.html">Android 深入研究拖放功能Launcher（二）</A> </li><li ><A title=Android 深入研究拖放功能Launcher（三） href="show_11_207.html">Android 深入研究拖放功能Launcher（三）</A> </li><li ><A title=Android 深入研究拖放功能Launcher（四） href="show_12_207.html">Android 深入研究拖放功能Launcher（四）</A> </li><li ><A title=Android 深入研究拖放功能Launcher（五） href="show_13_207.html">Android 深入研究拖放功能Launcher（五）</A> </li><li ><A title=Android 深入研究拖放功能Launcher（六） href="show_14_207.html">Android 深入研究拖放功能Launcher（六）</A> </li><li ><A title=Android 在launcher 2.1上实现2.2的屏幕标记 href="show_15_207.html">Android 在launcher 2.1上实现2.2的屏幕标记</A> </li></UL>
  <h2><A title="电话系统RIL" href="index_208.html">电话系统RIL</A></h2>

  <h2><A title="进程间通信" href="index_209.html">进程间通信</A></h2>

  <h2><A title="内部sensor系统" href="index_210.html">内部sensor系统</A></h2>

  <h2><A title="内部surface系统" href="index_211.html">内部surface系统</A></h2>

  <h2><A title="启动流程" href="index_212.html">启动流程</A></h2>

  <h2><A title="源码编译" href="index_213.html">源码编译</A></h2>

  <h2><A title="状态栏" href="index_214.html">状态栏</A></h2>

</DIV></DIV>
<DIV id=maincontent>
<DIV id=w3school>
<H1></H1>
<P><STRONG></STRONG></P></DIV>

<DIV>
<H2>提取Launcher中的WorkSapce，可以左右滑动切换屏幕页面的类</H2>
<div style="line-height:20px; font-size:14px;"><p>提取Launcher中的WorkSapce，可以左右滑动切换屏幕页面的类</p><p style="color:#3333FF;">下载源码</p><p>对于Launcher的桌面滑动大家应该都比较熟悉了，最好的体验应该是可以随着手指的滑动而显示不同位置的桌面。</p><p>比一般用ViewFlinger+动画所实现的手势切换页面感觉良好多了~~~~</p><p>分析了一下Launcher中的WorkSpace，里面有太多的代码我们用不上了（拖拽，长按），把里面的冗余代码去掉得到实现滑动切换屏幕所必需的。</p><p>新建一个ScrollLayout类，继承自ViewGroup。</p><p style="color:#3333FF;">重写onMeasure和onLayout两个方法：</p><p>其中onMeasure方法中，得到ScrollLayout的布局方式（一般使用FILL_PARENT），然后再枚举其中所有的子view，设置它们的布局（FILL_PARENT），这样在ScrollLayout之中的每一个子view即为充满屏幕可以滑动显示的其中一页。</p><p>在onLayout方法中，横向画出每一个子view，这样所得到的view的高与屏幕高一致，宽度为getChildCount()-1个屏幕宽度的view。</p><p>添加一个Scroller来平滑过渡各个页面之间的切换，重写onInterceptTouchEvent和onTouchEvent来响应手指按下划动时所需要捕获的消息，例如划动的速度，划动的距离等。再配合使用scrollBy (int x, int y)方法得到慢速滑动小距离的时候，所需要显示的内容。最后当手指起来时，根据划动的速度与跨度来判断是向左滑动一页还是向右滑动一页，确保每次用户操作结束之后显示的都是整体的一个子view。</p><p>ScrollLayout源码：</p><p><pre><font class="keyword">import </font>android.graphics.Canvas;</p><p><font class="keyword">import </font>android.util.AttributeSet;</p><p><font class="keyword">import </font>android.util.Log;</p><p><font class="keyword">import </font>android.view.MotionEvent;</p><p><font class="keyword">import </font>android.view.VelocityTracker;</p><p><font class="keyword">import </font>android.view.View;</p><p><font class="keyword">import </font>android.view.ViewConfiguration;</p><p><font class="keyword">import </font>android.view.ViewGroup;</p><p><font class="keyword">import </font>android.widget.Scroller;</p><p><font class="Comments">/**</font></p><p> <font class="Comments">* <font class="Comments">* 仿Launcher中的WorkSapce，可以左右滑动切换屏幕的类 <font class="Comments">*</font></p><p> <font class="Comments">*/</font></p><p><font class="keyword">public </font><font class="keyword">class </font>ScrollLayout </font><font class="keyword">extends </font>ViewGroup {</p><p>	<font class="keyword">private </font><font class="keyword">static </font><font class="keyword">final </font>String TAG = <font class="Fields">"ScrollLayout"</font>;</p><p>	<font class="keyword">private </font>Scroller mScroller;</p><p>	<font class="keyword">private </font>VelocityTracker mVelocityTracker;</p><p>	<font class="keyword">private </font><font class="keyword">int </font>mCurScreen;</p><p>	<font class="keyword">private </font><font class="keyword">int </font>mDefaultScreen = 0;</p><p>	<font class="keyword">private </font><font class="keyword">static </font><font class="keyword">final </font><font class="keyword">int </font>TOUCH_STATE_REST = 0;</p><p>	<font class="keyword">private </font><font class="keyword">static </font><font class="keyword">final </font><font class="keyword">int </font>TOUCH_STATE_SCROLLING = 1;</p><p>	<font class="keyword">private </font><font class="keyword">static </font><font class="keyword">final </font><font class="keyword">int </font>SNAP_VELOCITY = 600;</p><p>	<font class="keyword">private </font><font class="keyword">int </font>mTouchState = TOUCH_STATE_REST;</p><p>	<font class="keyword">private </font><font class="keyword">int </font>mTouchSlop;</p><p>	<font class="keyword">private </font><font class="keyword">float </font>mLastMotionX;</p><p>	<font class="keyword">private </font><font class="keyword">float </font>mLastMotionY;</p><p>	<font class="keyword">public </font>ScrollLayout(Context context, AttributeSet attrs) {</p><p>		<font class="keyword">this</font>(context, attrs, 0);</p><p>	}</p><p>	<font class="keyword">public </font>ScrollLayout(Context context, AttributeSet attrs, </font><font class="keyword">int </font>defStyle) {</p><p>		<font class="keyword">super</font>(context, attrs, defStyle);</p><p>		</font>mScroller = <font class="keyword">new </font>Scroller(context);</p><p>		mCurScreen = mDefaultScreen;</p><p>		mTouchSlop = ViewConfiguration.get(getContext()).getScaledTouchSlop();</p><p>	}</p><p>	@Override</p><p>	<font class="keyword">protected </font><font class="keyword">void </font>onLayout(</font><font class="keyword">boolean </font>changed, </font><font class="keyword">int </font>l, </font><font class="keyword">int </font>t, </font><font class="keyword">int </font>r, </font><font class="keyword">int </font>b) {</p><p>		<font class="keyword">if </font>(changed) {</p><p>			<font class="keyword">int </font>childLeft = 0;</p><p>			<font class="keyword">final </font><font class="keyword">int </font>childCount = getChildCount();</p><p>			<font class="keyword">for </font>(</font><font class="keyword">int </font>i = 0; i &lt; childCount; i++) {</p><p>				<font class="keyword">final </font>View childView = getChildAt(i);</p><p>				<font class="keyword">if </font>(childView.getVisibility() != View.GONE) {</p><p>					<font class="keyword">final </font><font class="keyword">int </font>childWidth = childView.getMeasuredWidth();</p><p>					childView.layout(childLeft, 0, childLeft + childWidth,</p><p>							childView.getMeasuredHeight());</p><p>					childLeft += childWidth;</p><p>				}</p><p>			}</p><p>		}</p><p>	}</p><p>	@Override</p><p>	<font class="keyword">protected </font><font class="keyword">void </font>onMeasure(</font><font class="keyword">int </font>widthMeasureSpec, </font><font class="keyword">int </font>heightMeasureSpec) {</p><p>		</font>Log.e(TAG, <font class="Fields">"onMeasure"</font>);</p><p>		<font class="keyword">super</font>.onMeasure(widthMeasureSpec, heightMeasureSpec);</p><p>		<font class="keyword">final </font><font class="keyword">int </font>width = MeasureSpec.getSize(widthMeasureSpec);</p><p>		<font class="keyword">final </font><font class="keyword">int </font>widthMode = MeasureSpec.getMode(widthMeasureSpec);</p><p>		<font class="keyword">if </font>(widthMode != MeasureSpec.EXACTLY) {</p><p>			<font class="keyword">throw </font><font class="keyword">new </font>IllegalStateException(</p><p>					<font class="Fields">"ScrollLayout only canmCurScreen run at EXACTLY mode!"</font>);</p><p>		}</p><p>		<font class="keyword">final </font><font class="keyword">int </font>heightMode = MeasureSpec.getMode(heightMeasureSpec);</p><p>		<font class="keyword">if </font>(heightMode != MeasureSpec.EXACTLY) {</p><p>			<font class="keyword">throw </font><font class="keyword">new </font>IllegalStateException(</p><p>					<font class="Fields">"ScrollLayout only can run at EXACTLY mode!"</font>);</p><p>		}</p><p>		<font class="Comments">// The children are given the same width and height as the scrollLayout</font></p><p>		<font class="keyword">final </font><font class="keyword">int </font>count = getChildCount();</p><p>		<font class="keyword">for </font>(</font><font class="keyword">int </font>i = 0; i &lt; count; i++) {</p><p>			getChildAt(i).measure(widthMeasureSpec, heightMeasureSpec);</p><p>		}</p><p>		<font class="Comments">// Log.e(TAG, "moving to screen "+mCurScreen);</font></p><p>		scrollTo(mCurScreen * width, 0);</p><p>	}</p><p>	<font class="Comments">/**</font></p><p>	 <font class="Comments">* <font class="Comments">* According to the position of current layout <font class="Comments">* scroll to the destination page.</font></p><p>	 <font class="Comments">*/</font></p><p>	<font class="keyword">public </font><font class="keyword">void </font>snapToDestination() {</p><p>		<font class="keyword">final </font><font class="keyword">int </font>screenWidth = getWidth();</p><p>		<font class="keyword">final </font><font class="keyword">int </font>destScreen = (getScrollX() + screenWidth / 2) / screenWidth;</p><p>		snapToScreen(destScreen);</p><p>	}</p><p>	<font class="keyword">public </font><font class="keyword">void </font>snapToScreen(</font><font class="keyword">int </font>whichScreen) {</p><p>		<font class="Comments">// get the valid layout page</font></p><p>		whichScreen = Math.max(0, Math.min(whichScreen, getChildCount() - 1));</p><p>		<font class="keyword">if </font>(getScrollX() != (whichScreen * getWidth())) {</p><p>			<font class="keyword">final </font><font class="keyword">int </font>delta = whichScreen * getWidth() - getScrollX();</p><p>			mScroller.startScroll(getScrollX(), 0, delta, 0,</p><p>					Math.abs(delta) * 2);</p><p>			mCurScreen = whichScreen;</p><p>			invalidate();</p><p>			<font class="Comments">// Redraw the layout</font></p><p>		}</p><p>	}</p><p>	<font class="keyword">public </font><font class="keyword">void </font>setToScreen(</font><font class="keyword">int </font>whichScreen) {</p><p>		whichScreen = Math.max(0, Math.min(whichScreen, getChildCount() - 1));</p><p>		mCurScreen = whichScreen;</p><p>		scrollTo(whichScreen * getWidth(), 0);</p><p>	}</p><p>	<font class="keyword">public </font><font class="keyword">int </font>getCurScreen() {</p><p>		<font class="keyword">return </font>mCurScreen;</p><p>	}</p><p>	@Override</p><p>	<font class="keyword">public </font><font class="keyword">void </font>computeScroll() {</p><p>		<font class="keyword">if </font>(mScroller.computeScrollOffset()) {</p><p>			scrollTo(mScroller.getCurrX(), mScroller.getCurrY());</p><p>			postInvalidate();</p><p>		}</p><p>	}</p><p>	@Override</p><p>	<font class="keyword">public </font><font class="keyword">boolean </font>onTouchEvent(MotionEvent event) {</p><p>		<font class="keyword">if </font>(mVelocityTracker == </font><font class="keyword">null</font>) {</p><p>			mVelocityTracker = VelocityTracker.obtain();</p><p>		}</p><p>		mVelocityTracker.addMovement(event);</p><p>		<font class="keyword">final </font><font class="keyword">int </font>action = event.getAction();</p><p>		<font class="keyword">final </font><font class="keyword">float </font>x = event.getX();</p><p>		<font class="keyword">final </font><font class="keyword">float </font>y = event.getY();</p><p>		<font class="keyword">switch </font>(action) {</p><p>		<font class="keyword">case </font>MotionEvent.ACTION_DOWN:</p><p>			</font>Log.e(TAG, <font class="Fields">"event down!"</font>);</p><p>			<font class="keyword">if </font>(!mScroller.isFinished()) {</p><p>				mScroller.abortAnimation();</p><p>			}</p><p>			mLastMotionX = x;</p><p>			<font class="keyword">break</font>;</p><p>		<font class="keyword">case </font>MotionEvent.ACTION_MOVE:</p><p>			<font class="keyword">int </font>deltaX = (</font><font class="keyword">int</font>) (mLastMotionX - x);</p><p>			mLastMotionX = x;</p><p>			scrollBy(deltaX, 0);</p><p>			<font class="keyword">break</font>;</p><p>		<font class="keyword">case </font>MotionEvent.ACTION_UP:</p><p>			</font>Log.e(TAG, <font class="Fields">"event : up"</font>);</p><p>			<font class="Comments">//</font></p><p>			<font class="keyword">if </font>(mTouchState == TOUCH_STATE_SCROLLING) {</p><p>				<font class="keyword">final </font>VelocityTracker velocityTracker = mVelocityTracker;</p><p>				velocityTracker.computeCurrentVelocity(1000);</p><p>				<font class="keyword">int </font>velocityX = (</font><font class="keyword">int</font>) velocityTracker.getXVelocity();</p><p>				</font>Log.e(TAG, <font class="Fields">"velocityX:"</font> + velocityX);</p><p>				<font class="keyword">if </font>(velocityX &gt; SNAP_VELOCITY && mCurScreen &gt; 0) {</p><p>					<font class="Comments">// Fling enough to move left</font></p><p>				}</p><p>			</font>} <font class="keyword">else </font><font class="keyword">if </font>(velocityX &lt; -SNAP_VELOCITY</p><p>					&& mCurScreen &lt; getChildCount() - 1) {</p><p>				<font class="Comments">// Fling enough to move right</font></p><p>				</font>Log.e(TAG, <font class="Fields">"snap right"</font>);</p><p>				snapToScreen(mCurScreen + 1);</p><p>			</font>} <font class="keyword">else </font>{</p><p>				snapToDestination();</p><p>			}</p><p>			<font class="keyword">if </font>(mVelocityTracker != </font><font class="keyword">null</font>) {</p><p>				mVelocityTracker.recycle();</p><p>				</font>mVelocityTracker = <font class="keyword">null</font>;</p><p>			}</p><p>			mTouchState = TOUCH_STATE_REST;</p><p>			<font class="keyword">break</font>;</p><p>		<font class="keyword">case </font>MotionEvent.ACTION_CANCEL:</p><p>			mTouchState = TOUCH_STATE_REST;</p><p>			<font class="keyword">break</font>;</p><p>			<font class="keyword">return </font><font class="keyword">true</font>;</p><p>		}</p><p>	}</p><p>	@Override</p><p>	<font class="keyword">public </font><font class="keyword">boolean </font>onInterceptTouchEvent(MotionEvent ev) {</p><p>		</font>Log.e(TAG, <font class="Fields">"onInterceptTouchEvent-slop:"</font> + mTouchSlop);</p><p>		<font class="keyword">final </font><font class="keyword">int </font>action = ev.getAction();</p><p>		<font class="keyword">if </font>((action == MotionEvent.ACTION_MOVE)</p><p>				&& (mTouchState != TOUCH_STATE_REST)) {</p><p>			<font class="keyword">return </font><font class="keyword">true</font>;</p><p>		}</p><p>		<font class="keyword">final </font><font class="keyword">float </font>x = ev.getX();</p><p>		<font class="keyword">final </font><font class="keyword">float </font>y = ev.getY();</p><p>		<font class="keyword">switch </font>(action) {</p><p>		<font class="keyword">case </font>MotionEvent.ACTION_MOVE:</p><p>			<font class="keyword">final </font><font class="keyword">int </font>xDiff = (</font><font class="keyword">int</font>) Math.abs(mLastMotionX - x);</p><p>			<font class="keyword">if </font>(xDiff &gt; mTouchSlop) {</p><p>				mTouchState = TOUCH_STATE_SCROLLING;</p><p>			}</p><p>			<font class="keyword">break</font>;</p><p>		<font class="keyword">case </font>MotionEvent.ACTION_DOWN:</p><p>			mLastMotionX = x;</p><p>			mLastMotionY = y;</p><p>			mTouchState = mScroller.isFinished() ? TOUCH_STATE_REST</p><p>					: TOUCH_STATE_SCROLLING;</p><p>			<font class="keyword">break</font>;</p><p>		<font class="keyword">case </font>MotionEvent.ACTION_CANCEL:</p><p>		<font class="keyword">case </font>MotionEvent.ACTION_UP:</p><p>			mTouchState = TOUCH_STATE_REST;</p><p>			<font class="keyword">break</font>;</p><p>		}</p><p>		<font class="keyword">return </font>mTouchState != TOUCH_STATE_REST;</p><p>	}</p><p>}</p><p></pre></p><p>测试程序布局：</p><p><pre>&lt;?xml version=<font class="Fields">"1.0"</font> encoding=</font><font class="Fields">"utf-8"</font>?&gt;</p><p>&lt;com.yao_guet.test.ScrollLayout xmlns:android=<font class="Fields">"http:<font class="Comments">//schemas.android.com/apk/res/android</font></p><p>    </font>android:id=<font class="Fields">"@+id/ScrollLayoutTest</p><p>    </font>android:layout_width=<font class="Fields">"fill_parent</p><p>    </font>android:layout_height=<font class="Fields">"fill_parent"</font> &gt;</p><p>    &lt;LinearLayout</p><p>        </font>android:layout_width=<font class="Fields">"fill_parent</p><p>        </font>android:layout_height=<font class="Fields">"fill_parent</p><p>        </font>android:background=<font class="Fields">"</font>FF00"</font> &gt;</p><p>    &lt;/LinearLayout&gt;</p><p>    &lt;FrameLayout</p><p>        </font>android:layout_width=<font class="Fields">"fill_parent</p><p>        </font>android:layout_height=<font class="Fields">"fill_parent</p><p>        </font>android:background=<font class="Fields">"</font>F0F0"</font> &gt;</p><p>    &lt;/FrameLayout&gt;</p><p>    &lt;FrameLayout</p><p>        </font>android:layout_width=<font class="Fields">"fill_parent</p><p>        </font>android:layout_height=<font class="Fields">"fill_parent</p><p>        </font>android:background=<font class="Fields">"</font>F00F"</font> &gt;</p><p>    &lt;/FrameLayout&gt;</p><p>    &lt;LinearLayout</p><p>        </font>android:layout_width=<font class="Fields">"fill_parent</p><p>        </font>android:layout_height=<font class="Fields">"fill_parent</p><p>        </font>android:background=<font class="Fields">"</font>FF00"</font> &gt;</p><p>        &lt;Button</p><p>            </font>android:layout_width=<font class="Fields">"wrap_content</p><p>            </font>android:layout_height=<font class="Fields">"wrap_content</p><p>            </font>android:text=<font class="Fields">"Button1"</font> /&gt;</p><p>    &lt;/LinearLayout&gt;</p><p>    &lt;LinearLayout</p><p>        </font>android:layout_width=<font class="Fields">"wrap_content</p><p>        </font>android:layout_height=<font class="Fields">"wrap_content"</font> &gt;</p><p>        &lt;Button</p><p>            </font>android:layout_width=<font class="Fields">"wrap_content</p><p>            </font>android:layout_height=<font class="Fields">"wrap_content</p><p>            </font>android:text=<font class="Fields">"Button2"</font> /&gt;</p><p>    &lt;/LinearLayout&gt;</p><p>&lt;/com.yao_guet.test.ScrollLayout&gt;</p><p></pre></p><p></p></div>

</DIV></DIV>

<DIV id=footer style="display:none">
<P align="center">  
 
 
 
    </P>
</DIV></BODY></HTML>

